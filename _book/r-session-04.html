<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Callum Arnold">
<meta name="author" content="Matthew Ferrari">
<title>11&nbsp; R Session 04 – SISMID Module 2 Materials (2025)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./references.html" rel="next">
<link href="./L08_stochastic-models.html" rel="prev">
<link href="././images/sismid2025-logo-blue.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-2fef5ea3f8957b3e4ecc936fc74692ca.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-71f524eee1dc5ed9e55699206ad9d6f5.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark-4c0fb4a9f49e9c425cadb25d7a35c2be.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="site_libs/bootstrap/bootstrap-71f524eee1dc5ed9e55699206ad9d6f5.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/quarto-contrib/line-highlight-1.0.0/line-highlight.css" rel="stylesheet"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "?",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "[s|?] Search Contents",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-EVYBCCRZHE"></script><script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-EVYBCCRZHE', { 'anonymize_ip': true});
</script><script>
  window.MathJax = {
    loader: {
      load: ['[tex]/physics']
    },
    tex: {
      packages: {'[+]': ['physics']}
    }
  };
</script><script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
</head>
<body class="nav-sidebar floating quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./L08_stochastic-models.html">Day 3</a></li><li class="breadcrumb-item"><a href="./r-session-04.html"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">R Session 04</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="./index.html" class="sidebar-logo-link">
      <img src="././images/sismid2025-logo-blue.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none"></a>
    <div class="sidebar-title mb-0 py-0">
      <a href="./">SISMID Module 2 Materials (2025)</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://github.com/arnold-c/SISMID-Module-02_2025" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><strong>Welcome</strong></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./schedule.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Workshop Schedule</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Pre-Requisites</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./exercise-requirements.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Exercise Requirements</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./install-r.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Install and Setup R &amp; RStudio</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./just-enough-rstudio.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Just Enough RStudio</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./just-enough-r.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Just Enough R</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./project-management.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Organizing A Project</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Day 1</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./L01_intro-to-modeling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Intro to Modeling</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./L02_sir-basics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Basics of SIR Models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./r-session-01.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">R Session 01</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./L03_hit-and-vaccinations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Herd Immunity &amp; Vaccination</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Day 2</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./L04_heterogeneity.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Heterogeneity in Models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./L05_age-structure.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Age Structured Models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./r-session-02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">R Session 02</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./L06_parameter-estimation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Parameter Estimation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./r-session-03.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">R Session 03</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Day 3</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./L08_stochastic-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Stochastic Models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./r-session-04.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">R Session 04</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><strong>References</strong></span></a>
  </div>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Page Items</h2>
   
  <ul>
<li><a href="#setup" id="toc-setup" class="nav-link active" data-scroll-target="#setup"><span class="header-section-number">11.1</span> Setup</a></li>
  <li><a href="#what-is-stochasticity-and-where-does-it-come-from" id="toc-what-is-stochasticity-and-where-does-it-come-from" class="nav-link" data-scroll-target="#what-is-stochasticity-and-where-does-it-come-from"><span class="header-section-number">11.2</span> What is stochasticity and where does it come from?</a></li>
  <li><a href="#the-gillespie-algorithm" id="toc-the-gillespie-algorithm" class="nav-link" data-scroll-target="#the-gillespie-algorithm"><span class="header-section-number">11.3</span> The Gillespie Algorithm</a></li>
  <li><a href="#the-tau-leaping-algorithm" id="toc-the-tau-leaping-algorithm" class="nav-link" data-scroll-target="#the-tau-leaping-algorithm"><span class="header-section-number">11.4</span> The Tau Leaping Algorithm</a></li>
  <li><a href="#the-chain-binomial-algorithm" id="toc-the-chain-binomial-algorithm" class="nav-link" data-scroll-target="#the-chain-binomial-algorithm"><span class="header-section-number">11.5</span> The Chain Binomial Algorithm</a></li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/arnold-c/SISMID-Module-02_2025/edit/main/r-session-04.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./L08_stochastic-models.html">Day 3</a></li><li class="breadcrumb-item"><a href="./r-session-04.html"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">R Session 04</span></a></li></ol></nav><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">
<span class="chapter-number">11</span>&nbsp; <span class="chapter-title">R Session 04</span>
</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
<p class="subtitle lead">Stochastic SIR models</p>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Authors</div>
  <div class="quarto-title-meta-heading">Affiliations</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author"><a href="https://callumarnold.com">Callum Arnold</a> <a href="https://orcid.org/0000-0002-3245-6956" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Pennsylvania State University
          </p>
      </div>
    <div class="quarto-title-meta-contents">
    <p class="author"><a href="http://theferrarilab.com">Matthew Ferrari</a> <a href="https://orcid.org/0000-0001-5251-8168" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            The Pennsylvania State University
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
  
    
  </div>
  
<div>
  <div class="abstract">
    <div class="block-title"></div>
    <p><em>review of basic algorithms for stochastic epidemic models</em></p>
  </div>
</div>


</header><div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>This session is under active development and is subject to change.</p>
</div>
</div>
<section id="setup" class="level2" data-number="11.1"><h2 data-number="11.1" class="anchored" data-anchor-id="setup">
<span class="header-section-number">11.1</span> Setup</h2>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb1" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">library</span>(here)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="fu">library</span>(rio)</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="fu">library</span>(deSolve)</span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb2" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_minimal</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>This R-session will go in parallel with the lecture on stochastic algorithms. First we’ll go through the basics of each algorithm in the lecture and then we’ll walk through the code and you can implement it for yourselves.</p>
</div>
</div>
</section><section id="what-is-stochasticity-and-where-does-it-come-from" class="level2 page-columns page-full" data-number="11.2"><h2 data-number="11.2" class="anchored" data-anchor-id="what-is-stochasticity-and-where-does-it-come-from">
<span class="header-section-number">11.2</span> What is stochasticity and where does it come from?</h2>
<p>Much of the world is uncertain (i.e.&nbsp;we don’t know exactly how things work, what values are, or what tomorrow will hold). Some of that uncertainty is, at least theoretically, knowable and some is not. For example, in our discussion of estimating <span class="math inline">\(R_0\)</span>, there may be a very real <span class="math inline">\(R_0\)</span> for a given population and pathogen, even if we don’t know it. Thus, our estimate of <span class="math inline">\(R_0\)</span> may be “uncertain” (e.g.&nbsp;has a confidence interval around it, reflecting our certainty), but the models we’ve been developing so far are “deterministic”, so conditional on a given value of <span class="math inline">\(R_0\)</span> the resulting epidemic curve is exactly specified by the model. If we return to the code from R-session 1, we can plot a single deterministic realization of a model with <span class="math inline">\(R_0 = 1.8\)</span>.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb3" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>sir_model <span class="ot">&lt;-</span> <span class="cf">function</span>(time, state, params, ...) {</span>
<span id="cb3-2"><a href="#cb3-2"></a>  transmission <span class="ot">&lt;-</span> params[<span class="st">"transmission"</span>]</span>
<span id="cb3-3"><a href="#cb3-3"></a>  recovery <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> params[<span class="st">"duration"</span>]</span>
<span id="cb3-4"><a href="#cb3-4"></a></span>
<span id="cb3-5"><a href="#cb3-5"></a>  S <span class="ot">&lt;-</span> state[<span class="st">"S"</span>]</span>
<span id="cb3-6"><a href="#cb3-6"></a>  I <span class="ot">&lt;-</span> state[<span class="st">"I"</span>]</span>
<span id="cb3-7"><a href="#cb3-7"></a>  R <span class="ot">&lt;-</span> state[<span class="st">"R"</span>]</span>
<span id="cb3-8"><a href="#cb3-8"></a></span>
<span id="cb3-9"><a href="#cb3-9"></a>  dSdt <span class="ot">&lt;-</span> <span class="sc">-</span>transmission <span class="sc">*</span> S <span class="sc">*</span> I</span>
<span id="cb3-10"><a href="#cb3-10"></a>  dIdt <span class="ot">&lt;-</span> (transmission <span class="sc">*</span> S <span class="sc">*</span> I) <span class="sc">-</span> (recovery <span class="sc">*</span> I)</span>
<span id="cb3-11"><a href="#cb3-11"></a>  dRdt <span class="ot">&lt;-</span> recovery <span class="sc">*</span> I</span>
<span id="cb3-12"><a href="#cb3-12"></a></span>
<span id="cb3-13"><a href="#cb3-13"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="fu">c</span>(dSdt, dIdt, dRdt)))</span>
<span id="cb3-14"><a href="#cb3-14"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb4" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>sir_params <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">transmission =</span> <span class="fl">0.3</span>, <span class="at">duration =</span> <span class="dv">6</span>)</span>
<span id="cb4-2"><a href="#cb4-2"></a>sir_init_states <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">S =</span> <span class="fl">0.99</span>, <span class="at">I =</span> <span class="fl">0.01</span>, <span class="at">R =</span> <span class="dv">0</span>)</span>
<span id="cb4-3"><a href="#cb4-3"></a>sim_times <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">200</span>, <span class="at">by =</span> <span class="fl">0.1</span>)</span>
<span id="cb4-4"><a href="#cb4-4"></a></span>
<span id="cb4-5"><a href="#cb4-5"></a>sir_sol <span class="ot">&lt;-</span> <span class="fu">ode</span>(</span>
<span id="cb4-6"><a href="#cb4-6"></a>  <span class="at">y =</span> sir_init_states,</span>
<span id="cb4-7"><a href="#cb4-7"></a>  <span class="at">times =</span> sim_times,</span>
<span id="cb4-8"><a href="#cb4-8"></a>  <span class="at">func =</span> sir_model,</span>
<span id="cb4-9"><a href="#cb4-9"></a>  <span class="at">parms =</span> sir_params</span>
<span id="cb4-10"><a href="#cb4-10"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell page-columns page-full">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb5" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="co"># Turn the output from the ODE solver into a tibble (dataframe)</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="co"># so we can manipulate and plot it easily</span></span>
<span id="cb5-3"><a href="#cb5-3"></a>sir_sol_df <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(sir_sol) <span class="sc">%&gt;%</span></span>
<span id="cb5-4"><a href="#cb5-4"></a>  <span class="co"># Convert all columns to numeric (they are currently type</span></span>
<span id="cb5-5"><a href="#cb5-5"></a>  <span class="co"># deSolve so will produce warnings when plotting etc)</span></span>
<span id="cb5-6"><a href="#cb5-6"></a>  <span class="fu">mutate</span>(</span>
<span id="cb5-7"><a href="#cb5-7"></a>    <span class="co"># Rather than repeatedly type the same function for every</span></span>
<span id="cb5-8"><a href="#cb5-8"></a>    <span class="co"># column, use the across() function to apply the function</span></span>
<span id="cb5-9"><a href="#cb5-9"></a>    <span class="co"># to a selection of columns</span></span>
<span id="cb5-10"><a href="#cb5-10"></a>    <span class="fu">across</span>(</span>
<span id="cb5-11"><a href="#cb5-11"></a>      <span class="co"># The cols argument takes a selection of columns to apply</span></span>
<span id="cb5-12"><a href="#cb5-12"></a>      <span class="co"># a function to. Here, we want to apply the as.numeric()</span></span>
<span id="cb5-13"><a href="#cb5-13"></a>      <span class="co"># function to all columns, so we use the function</span></span>
<span id="cb5-14"><a href="#cb5-14"></a>      <span class="co"># everything() to select all columns.</span></span>
<span id="cb5-15"><a href="#cb5-15"></a>      <span class="at">.cols =</span> <span class="fu">everything</span>(),</span>
<span id="cb5-16"><a href="#cb5-16"></a>      <span class="at">.fns =</span> as.numeric</span>
<span id="cb5-17"><a href="#cb5-17"></a>    )</span>
<span id="cb5-18"><a href="#cb5-18"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb5-19"><a href="#cb5-19"></a>  <span class="co"># Convert the dataframe from wide to long format, so we have a</span></span>
<span id="cb5-20"><a href="#cb5-20"></a>  <span class="co"># column for the time, a column for the state, and a column</span></span>
<span id="cb5-21"><a href="#cb5-21"></a>  <span class="co"># for the proportion of the population in that state at that</span></span>
<span id="cb5-22"><a href="#cb5-22"></a>  <span class="co"># time</span></span>
<span id="cb5-23"><a href="#cb5-23"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb5-24"><a href="#cb5-24"></a>    <span class="co"># Don't pivot the time column</span></span>
<span id="cb5-25"><a href="#cb5-25"></a>    <span class="at">cols =</span> <span class="sc">-</span>time,</span>
<span id="cb5-26"><a href="#cb5-26"></a>    <span class="at">names_to =</span> <span class="st">"state"</span>,</span>
<span id="cb5-27"><a href="#cb5-27"></a>    <span class="at">values_to =</span> <span class="st">"proportion"</span></span>
<span id="cb5-28"><a href="#cb5-28"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb5-29"><a href="#cb5-29"></a>  <span class="co"># Update the state column to be a factor, so the plot will</span></span>
<span id="cb5-30"><a href="#cb5-30"></a>  <span class="co"># show the states in the correct order</span></span>
<span id="cb5-31"><a href="#cb5-31"></a>  <span class="fu">mutate</span>(<span class="at">state =</span> <span class="fu">factor</span>(state, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"S"</span>, <span class="st">"I"</span>, <span class="st">"R"</span>)))</span>
<span id="cb5-32"><a href="#cb5-32"></a></span>
<span id="cb5-33"><a href="#cb5-33"></a>sir_colors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">S =</span> <span class="st">"#1f77b4"</span>, <span class="at">I =</span> <span class="st">"#ff7f0e"</span>, <span class="at">R =</span> <span class="st">"#FF3851"</span>)</span>
<span id="cb5-34"><a href="#cb5-34"></a></span>
<span id="cb5-35"><a href="#cb5-35"></a><span class="fu">ggplot</span>(sir_sol_df, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> proportion, <span class="at">color =</span> state)) <span class="sc">+</span></span>
<span id="cb5-36"><a href="#cb5-36"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb5-37"><a href="#cb5-37"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> sir_colors) <span class="sc">+</span></span>
<span id="cb5-38"><a href="#cb5-38"></a>  <span class="fu">labs</span>(</span>
<span id="cb5-39"><a href="#cb5-39"></a>    <span class="at">x =</span> <span class="st">"Time"</span>,</span>
<span id="cb5-40"><a href="#cb5-40"></a>    <span class="at">y =</span> <span class="st">"Fraction"</span>,</span>
<span id="cb5-41"><a href="#cb5-41"></a>    <span class="at">color =</span> <span class="st">"State"</span></span>
<span id="cb5-42"><a href="#cb5-42"></a>  ) <span class="sc">+</span></span>
<span id="cb5-43"><a href="#cb5-43"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="r-session-04_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img column-body" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Now, perhaps we used the tools from R-session 3 to estimate <span class="math inline">\(R_0\)</span> and we think a reasonable <span class="math inline">\(95\%\)</span> confidence interval for <span class="math inline">\(R_0\)</span> is <span class="math inline">\((1.7,1.9)\)</span>. If we’re quite certain the duration of infection is 6 days, then that means our corresponding confidence interval on the transmission rate is <span class="math inline">\((.283,.317)\)</span>. An entirely reasonable way to represent this uncertainty in the estimate of the transmission rate is to generate many random draws from within the confidence interval for the transmission rate and examine the resulting epidemic curves. For this we can modify the code above with a loop that does this multiple times.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb6" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="co"># the number of times we want to do this.</span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="co"># This is a matter of choice and computational capacity</span></span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="co"># (this model is small and quick, but that won't always be the case)</span></span>
<span id="cb6-4"><a href="#cb6-4"></a>num_iterations <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb6-5"><a href="#cb6-5"></a></span>
<span id="cb6-6"><a href="#cb6-6"></a><span class="co"># since we're going to do this num_iterations times we need a place</span></span>
<span id="cb6-7"><a href="#cb6-7"></a><span class="co"># to store the results</span></span>
<span id="cb6-8"><a href="#cb6-8"></a></span>
<span id="cb6-9"><a href="#cb6-9"></a><span class="cf">for</span> (iter <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>num_iterations) {</span>
<span id="cb6-10"><a href="#cb6-10"></a>  <span class="co"># each time take a random draw of the transmission rate from the</span></span>
<span id="cb6-11"><a href="#cb6-11"></a>  <span class="co"># confidence interval</span></span>
<span id="cb6-12"><a href="#cb6-12"></a>  sir_params <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">transmission =</span> <span class="fu">runif</span>(<span class="dv">1</span>, .<span class="dv">283</span>, .<span class="dv">317</span>), <span class="at">duration =</span> <span class="dv">6</span>)</span>
<span id="cb6-13"><a href="#cb6-13"></a>  sir_init_states <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">S =</span> <span class="fl">0.99</span>, <span class="at">I =</span> <span class="fl">0.01</span>, <span class="at">R =</span> <span class="dv">0</span>)</span>
<span id="cb6-14"><a href="#cb6-14"></a>  sim_times <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">200</span>, <span class="at">by =</span> <span class="fl">0.1</span>)</span>
<span id="cb6-15"><a href="#cb6-15"></a></span>
<span id="cb6-16"><a href="#cb6-16"></a>  sir_sol <span class="ot">&lt;-</span> <span class="fu">ode</span>(</span>
<span id="cb6-17"><a href="#cb6-17"></a>    <span class="at">y =</span> sir_init_states,</span>
<span id="cb6-18"><a href="#cb6-18"></a>    <span class="at">times =</span> sim_times,</span>
<span id="cb6-19"><a href="#cb6-19"></a>    <span class="at">func =</span> sir_model,</span>
<span id="cb6-20"><a href="#cb6-20"></a>    <span class="at">parms =</span> sir_params</span>
<span id="cb6-21"><a href="#cb6-21"></a>  )</span>
<span id="cb6-22"><a href="#cb6-22"></a>  sir_sol <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(sir_sol)</span>
<span id="cb6-23"><a href="#cb6-23"></a>  <span class="co"># mark this as the iter iteration of the loop</span></span>
<span id="cb6-24"><a href="#cb6-24"></a>  sir_sol<span class="sc">$</span>iteration <span class="ot">&lt;-</span> iter</span>
<span id="cb6-25"><a href="#cb6-25"></a>  <span class="co"># if this is the first iteration, create a place to store the output</span></span>
<span id="cb6-26"><a href="#cb6-26"></a>  <span class="co"># if it's the second or higher, append the output to the storage</span></span>
<span id="cb6-27"><a href="#cb6-27"></a>  <span class="cf">if</span> (iter <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb6-28"><a href="#cb6-28"></a>    sir_sol_storage <span class="ot">&lt;-</span> sir_sol</span>
<span id="cb6-29"><a href="#cb6-29"></a>  }</span>
<span id="cb6-30"><a href="#cb6-30"></a>  <span class="cf">if</span> (iter <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb6-31"><a href="#cb6-31"></a>    sir_sol_storage <span class="ot">&lt;-</span> <span class="fu">rbind</span>(sir_sol_storage, sir_sol)</span>
<span id="cb6-32"><a href="#cb6-32"></a>  }</span>
<span id="cb6-33"><a href="#cb6-33"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell page-columns page-full">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb7" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="co"># Turn the output from the ODE solver into a tibble (dataframe)</span></span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="co"># so we can manipulate and plot it easily</span></span>
<span id="cb7-3"><a href="#cb7-3"></a>sir_sol_df <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(sir_sol_storage) <span class="sc">%&gt;%</span></span>
<span id="cb7-4"><a href="#cb7-4"></a>  <span class="co"># Convert all columns to numeric (they are currently type deSolve</span></span>
<span id="cb7-5"><a href="#cb7-5"></a>  <span class="co"># so will produce warnings when plotting etc)</span></span>
<span id="cb7-6"><a href="#cb7-6"></a>  <span class="fu">mutate</span>(</span>
<span id="cb7-7"><a href="#cb7-7"></a>    <span class="co"># Rather than repeatedly type the same function for every column,</span></span>
<span id="cb7-8"><a href="#cb7-8"></a>    <span class="co"># use the across() function to apply the function to a selection</span></span>
<span id="cb7-9"><a href="#cb7-9"></a>    <span class="co"># of columns</span></span>
<span id="cb7-10"><a href="#cb7-10"></a>    <span class="fu">across</span>(</span>
<span id="cb7-11"><a href="#cb7-11"></a>      <span class="co"># The cols argument takes a selection of columns to apply</span></span>
<span id="cb7-12"><a href="#cb7-12"></a>      <span class="co"># a function to. Here, we want to apply the as.numeric()</span></span>
<span id="cb7-13"><a href="#cb7-13"></a>      <span class="co"># function to all columns, so we use the function</span></span>
<span id="cb7-14"><a href="#cb7-14"></a>      <span class="co"># everything() to select all columns.</span></span>
<span id="cb7-15"><a href="#cb7-15"></a>      <span class="at">.cols =</span> <span class="fu">everything</span>(),</span>
<span id="cb7-16"><a href="#cb7-16"></a>      <span class="at">.fns =</span> as.numeric</span>
<span id="cb7-17"><a href="#cb7-17"></a>    )</span>
<span id="cb7-18"><a href="#cb7-18"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb7-19"><a href="#cb7-19"></a>  <span class="co"># Convert the dataframe from wide to long format, so we have a</span></span>
<span id="cb7-20"><a href="#cb7-20"></a>  <span class="co"># column for the time, a column for the state, and a column</span></span>
<span id="cb7-21"><a href="#cb7-21"></a>  <span class="co"># for the proportion of the population in that state at that</span></span>
<span id="cb7-22"><a href="#cb7-22"></a>  <span class="co"># time</span></span>
<span id="cb7-23"><a href="#cb7-23"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb7-24"><a href="#cb7-24"></a>    <span class="co"># Don't pivot the time column</span></span>
<span id="cb7-25"><a href="#cb7-25"></a>    <span class="at">cols =</span> <span class="sc">-</span><span class="fu">c</span>(time, iteration),</span>
<span id="cb7-26"><a href="#cb7-26"></a>    <span class="at">names_to =</span> <span class="st">"state"</span>,</span>
<span id="cb7-27"><a href="#cb7-27"></a>    <span class="at">values_to =</span> <span class="st">"proportion"</span></span>
<span id="cb7-28"><a href="#cb7-28"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb7-29"><a href="#cb7-29"></a>  <span class="co"># Update the state column to be a factor, so the plot will</span></span>
<span id="cb7-30"><a href="#cb7-30"></a>  <span class="co"># show the states in the correct order</span></span>
<span id="cb7-31"><a href="#cb7-31"></a>  <span class="fu">mutate</span>(<span class="at">state =</span> <span class="fu">factor</span>(state, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"S"</span>, <span class="st">"I"</span>, <span class="st">"R"</span>)))</span>
<span id="cb7-32"><a href="#cb7-32"></a></span>
<span id="cb7-33"><a href="#cb7-33"></a>sir_colors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">S =</span> <span class="st">"#1f77b4"</span>, <span class="at">I =</span> <span class="st">"#ff7f0e"</span>, <span class="at">R =</span> <span class="st">"#FF3851"</span>)</span>
<span id="cb7-34"><a href="#cb7-34"></a></span>
<span id="cb7-35"><a href="#cb7-35"></a><span class="fu">ggplot</span>(</span>
<span id="cb7-36"><a href="#cb7-36"></a>  sir_sol_df,</span>
<span id="cb7-37"><a href="#cb7-37"></a>  <span class="fu">aes</span>(</span>
<span id="cb7-38"><a href="#cb7-38"></a>    <span class="at">x =</span> time,</span>
<span id="cb7-39"><a href="#cb7-39"></a>    <span class="at">y =</span> proportion,</span>
<span id="cb7-40"><a href="#cb7-40"></a>    <span class="at">color =</span> state,</span>
<span id="cb7-41"><a href="#cb7-41"></a>    <span class="at">group =</span> <span class="fu">interaction</span>(iteration, state)</span>
<span id="cb7-42"><a href="#cb7-42"></a>  )</span>
<span id="cb7-43"><a href="#cb7-43"></a>) <span class="sc">+</span></span>
<span id="cb7-44"><a href="#cb7-44"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.5</span>, <span class="at">alpha =</span> .<span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb7-45"><a href="#cb7-45"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> sir_colors) <span class="sc">+</span></span>
<span id="cb7-46"><a href="#cb7-46"></a>  <span class="fu">labs</span>(</span>
<span id="cb7-47"><a href="#cb7-47"></a>    <span class="at">x =</span> <span class="st">"Time"</span>,</span>
<span id="cb7-48"><a href="#cb7-48"></a>    <span class="at">y =</span> <span class="st">"Fraction"</span>,</span>
<span id="cb7-49"><a href="#cb7-49"></a>    <span class="at">color =</span> <span class="st">"State"</span></span>
<span id="cb7-50"><a href="#cb7-50"></a>  ) <span class="sc">+</span></span>
<span id="cb7-51"><a href="#cb7-51"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">alpha =</span> <span class="dv">1</span>))) <span class="sc">+</span></span>
<span id="cb7-52"><a href="#cb7-52"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="r-session-04_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img column-body" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Here note that we are still using our original code for the SIR model, so first we randomly draw the transmission rate, then conditional on that value, we run the deterministic model. Note that each run of the model still has the smooth curves, but each draw is a different set of smooth curves.</p>
<p>There are lots of ways you could extend this. Note that since we are drawing the transmission rate and fixing the duration of infection, the <span class="math inline">\(R_0\)</span> is slightly different in each simulation. You could make each run have the same <span class="math inline">\(R_0\)</span> by recalculating the duration of infection based on the random draw of transmission rate; e.g.&nbsp;<span class="math inline">\(R_0=1.8 = 0.29 * L\)</span> means that <span class="math inline">\(L=5.5\)</span>, so to ensure <span class="math inline">\(R_0\)</span> is the same in each run, you would need to change <span class="math inline">\(L\)</span> for each random draw. Alternatively, you might have uncertainty about transmission and duration, so could for e.g.&nbsp;make random draws for both (which would again give a setting where <span class="math inline">\(R_0\)</span> varies from run to run). None of these are more correct than another, the use case depends on which elements <span class="math inline">\(R_0\)</span>, transmission, duration of infection, you are uncertain about.</p>
<p>In each of the above, the model is , meaning that for a given set of parameters, the resulting outbreak trajectory is always the same. For a model, each run of the model will vary, even if the parameters are the same. This is because each event that occurs (e.g.&nbsp;someone getting infected or recovering) is analogous to a coin flip; even though the rules of the coin (the parameters) are always the same, the side it lands on is random. Unlike a deterministic model, to fully understand the behavior of a stochastic model, you need to run it more than one time, often many times, so these are necessarily more time consuming to work with.</p>
<p>There are many, many ways to make stochastic models and the steps can be way more complicated than flipping coins. But there some foundational versions of these models that illustrate the trade-offs between exact representations of the random processes we think are happening and the computational time it takes to generate outputs. For what we’ll do here, everything will be kind of fast, but in practice, for models of realistic scale, even a single stochastic run can take a while. And if you have to do thousands of runs, even shaving a few seconds or minutes can be important.</p>
</section><section id="the-gillespie-algorithm" class="level2 page-columns page-full" data-number="11.3"><h2 data-number="11.3" class="anchored" data-anchor-id="the-gillespie-algorithm">
<span class="header-section-number">11.3</span> The Gillespie Algorithm</h2>
<p>The Gillespie algorithm is the most explicit translation of the ODE form of the SIR model into a stochastic model. It achieves this by noting that ODE-based models are written in terms of the rates at which events occur. At any given point in time, the rate of all events in the ODE is known; what known, is which of the possible events will happen first. Note that even though we expect that the next thing to happen will be the thing that happens with the highest rate, it’s possible that another thing may happen first by random chance. And then, since the rates in the SIR model are dependent on the value of the states (e.g.&nbsp;new infections depend on <span class="math inline">\(\beta\)</span> and S and I) any change in the states then changes the rates and the likelihood of what will happen next.</p>
<p>The Gillespie algorithm proceeds by 1) calculating all the current rates, 2) randomly drawing exponential random variables that equate to the time until each event happens (recall we talked about the relationship between rate and time in the lectures), then 3) comparing those times and assuming that the next event to occur is the one that had the smallest randomly drawn time. Then you increment the states; e.g.&nbsp;an infection increases I by 1, reduces S by 1, and doesn’t change R. Importantly, you then increment time forward by a step equal to the time until first event occurred. Then you recalculate the rates and randomly draw times, etc, and keep doing this over and over again. For this SIR model, that keeps happening until you run out of infected individuals and there are no new events that can happen.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb8" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a><span class="do">####################################################################</span></span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="co"># Parameters and initial conditions                                #</span></span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="do">####################################################################</span></span>
<span id="cb8-4"><a href="#cb8-4"></a></span>
<span id="cb8-5"><a href="#cb8-5"></a>S <span class="ot">&lt;-</span> <span class="dv">998</span> <span class="co"># number susceptible</span></span>
<span id="cb8-6"><a href="#cb8-6"></a>I <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co"># number infected</span></span>
<span id="cb8-7"><a href="#cb8-7"></a>R <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co"># number recovered</span></span>
<span id="cb8-8"><a href="#cb8-8"></a>time <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb8-9"><a href="#cb8-9"></a></span>
<span id="cb8-10"><a href="#cb8-10"></a>beta <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="co"># transmission rate</span></span>
<span id="cb8-11"><a href="#cb8-11"></a>gamma <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">7</span> <span class="co"># recovery rate</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb9" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a><span class="do">####################################################################</span></span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="co"># Gillespie Step                                                   #</span></span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="do">####################################################################</span></span>
<span id="cb9-4"><a href="#cb9-4"></a>gil_step <span class="ot">&lt;-</span> <span class="cf">function</span>(SIR, beta, gamma) {</span>
<span id="cb9-5"><a href="#cb9-5"></a>  <span class="co"># SIR is a vector containing 4 elements</span></span>
<span id="cb9-6"><a href="#cb9-6"></a>  <span class="co">#   S = scalar number of susceptibles now</span></span>
<span id="cb9-7"><a href="#cb9-7"></a>  <span class="co">#   I = scalar number of infecteds now</span></span>
<span id="cb9-8"><a href="#cb9-8"></a>  <span class="co">#   R = scalar number of recovereds now</span></span>
<span id="cb9-9"><a href="#cb9-9"></a>  <span class="co">#   time = current time</span></span>
<span id="cb9-10"><a href="#cb9-10"></a>  <span class="co"># beta = transmission rate</span></span>
<span id="cb9-11"><a href="#cb9-11"></a>  <span class="co"># gamma = recovery rate</span></span>
<span id="cb9-12"><a href="#cb9-12"></a></span>
<span id="cb9-13"><a href="#cb9-13"></a>  <span class="co"># draw two random exponential variables</span></span>
<span id="cb9-14"><a href="#cb9-14"></a>  times <span class="ot">&lt;-</span> <span class="fu">rexp</span>(</span>
<span id="cb9-15"><a href="#cb9-15"></a>    <span class="dv">2</span>,</span>
<span id="cb9-16"><a href="#cb9-16"></a>    <span class="fu">c</span>(</span>
<span id="cb9-17"><a href="#cb9-17"></a>      <span class="co"># the first is the rate of new infections: S*Beta*I/N</span></span>
<span id="cb9-18"><a href="#cb9-18"></a>      beta <span class="sc">*</span> SIR[<span class="dv">1</span>] <span class="sc">*</span> SIR[<span class="dv">2</span>] <span class="sc">/</span> <span class="fu">sum</span>(SIR[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>]),</span>
<span id="cb9-19"><a href="#cb9-19"></a>      <span class="co"># the second is the rate of new recoveries: I*gamma</span></span>
<span id="cb9-20"><a href="#cb9-20"></a>      SIR[<span class="dv">2</span>] <span class="sc">*</span> gamma</span>
<span id="cb9-21"><a href="#cb9-21"></a>    )</span>
<span id="cb9-22"><a href="#cb9-22"></a>  )</span>
<span id="cb9-23"><a href="#cb9-23"></a></span>
<span id="cb9-24"><a href="#cb9-24"></a>  <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb9-25"><a href="#cb9-25"></a>    <span class="co"># which.min identifies which of the two random variables is smallest,</span></span>
<span id="cb9-26"><a href="#cb9-26"></a>    <span class="co"># and thus the first to happen: this is the transition that we'll make</span></span>
<span id="cb9-27"><a href="#cb9-27"></a>    <span class="at">change_state =</span> <span class="fu">which.min</span>(times),</span>
<span id="cb9-28"><a href="#cb9-28"></a>    <span class="co"># this identifies how much time elapsed before the transition occurred,</span></span>
<span id="cb9-29"><a href="#cb9-29"></a>    <span class="co"># so we can increment time forward</span></span>
<span id="cb9-30"><a href="#cb9-30"></a>    <span class="at">time_step =</span> <span class="fu">min</span>(times)</span>
<span id="cb9-31"><a href="#cb9-31"></a>  ))</span>
<span id="cb9-32"><a href="#cb9-32"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The gil_step() function increments the states forward by 1 event. Which event happens first, and the time it takes for that event to happen are both random variables. We then need to do this many times.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb10" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a><span class="do">####################################################################</span></span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="co"># Simulate over time                                               #</span></span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="do">####################################################################</span></span>
<span id="cb10-4"><a href="#cb10-4"></a><span class="co"># here we set the random seed. This isn't necessary in general, but it allows us to write a "random" simulation</span></span>
<span id="cb10-5"><a href="#cb10-5"></a><span class="fu">set.seed</span>(<span class="dv">101</span>)</span>
<span id="cb10-6"><a href="#cb10-6"></a>counter <span class="ot">&lt;-</span> <span class="dv">0</span> <span class="co"># set counter at 0</span></span>
<span id="cb10-7"><a href="#cb10-7"></a><span class="cf">while</span> (<span class="fu">all</span>(I <span class="sc">&gt;</span> <span class="dv">0</span>)) {</span>
<span id="cb10-8"><a href="#cb10-8"></a>  <span class="co"># continue until I is depleted</span></span>
<span id="cb10-9"><a href="#cb10-9"></a>  counter <span class="ot">&lt;-</span> counter <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb10-10"><a href="#cb10-10"></a>  <span class="co"># counter for number of transitions: we don't know how many transitions</span></span>
<span id="cb10-11"><a href="#cb10-11"></a>  <span class="co"># will happen until the simulation is over</span></span>
<span id="cb10-12"><a href="#cb10-12"></a>  <span class="co">#</span></span>
<span id="cb10-13"><a href="#cb10-13"></a>  <span class="co"># current SIR states</span></span>
<span id="cb10-14"><a href="#cb10-14"></a>  sir_tmp <span class="ot">&lt;-</span> <span class="fu">c</span>(S[counter], I[counter], R[counter], time[counter])</span>
<span id="cb10-15"><a href="#cb10-15"></a>  step <span class="ot">&lt;-</span> <span class="fu">gil_step</span>(sir_tmp, beta, gamma)</span>
<span id="cb10-16"><a href="#cb10-16"></a>  <span class="cf">if</span> (step<span class="sc">$</span>change_state <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb10-17"><a href="#cb10-17"></a>    <span class="co"># if transition is an infection, reduce S and increase I</span></span>
<span id="cb10-18"><a href="#cb10-18"></a>    sir_tmp[<span class="dv">1</span>] <span class="ot">&lt;-</span> sir_tmp[<span class="dv">1</span>] <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb10-19"><a href="#cb10-19"></a>    sir_tmp[<span class="dv">2</span>] <span class="ot">&lt;-</span> sir_tmp[<span class="dv">2</span>] <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb10-20"><a href="#cb10-20"></a>  }</span>
<span id="cb10-21"><a href="#cb10-21"></a>  <span class="cf">if</span> (step<span class="sc">$</span>change_state <span class="sc">==</span> <span class="dv">2</span>) {</span>
<span id="cb10-22"><a href="#cb10-22"></a>    <span class="co"># if transition is an recovery, reduce I and increase R</span></span>
<span id="cb10-23"><a href="#cb10-23"></a>    sir_tmp[<span class="dv">2</span>] <span class="ot">&lt;-</span> sir_tmp[<span class="dv">2</span>] <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb10-24"><a href="#cb10-24"></a>    sir_tmp[<span class="dv">3</span>] <span class="ot">&lt;-</span> sir_tmp[<span class="dv">3</span>] <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb10-25"><a href="#cb10-25"></a>  }</span>
<span id="cb10-26"><a href="#cb10-26"></a>  sir_tmp[<span class="dv">4</span>] <span class="ot">&lt;-</span> sir_tmp[<span class="dv">4</span>] <span class="sc">+</span> step<span class="sc">$</span>time_step <span class="co"># increment time</span></span>
<span id="cb10-27"><a href="#cb10-27"></a></span>
<span id="cb10-28"><a href="#cb10-28"></a>  <span class="co"># Append changes</span></span>
<span id="cb10-29"><a href="#cb10-29"></a>  S <span class="ot">&lt;-</span> <span class="fu">c</span>(S, sir_tmp[<span class="dv">1</span>])</span>
<span id="cb10-30"><a href="#cb10-30"></a>  I <span class="ot">&lt;-</span> <span class="fu">c</span>(I, sir_tmp[<span class="dv">2</span>])</span>
<span id="cb10-31"><a href="#cb10-31"></a>  R <span class="ot">&lt;-</span> <span class="fu">c</span>(R, sir_tmp[<span class="dv">3</span>])</span>
<span id="cb10-32"><a href="#cb10-32"></a>  time <span class="ot">&lt;-</span> <span class="fu">c</span>(time, sir_tmp[<span class="dv">4</span>])</span>
<span id="cb10-33"><a href="#cb10-33"></a></span>
<span id="cb10-34"><a href="#cb10-34"></a>  <span class="co"># cat(S[counter],\"-\",I[counter],\"-\",R[counter],\"-\",time[counter], \".\\n\")</span></span>
<span id="cb10-35"><a href="#cb10-35"></a>  <span class="co"># this prints the output as it goes</span></span>
<span id="cb10-36"><a href="#cb10-36"></a>  <span class="co"># reset the seed so that every subsequent simulation IS random</span></span>
<span id="cb10-37"><a href="#cb10-37"></a>  <span class="fu">set.seed</span>(<span class="cn">NULL</span>)</span>
<span id="cb10-38"><a href="#cb10-38"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We can now plot the one realization of this stochastic outbreak. Notice that it has the same general shape as the deterministic outbreak, but is no longer smooth because each individual event over time happens randomly.</p>
<div class="cell page-columns page-full">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb11" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a><span class="co"># Reuse the plotting code from above</span></span>
<span id="cb11-2"><a href="#cb11-2"></a></span>
<span id="cb11-3"><a href="#cb11-3"></a><span class="co"># Turn the output from gil_step() into a tibble (dataframe)</span></span>
<span id="cb11-4"><a href="#cb11-4"></a><span class="co"># so we can manipulate and plot it easily</span></span>
<span id="cb11-5"><a href="#cb11-5"></a><span class="co"># put elements in a data frame</span></span>
<span id="cb11-6"><a href="#cb11-6"></a>gil_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(time, S, I, R) <span class="sc">%&gt;%</span></span>
<span id="cb11-7"><a href="#cb11-7"></a>  <span class="co"># Convert all columns to numeric (they are currently type</span></span>
<span id="cb11-8"><a href="#cb11-8"></a>  <span class="co"># deSolve so will produce warnings when plotting etc)</span></span>
<span id="cb11-9"><a href="#cb11-9"></a>  <span class="fu">mutate</span>(</span>
<span id="cb11-10"><a href="#cb11-10"></a>    <span class="co"># Rather than repeatedly type the same function for every</span></span>
<span id="cb11-11"><a href="#cb11-11"></a>    <span class="co"># column, use the across() function to apply the function</span></span>
<span id="cb11-12"><a href="#cb11-12"></a>    <span class="co"># to a selection of columns</span></span>
<span id="cb11-13"><a href="#cb11-13"></a>    <span class="fu">across</span>(</span>
<span id="cb11-14"><a href="#cb11-14"></a>      <span class="co"># The cols argument takes a selection of columns to apply</span></span>
<span id="cb11-15"><a href="#cb11-15"></a>      <span class="co"># a function to. Here, we want to apply the as.numeric()</span></span>
<span id="cb11-16"><a href="#cb11-16"></a>      <span class="co"># function to all columns, so we use the function</span></span>
<span id="cb11-17"><a href="#cb11-17"></a>      <span class="co"># everything() to select all columns.</span></span>
<span id="cb11-18"><a href="#cb11-18"></a>      <span class="at">.cols =</span> <span class="fu">everything</span>(),</span>
<span id="cb11-19"><a href="#cb11-19"></a>      <span class="at">.fns =</span> as.numeric</span>
<span id="cb11-20"><a href="#cb11-20"></a>    )</span>
<span id="cb11-21"><a href="#cb11-21"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb11-22"><a href="#cb11-22"></a>  <span class="co"># Convert the dataframe from wide to long format, so we have a</span></span>
<span id="cb11-23"><a href="#cb11-23"></a>  <span class="co"># column for the time, a column for the state, and a column</span></span>
<span id="cb11-24"><a href="#cb11-24"></a>  <span class="co"># for the proportion of the population in that state at that</span></span>
<span id="cb11-25"><a href="#cb11-25"></a>  <span class="co"># time</span></span>
<span id="cb11-26"><a href="#cb11-26"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb11-27"><a href="#cb11-27"></a>    <span class="co"># Don't pivot the time column</span></span>
<span id="cb11-28"><a href="#cb11-28"></a>    <span class="at">cols =</span> <span class="sc">-</span><span class="fu">c</span>(time),</span>
<span id="cb11-29"><a href="#cb11-29"></a>    <span class="at">names_to =</span> <span class="st">"state"</span>,</span>
<span id="cb11-30"><a href="#cb11-30"></a>    <span class="at">values_to =</span> <span class="st">"number"</span></span>
<span id="cb11-31"><a href="#cb11-31"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb11-32"><a href="#cb11-32"></a>  <span class="co"># Update the state column to be a factor, so the plot will</span></span>
<span id="cb11-33"><a href="#cb11-33"></a>  <span class="co"># show the states in the correct order</span></span>
<span id="cb11-34"><a href="#cb11-34"></a>  <span class="fu">mutate</span>(<span class="at">state =</span> <span class="fu">factor</span>(state, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"S"</span>, <span class="st">"I"</span>, <span class="st">"R"</span>)))</span>
<span id="cb11-35"><a href="#cb11-35"></a></span>
<span id="cb11-36"><a href="#cb11-36"></a>sir_colors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">S =</span> <span class="st">"#1f77b4"</span>, <span class="at">I =</span> <span class="st">"#ff7f0e"</span>, <span class="at">R =</span> <span class="st">"#FF3851"</span>)</span>
<span id="cb11-37"><a href="#cb11-37"></a></span>
<span id="cb11-38"><a href="#cb11-38"></a><span class="fu">ggplot</span>(gil_df, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> number, <span class="at">color =</span> state)) <span class="sc">+</span></span>
<span id="cb11-39"><a href="#cb11-39"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb11-40"><a href="#cb11-40"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> sir_colors) <span class="sc">+</span></span>
<span id="cb11-41"><a href="#cb11-41"></a>  <span class="fu">labs</span>(</span>
<span id="cb11-42"><a href="#cb11-42"></a>    <span class="at">x =</span> <span class="st">"Time"</span>,</span>
<span id="cb11-43"><a href="#cb11-43"></a>    <span class="at">y =</span> <span class="st">"Number"</span>,</span>
<span id="cb11-44"><a href="#cb11-44"></a>    <span class="at">color =</span> <span class="st">"State"</span></span>
<span id="cb11-45"><a href="#cb11-45"></a>  ) <span class="sc">+</span></span>
<span id="cb11-46"><a href="#cb11-46"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="r-session-04_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img column-body" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Because each realization is stochastic, we need to generate many runs to see the general behavior. The code below runs 10 iterations. Generally, this would be considered a very small number of iterations. But even for this very small model, running 100 or more means you’ll be waiting for output. Note that this code is designed to be transparent not to be fast. Making these run fast is beyond the scope of this assignment.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb12" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a><span class="do">####################################################################</span></span>
<span id="cb12-2"><a href="#cb12-2"></a><span class="co"># Simulate over time                                               #</span></span>
<span id="cb12-3"><a href="#cb12-3"></a>num_iterations <span class="ot">&lt;-</span> <span class="dv">10</span> <span class="co"># number of realizations to simulate</span></span>
<span id="cb12-4"><a href="#cb12-4"></a></span>
<span id="cb12-5"><a href="#cb12-5"></a><span class="cf">for</span> (iter <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>num_iterations) {</span>
<span id="cb12-6"><a href="#cb12-6"></a>  <span class="do">####################################################################</span></span>
<span id="cb12-7"><a href="#cb12-7"></a>  <span class="co"># Parameters and initial conditions                                #</span></span>
<span id="cb12-8"><a href="#cb12-8"></a>  <span class="do">####################################################################</span></span>
<span id="cb12-9"><a href="#cb12-9"></a></span>
<span id="cb12-10"><a href="#cb12-10"></a>  S <span class="ot">&lt;-</span> <span class="dv">998</span> <span class="co"># number susceptible</span></span>
<span id="cb12-11"><a href="#cb12-11"></a>  I <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co"># number infected</span></span>
<span id="cb12-12"><a href="#cb12-12"></a>  R <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co"># number recovered</span></span>
<span id="cb12-13"><a href="#cb12-13"></a>  time <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb12-14"><a href="#cb12-14"></a>  <span class="co"># initialize iteration counter</span></span>
<span id="cb12-15"><a href="#cb12-15"></a>  iteration <span class="ot">&lt;-</span> iter</span>
<span id="cb12-16"><a href="#cb12-16"></a></span>
<span id="cb12-17"><a href="#cb12-17"></a>  beta <span class="ot">&lt;-</span> .<span class="dv">5</span> <span class="co"># transmission rate</span></span>
<span id="cb12-18"><a href="#cb12-18"></a>  gamma <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">7</span> <span class="co"># recovery rate</span></span>
<span id="cb12-19"><a href="#cb12-19"></a></span>
<span id="cb12-20"><a href="#cb12-20"></a>  <span class="do">####################################################################</span></span>
<span id="cb12-21"><a href="#cb12-21"></a>  <span class="co"># Simulate over time                                               #</span></span>
<span id="cb12-22"><a href="#cb12-22"></a>  <span class="do">####################################################################</span></span>
<span id="cb12-23"><a href="#cb12-23"></a>  counter <span class="ot">&lt;-</span> <span class="dv">0</span> <span class="co"># set counter at 0</span></span>
<span id="cb12-24"><a href="#cb12-24"></a>  <span class="cf">while</span> (<span class="fu">all</span>(I <span class="sc">&gt;</span> <span class="dv">0</span>)) {</span>
<span id="cb12-25"><a href="#cb12-25"></a>    <span class="co"># continue until I is depleted</span></span>
<span id="cb12-26"><a href="#cb12-26"></a>    counter <span class="ot">&lt;-</span> counter <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb12-27"><a href="#cb12-27"></a>    <span class="co"># counter for number of transitions: we don't know how many transitions</span></span>
<span id="cb12-28"><a href="#cb12-28"></a>    <span class="co"># will happen until the simulation is over</span></span>
<span id="cb12-29"><a href="#cb12-29"></a></span>
<span id="cb12-30"><a href="#cb12-30"></a>    <span class="co"># current SIR states</span></span>
<span id="cb12-31"><a href="#cb12-31"></a>    sir_tmp <span class="ot">&lt;-</span> <span class="fu">c</span>(S[counter], I[counter], R[counter], time[counter])</span>
<span id="cb12-32"><a href="#cb12-32"></a>    step <span class="ot">&lt;-</span> <span class="fu">gil_step</span>(sir_tmp, beta, gamma)</span>
<span id="cb12-33"><a href="#cb12-33"></a>    <span class="cf">if</span> (step<span class="sc">$</span>change_state <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb12-34"><a href="#cb12-34"></a>      <span class="co"># if transition is an infection, reduce S and increase I</span></span>
<span id="cb12-35"><a href="#cb12-35"></a>      sir_tmp[<span class="dv">1</span>] <span class="ot">&lt;-</span> sir_tmp[<span class="dv">1</span>] <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb12-36"><a href="#cb12-36"></a>      sir_tmp[<span class="dv">2</span>] <span class="ot">&lt;-</span> sir_tmp[<span class="dv">2</span>] <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb12-37"><a href="#cb12-37"></a>    }</span>
<span id="cb12-38"><a href="#cb12-38"></a>    <span class="cf">if</span> (step<span class="sc">$</span>change_state <span class="sc">==</span> <span class="dv">2</span>) {</span>
<span id="cb12-39"><a href="#cb12-39"></a>      <span class="co"># if transition is an recovery, reduce I and increase R</span></span>
<span id="cb12-40"><a href="#cb12-40"></a>      sir_tmp[<span class="dv">2</span>] <span class="ot">&lt;-</span> sir_tmp[<span class="dv">2</span>] <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb12-41"><a href="#cb12-41"></a>      sir_tmp[<span class="dv">3</span>] <span class="ot">&lt;-</span> sir_tmp[<span class="dv">3</span>] <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb12-42"><a href="#cb12-42"></a>    }</span>
<span id="cb12-43"><a href="#cb12-43"></a>    <span class="co"># increment time</span></span>
<span id="cb12-44"><a href="#cb12-44"></a>    sir_tmp[<span class="dv">4</span>] <span class="ot">&lt;-</span> sir_tmp[<span class="dv">4</span>] <span class="sc">+</span> step<span class="sc">$</span>time_step</span>
<span id="cb12-45"><a href="#cb12-45"></a></span>
<span id="cb12-46"><a href="#cb12-46"></a>    <span class="co"># Append changes</span></span>
<span id="cb12-47"><a href="#cb12-47"></a>    S <span class="ot">&lt;-</span> <span class="fu">c</span>(S, sir_tmp[<span class="dv">1</span>])</span>
<span id="cb12-48"><a href="#cb12-48"></a>    I <span class="ot">&lt;-</span> <span class="fu">c</span>(I, sir_tmp[<span class="dv">2</span>])</span>
<span id="cb12-49"><a href="#cb12-49"></a>    R <span class="ot">&lt;-</span> <span class="fu">c</span>(R, sir_tmp[<span class="dv">3</span>])</span>
<span id="cb12-50"><a href="#cb12-50"></a>    time <span class="ot">&lt;-</span> <span class="fu">c</span>(time, sir_tmp[<span class="dv">4</span>])</span>
<span id="cb12-51"><a href="#cb12-51"></a>    iteration <span class="ot">&lt;-</span> <span class="fu">c</span>(iteration, iter)</span>
<span id="cb12-52"><a href="#cb12-52"></a></span>
<span id="cb12-53"><a href="#cb12-53"></a>    <span class="co"># cat(S[counter],\"-\",I[counter],\"-\",R[counter],\"-\",time[counter], \".\\n\")</span></span>
<span id="cb12-54"><a href="#cb12-54"></a>    <span class="co"># this prints the output as it goes</span></span>
<span id="cb12-55"><a href="#cb12-55"></a>  }</span>
<span id="cb12-56"><a href="#cb12-56"></a>  <span class="cf">if</span> (iter <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb12-57"><a href="#cb12-57"></a>    sir_gil_storage <span class="ot">&lt;-</span> <span class="fu">tibble</span>(S, I, R, time, iteration)</span>
<span id="cb12-58"><a href="#cb12-58"></a>  }</span>
<span id="cb12-59"><a href="#cb12-59"></a>  <span class="cf">if</span> (iter <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb12-60"><a href="#cb12-60"></a>    sir_gil_storage <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb12-61"><a href="#cb12-61"></a>      sir_gil_storage,</span>
<span id="cb12-62"><a href="#cb12-62"></a>      <span class="fu">tibble</span>(S, I, R, time, iteration)</span>
<span id="cb12-63"><a href="#cb12-63"></a>    )</span>
<span id="cb12-64"><a href="#cb12-64"></a>  }</span>
<span id="cb12-65"><a href="#cb12-65"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell page-columns page-full">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb13" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a><span class="co"># Reuse the plotting code from above</span></span>
<span id="cb13-2"><a href="#cb13-2"></a></span>
<span id="cb13-3"><a href="#cb13-3"></a><span class="co"># Turn the output from gil_step() into a tibble (dataframe)</span></span>
<span id="cb13-4"><a href="#cb13-4"></a><span class="co"># so we can manipulate and plot it easily</span></span>
<span id="cb13-5"><a href="#cb13-5"></a><span class="co"># put elements in a data frame</span></span>
<span id="cb13-6"><a href="#cb13-6"></a>gil_df <span class="ot">&lt;-</span> sir_gil_storage <span class="sc">%&gt;%</span></span>
<span id="cb13-7"><a href="#cb13-7"></a>  <span class="co"># Convert all columns to numeric (they are currently type</span></span>
<span id="cb13-8"><a href="#cb13-8"></a>  <span class="co"># deSolve so will produce warnings when plotting etc)</span></span>
<span id="cb13-9"><a href="#cb13-9"></a>  <span class="fu">mutate</span>(</span>
<span id="cb13-10"><a href="#cb13-10"></a>    <span class="co"># Rather than repeatedly type the same function for every</span></span>
<span id="cb13-11"><a href="#cb13-11"></a>    <span class="co"># column, use the across() function to apply the function</span></span>
<span id="cb13-12"><a href="#cb13-12"></a>    <span class="co"># to a selection of columns</span></span>
<span id="cb13-13"><a href="#cb13-13"></a>    <span class="fu">across</span>(</span>
<span id="cb13-14"><a href="#cb13-14"></a>      <span class="co"># The cols argument takes a selection of columns to apply</span></span>
<span id="cb13-15"><a href="#cb13-15"></a>      <span class="co"># a function to. Here, we want to apply the as.numeric()</span></span>
<span id="cb13-16"><a href="#cb13-16"></a>      <span class="co"># function to all columns, so we use the function</span></span>
<span id="cb13-17"><a href="#cb13-17"></a>      <span class="co"># everything() to select all columns.</span></span>
<span id="cb13-18"><a href="#cb13-18"></a>      <span class="at">.cols =</span> <span class="fu">everything</span>(),</span>
<span id="cb13-19"><a href="#cb13-19"></a>      <span class="at">.fns =</span> as.numeric</span>
<span id="cb13-20"><a href="#cb13-20"></a>    )</span>
<span id="cb13-21"><a href="#cb13-21"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb13-22"><a href="#cb13-22"></a>  <span class="co"># Convert the dataframe from wide to long format, so we have a</span></span>
<span id="cb13-23"><a href="#cb13-23"></a>  <span class="co"># column for the time, a column for the state, and a column</span></span>
<span id="cb13-24"><a href="#cb13-24"></a>  <span class="co"># for the proportion of the population in that state at that</span></span>
<span id="cb13-25"><a href="#cb13-25"></a>  <span class="co"># time</span></span>
<span id="cb13-26"><a href="#cb13-26"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb13-27"><a href="#cb13-27"></a>    <span class="co"># Don't pivot the time column</span></span>
<span id="cb13-28"><a href="#cb13-28"></a>    <span class="at">cols =</span> <span class="sc">-</span><span class="fu">c</span>(time, iteration),</span>
<span id="cb13-29"><a href="#cb13-29"></a>    <span class="at">names_to =</span> <span class="st">"state"</span>,</span>
<span id="cb13-30"><a href="#cb13-30"></a>    <span class="at">values_to =</span> <span class="st">"number"</span></span>
<span id="cb13-31"><a href="#cb13-31"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb13-32"><a href="#cb13-32"></a>  <span class="co"># Update the state column to be a factor, so the plot will</span></span>
<span id="cb13-33"><a href="#cb13-33"></a>  <span class="co"># show the states in the correct order</span></span>
<span id="cb13-34"><a href="#cb13-34"></a>  <span class="fu">mutate</span>(<span class="at">state =</span> <span class="fu">factor</span>(state, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"S"</span>, <span class="st">"I"</span>, <span class="st">"R"</span>)))</span>
<span id="cb13-35"><a href="#cb13-35"></a></span>
<span id="cb13-36"><a href="#cb13-36"></a>sir_colors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">S =</span> <span class="st">"#1f77b4"</span>, <span class="at">I =</span> <span class="st">"#ff7f0e"</span>, <span class="at">R =</span> <span class="st">"#FF3851"</span>)</span>
<span id="cb13-37"><a href="#cb13-37"></a></span>
<span id="cb13-38"><a href="#cb13-38"></a><span class="fu">ggplot</span>(</span>
<span id="cb13-39"><a href="#cb13-39"></a>  gil_df,</span>
<span id="cb13-40"><a href="#cb13-40"></a>  <span class="fu">aes</span>(</span>
<span id="cb13-41"><a href="#cb13-41"></a>    <span class="at">x =</span> time,</span>
<span id="cb13-42"><a href="#cb13-42"></a>    <span class="at">y =</span> number,</span>
<span id="cb13-43"><a href="#cb13-43"></a>    <span class="at">color =</span> state,</span>
<span id="cb13-44"><a href="#cb13-44"></a>    <span class="at">group =</span> <span class="fu">interaction</span>(iteration, state)</span>
<span id="cb13-45"><a href="#cb13-45"></a>  )</span>
<span id="cb13-46"><a href="#cb13-46"></a>) <span class="sc">+</span></span>
<span id="cb13-47"><a href="#cb13-47"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.5</span>, <span class="at">alpha =</span> .<span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb13-48"><a href="#cb13-48"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> sir_colors) <span class="sc">+</span></span>
<span id="cb13-49"><a href="#cb13-49"></a>  <span class="fu">labs</span>(</span>
<span id="cb13-50"><a href="#cb13-50"></a>    <span class="at">x =</span> <span class="st">"Time"</span>,</span>
<span id="cb13-51"><a href="#cb13-51"></a>    <span class="at">y =</span> <span class="st">"Number"</span>,</span>
<span id="cb13-52"><a href="#cb13-52"></a>    <span class="at">color =</span> <span class="st">"State"</span></span>
<span id="cb13-53"><a href="#cb13-53"></a>  ) <span class="sc">+</span></span>
<span id="cb13-54"><a href="#cb13-54"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">alpha =</span> <span class="dv">1</span>))) <span class="sc">+</span></span>
<span id="cb13-55"><a href="#cb13-55"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="r-session-04_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img column-body" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>The Gillespie algorithm doesn’t cut any corners relative to the ODE model, but that comes at the cost of computational efficiency. For every event that happens (e.g.&nbsp;an infection) you also have to generate a random draw (e.g.&nbsp;a recovery) that you don’t use, except for comparison. And the bigger your population, the more possible events can happen. So the bigger the model (e.g.&nbsp;adding exposed or vaccinated classes, or heterogeneity, add transitions) and the bigger the population, the more calculation you need and and therefore the slower the model.</p>
</section><section id="the-tau-leaping-algorithm" class="level2 page-columns page-full" data-number="11.4"><h2 data-number="11.4" class="anchored" data-anchor-id="the-tau-leaping-algorithm">
<span class="header-section-number">11.4</span> The Tau Leaping Algorithm</h2>
<p>The Gillespie algorithm is great because it is an exact interpretation of the transitions in the ODE model: every change of state (e.g.&nbsp;infection or recovery) changes the rates for the next transition. Doing this comes at a computational cost. One reasonable approximation is the Tau Leaping algorithm. Here, we move in discrete chunks of time and make random draws for multiple events occurring within that chunk. Here the computation scales with the number of time steps (and the number of states requiring transitions). But, we rely on the result that, if rates stay constant, the number of events that occur in a discrete chunk of time can be approximated by a Poisson random variable. Thus, we don’t need to make random draws for every event. Instead we can make 1 draw for the multiple events that will occur in 1 day, or 1 week, etc. The key here is the assumption that the rates stay constant; since each new infection or recovery will change the rates, we don’t want to occur (in which case the rate at the start of the time step will be very different than the rate at the end of the time step). So we are faced with a trade-off; very small time steps don’t violate the assumptions, but the smaller the steps, the closer we are to Gillespie and the smaller the computational savings. There’s no right answer to what time step to use. Here we’ll use 1 day, for convenience.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb14" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a><span class="do">####################################################################</span></span>
<span id="cb14-2"><a href="#cb14-2"></a><span class="co"># Parameters and initial conditions                                #</span></span>
<span id="cb14-3"><a href="#cb14-3"></a><span class="do">####################################################################</span></span>
<span id="cb14-4"><a href="#cb14-4"></a></span>
<span id="cb14-5"><a href="#cb14-5"></a>S <span class="ot">&lt;-</span> <span class="dv">998</span> <span class="co"># number susceptible</span></span>
<span id="cb14-6"><a href="#cb14-6"></a>I <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co"># number infected</span></span>
<span id="cb14-7"><a href="#cb14-7"></a>R <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co"># number recovered</span></span>
<span id="cb14-8"><a href="#cb14-8"></a>time <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb14-9"><a href="#cb14-9"></a></span>
<span id="cb14-10"><a href="#cb14-10"></a>beta <span class="ot">&lt;-</span> .<span class="dv">5</span> <span class="co"># transmission rate</span></span>
<span id="cb14-11"><a href="#cb14-11"></a>gamma <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">7</span> <span class="co"># recovery rate</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb15" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a><span class="do">####################################################################</span></span>
<span id="cb15-2"><a href="#cb15-2"></a><span class="co"># Tau Leaping Single time step                                     #</span></span>
<span id="cb15-3"><a href="#cb15-3"></a><span class="do">####################################################################</span></span>
<span id="cb15-4"><a href="#cb15-4"></a>tau_sir_step <span class="ot">&lt;-</span> <span class="cf">function</span>(sims, S, I, R, beta, gamma, delta_t, ...) {</span>
<span id="cb15-5"><a href="#cb15-5"></a>  <span class="co"># adapted from Aaron King's code</span></span>
<span id="cb15-6"><a href="#cb15-6"></a>  <span class="co"># sims = number of simulations</span></span>
<span id="cb15-7"><a href="#cb15-7"></a>  <span class="co"># S = initial susceptible population</span></span>
<span id="cb15-8"><a href="#cb15-8"></a>  <span class="co"># I = initial infected population</span></span>
<span id="cb15-9"><a href="#cb15-9"></a>  <span class="co"># R = initial recovered population</span></span>
<span id="cb15-10"><a href="#cb15-10"></a>  <span class="co"># beta = transmission rate</span></span>
<span id="cb15-11"><a href="#cb15-11"></a>  <span class="co"># gamma = recovery rate</span></span>
<span id="cb15-12"><a href="#cb15-12"></a></span>
<span id="cb15-13"><a href="#cb15-13"></a>  <span class="co"># total population size</span></span>
<span id="cb15-14"><a href="#cb15-14"></a>  N <span class="ot">&lt;-</span> S <span class="sc">+</span> I <span class="sc">+</span> R</span>
<span id="cb15-15"><a href="#cb15-15"></a>  <span class="co"># new incident infections</span></span>
<span id="cb15-16"><a href="#cb15-16"></a>  dSI <span class="ot">&lt;-</span> <span class="fu">rpois</span>(<span class="at">n =</span> sims, beta <span class="sc">*</span> S <span class="sc">*</span> (I <span class="sc">/</span> N) <span class="sc">*</span> delta_t)</span>
<span id="cb15-17"><a href="#cb15-17"></a>  <span class="co"># recoveries</span></span>
<span id="cb15-18"><a href="#cb15-18"></a>  dIR <span class="ot">&lt;-</span> <span class="fu">rpois</span>(<span class="at">n =</span> sims, gamma <span class="sc">*</span> I <span class="sc">*</span> delta_t)</span>
<span id="cb15-19"><a href="#cb15-19"></a>  <span class="co"># note that this can be done with a binomial step as well</span></span>
<span id="cb15-20"><a href="#cb15-20"></a>  <span class="co"># dSI &lt;- rbinom(n=sims,size=S,prob=1-exp(-beta*(I/N)*delta_t))</span></span>
<span id="cb15-21"><a href="#cb15-21"></a>  <span class="co"># new incident infections</span></span>
<span id="cb15-22"><a href="#cb15-22"></a>  <span class="co"># dIR &lt;- rbinom(n=sims,size=I,prob=1-exp(-gamma*delta_t))</span></span>
<span id="cb15-23"><a href="#cb15-23"></a>  <span class="co"># recoveries</span></span>
<span id="cb15-24"><a href="#cb15-24"></a></span>
<span id="cb15-25"><a href="#cb15-25"></a>  <span class="co"># since it is possible for the transitions to drive the states negative,</span></span>
<span id="cb15-26"><a href="#cb15-26"></a>  <span class="co"># we have to prevent that</span></span>
<span id="cb15-27"><a href="#cb15-27"></a>  <span class="co"># change in S</span></span>
<span id="cb15-28"><a href="#cb15-28"></a>  S <span class="ot">&lt;-</span> <span class="fu">pmax</span>(S <span class="sc">-</span> dSI, <span class="dv">0</span>)</span>
<span id="cb15-29"><a href="#cb15-29"></a>  <span class="co"># change in I</span></span>
<span id="cb15-30"><a href="#cb15-30"></a>  I <span class="ot">&lt;-</span> <span class="fu">pmax</span>(I <span class="sc">+</span> dSI <span class="sc">-</span> dIR, <span class="dv">0</span>)</span>
<span id="cb15-31"><a href="#cb15-31"></a>  <span class="co"># change in R</span></span>
<span id="cb15-32"><a href="#cb15-32"></a>  R <span class="ot">&lt;-</span> R <span class="sc">+</span> dIR</span>
<span id="cb15-33"><a href="#cb15-33"></a>  <span class="co"># note that dSI are the new incident infections</span></span>
<span id="cb15-34"><a href="#cb15-34"></a>  <span class="fu">cbind</span>(S, I, R, dSI)</span>
<span id="cb15-35"><a href="#cb15-35"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Note in the code above that we’re taking Poisson random draws, but there is some code commented out that uses binomial draws. The former is exact for the theory, but it can give rise to settings where the transitions “get ahead of themselves” and you have more recoveries than infecteds, or more infections than susceptibles, which drives the states negative. We can fix this by checking if the states go negative and disallowing this … which is inelegant. We can also fix this by using binomial draws, which are naturally constrained not to go negative. The reason we don’t automatically start with binomial draws is that they are computationally slower than Poisson draws (this occurs because the binomial distribution includes some combinatorial terms that are slow to compute). As computers have gotten faster, this is less of an issue.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb16" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a><span class="do">####################################################################</span></span>
<span id="cb16-2"><a href="#cb16-2"></a><span class="co"># set up and storage for states                                    #</span></span>
<span id="cb16-3"><a href="#cb16-3"></a><span class="do">####################################################################</span></span>
<span id="cb16-4"><a href="#cb16-4"></a>max_time <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb16-5"><a href="#cb16-5"></a><span class="co"># time to simulate over. With Tau Leaping the random draws scale with time</span></span>
<span id="cb16-6"><a href="#cb16-6"></a><span class="co"># not with population size, so this is much more efficient than Gillespie</span></span>
<span id="cb16-7"><a href="#cb16-7"></a><span class="co"># for large populations</span></span>
<span id="cb16-8"><a href="#cb16-8"></a>sims <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb16-9"><a href="#cb16-9"></a><span class="co"># number of simulations: notice that we can do WAY more now</span></span>
<span id="cb16-10"><a href="#cb16-10"></a></span>
<span id="cb16-11"><a href="#cb16-11"></a>s_mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(S, <span class="dv">1</span>, sims) <span class="co"># storage item for S for all simulations</span></span>
<span id="cb16-12"><a href="#cb16-12"></a>i_mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(I, <span class="dv">1</span>, sims) <span class="co"># storage item for I for all simulations</span></span>
<span id="cb16-13"><a href="#cb16-13"></a>r_mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(R, <span class="dv">1</span>, sims) <span class="co"># storage item for R for all simulations</span></span>
<span id="cb16-14"><a href="#cb16-14"></a>new_cases <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="dv">1</span>, sims)</span>
<span id="cb16-15"><a href="#cb16-15"></a><span class="co"># storage item for new cases (i.e. incidence) for all simulations</span></span>
<span id="cb16-16"><a href="#cb16-16"></a>n_mat <span class="ot">&lt;-</span> S <span class="sc">+</span> I <span class="sc">+</span> R <span class="co"># storage item for N for all simulations</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb17" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a><span class="do">####################################################################</span></span>
<span id="cb17-2"><a href="#cb17-2"></a><span class="co"># run over a time from 2 to T                                      #</span></span>
<span id="cb17-3"><a href="#cb17-3"></a><span class="do">####################################################################</span></span>
<span id="cb17-4"><a href="#cb17-4"></a><span class="co">#</span></span>
<span id="cb17-5"><a href="#cb17-5"></a><span class="cf">for</span> (time_step <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>max_time) {</span>
<span id="cb17-6"><a href="#cb17-6"></a>  <span class="co"># loop over time, time_step is the index</span></span>
<span id="cb17-7"><a href="#cb17-7"></a></span>
<span id="cb17-8"><a href="#cb17-8"></a>  out <span class="ot">&lt;-</span> <span class="fu">tau_sir_step</span>(</span>
<span id="cb17-9"><a href="#cb17-9"></a>    sims,</span>
<span id="cb17-10"><a href="#cb17-10"></a>    s_mat[time_step <span class="sc">-</span> <span class="dv">1</span>, ],</span>
<span id="cb17-11"><a href="#cb17-11"></a>    i_mat[time_step <span class="sc">-</span> <span class="dv">1</span>, ],</span>
<span id="cb17-12"><a href="#cb17-12"></a>    r_mat[time_step <span class="sc">-</span> <span class="dv">1</span>, ],</span>
<span id="cb17-13"><a href="#cb17-13"></a>    beta,</span>
<span id="cb17-14"><a href="#cb17-14"></a>    gamma,</span>
<span id="cb17-15"><a href="#cb17-15"></a>    <span class="at">delta_t =</span> <span class="dv">1</span></span>
<span id="cb17-16"><a href="#cb17-16"></a>  )</span>
<span id="cb17-17"><a href="#cb17-17"></a>  <span class="co"># call to SIR step function above</span></span>
<span id="cb17-18"><a href="#cb17-18"></a></span>
<span id="cb17-19"><a href="#cb17-19"></a>  <span class="co"># update state</span></span>
<span id="cb17-20"><a href="#cb17-20"></a>  s_mat <span class="ot">&lt;-</span> <span class="fu">rbind</span>(s_mat, out[, <span class="dv">1</span>])</span>
<span id="cb17-21"><a href="#cb17-21"></a>  <span class="co"># update state</span></span>
<span id="cb17-22"><a href="#cb17-22"></a>  i_mat <span class="ot">&lt;-</span> <span class="fu">rbind</span>(i_mat, out[, <span class="dv">2</span>])</span>
<span id="cb17-23"><a href="#cb17-23"></a>  <span class="co"># update state</span></span>
<span id="cb17-24"><a href="#cb17-24"></a>  r_mat <span class="ot">&lt;-</span> <span class="fu">rbind</span>(r_mat, out[, <span class="dv">3</span>])</span>
<span id="cb17-25"><a href="#cb17-25"></a>  <span class="co"># update state -- note population size isn't changing, but this could be</span></span>
<span id="cb17-26"><a href="#cb17-26"></a>  <span class="co"># updated with births/deaths</span></span>
<span id="cb17-27"><a href="#cb17-27"></a>  n_mat <span class="ot">&lt;-</span> <span class="fu">rbind</span>(n_mat, out[, <span class="dv">1</span>] <span class="sc">+</span> out[, <span class="dv">2</span>] <span class="sc">+</span> out[, <span class="dv">3</span>])</span>
<span id="cb17-28"><a href="#cb17-28"></a>  <span class="co"># update state</span></span>
<span id="cb17-29"><a href="#cb17-29"></a>  new_cases <span class="ot">&lt;-</span> <span class="fu">rbind</span>(new_cases, out[, <span class="dv">4</span>])</span>
<span id="cb17-30"><a href="#cb17-30"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Hopefully you can easily see that simulating 1000 iterations of Tau Leaping is faster than Gillespie.</p>
<div class="cell page-columns page-full">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb18" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a><span class="do">####################################################################</span></span>
<span id="cb18-2"><a href="#cb18-2"></a><span class="co"># plotting                                                         #</span></span>
<span id="cb18-3"><a href="#cb18-3"></a><span class="do">####################################################################</span></span>
<span id="cb18-4"><a href="#cb18-4"></a><span class="co"># put output in a data frame</span></span>
<span id="cb18-5"><a href="#cb18-5"></a>tau_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb18-6"><a href="#cb18-6"></a>  <span class="at">S =</span> <span class="fu">array</span>(s_mat),</span>
<span id="cb18-7"><a href="#cb18-7"></a>  <span class="at">I =</span> <span class="fu">array</span>(i_mat),</span>
<span id="cb18-8"><a href="#cb18-8"></a>  <span class="at">R =</span> <span class="fu">array</span>(r_mat),</span>
<span id="cb18-9"><a href="#cb18-9"></a>  <span class="at">N =</span> <span class="fu">array</span>(n_mat),</span>
<span id="cb18-10"><a href="#cb18-10"></a>  <span class="at">cases =</span> <span class="fu">array</span>(new_cases),</span>
<span id="cb18-11"><a href="#cb18-11"></a>  <span class="at">time =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>max_time, sims),</span>
<span id="cb18-12"><a href="#cb18-12"></a>  <span class="at">iteration =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>sims, <span class="at">each =</span> max_time)</span>
<span id="cb18-13"><a href="#cb18-13"></a>)</span>
<span id="cb18-14"><a href="#cb18-14"></a></span>
<span id="cb18-15"><a href="#cb18-15"></a>tau_df <span class="ot">&lt;-</span> tau_df <span class="sc">%&gt;%</span></span>
<span id="cb18-16"><a href="#cb18-16"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb18-17"><a href="#cb18-17"></a>    <span class="co"># Don't pivot the time column</span></span>
<span id="cb18-18"><a href="#cb18-18"></a>    <span class="at">cols =</span> <span class="sc">-</span><span class="fu">c</span>(time, iteration),</span>
<span id="cb18-19"><a href="#cb18-19"></a>    <span class="at">names_to =</span> <span class="st">"state"</span>,</span>
<span id="cb18-20"><a href="#cb18-20"></a>    <span class="at">values_to =</span> <span class="st">"number"</span></span>
<span id="cb18-21"><a href="#cb18-21"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb18-22"><a href="#cb18-22"></a>  <span class="fu">mutate</span>(<span class="at">state =</span> <span class="fu">factor</span>(state, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"S"</span>, <span class="st">"I"</span>, <span class="st">"R"</span>, <span class="st">"N"</span>, <span class="st">"cases"</span>)))</span>
<span id="cb18-23"><a href="#cb18-23"></a></span>
<span id="cb18-24"><a href="#cb18-24"></a><span class="co"># fix this color</span></span>
<span id="cb18-25"><a href="#cb18-25"></a>sir_colors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">S =</span> <span class="st">"#1f77b4"</span>, <span class="at">I =</span> <span class="st">"#ff7f0e"</span>, <span class="at">R =</span> <span class="st">"#FF3851"</span>, <span class="at">cases =</span> <span class="st">"#2ca02c"</span>)</span>
<span id="cb18-26"><a href="#cb18-26"></a></span>
<span id="cb18-27"><a href="#cb18-27"></a>tau_df <span class="sc">%&gt;%</span></span>
<span id="cb18-28"><a href="#cb18-28"></a>  <span class="fu">mutate</span>(<span class="at">iteration =</span> <span class="fu">as.factor</span>(iteration)) <span class="sc">%&gt;%</span></span>
<span id="cb18-29"><a href="#cb18-29"></a>  <span class="fu">filter</span>(state <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"S"</span>, <span class="st">"I"</span>, <span class="st">"R"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb18-30"><a href="#cb18-30"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb18-31"><a href="#cb18-31"></a>    <span class="at">x =</span> time,</span>
<span id="cb18-32"><a href="#cb18-32"></a>    <span class="at">y =</span> number,</span>
<span id="cb18-33"><a href="#cb18-33"></a>    <span class="at">group =</span> <span class="fu">interaction</span>(iteration, state),</span>
<span id="cb18-34"><a href="#cb18-34"></a>    <span class="at">color =</span> state</span>
<span id="cb18-35"><a href="#cb18-35"></a>  )) <span class="sc">+</span></span>
<span id="cb18-36"><a href="#cb18-36"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.5</span>, <span class="at">alpha =</span> .<span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb18-37"><a href="#cb18-37"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> sir_colors) <span class="sc">+</span></span>
<span id="cb18-38"><a href="#cb18-38"></a>  <span class="fu">labs</span>(</span>
<span id="cb18-39"><a href="#cb18-39"></a>    <span class="at">x =</span> <span class="st">"Time"</span>,</span>
<span id="cb18-40"><a href="#cb18-40"></a>    <span class="at">y =</span> <span class="st">"Number"</span>,</span>
<span id="cb18-41"><a href="#cb18-41"></a>    <span class="at">color =</span> <span class="st">"State"</span></span>
<span id="cb18-42"><a href="#cb18-42"></a>  ) <span class="sc">+</span></span>
<span id="cb18-43"><a href="#cb18-43"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">alpha =</span> <span class="dv">1</span>))) <span class="sc">+</span></span>
<span id="cb18-44"><a href="#cb18-44"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="r-session-04_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img column-body" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>And plotting the simulated trajectories should look pretty close to what we got with Gillespie. But, because we can simulate many more iterations, we can start to observe some of the rarer behavior; e.g.&nbsp;even for simulations with <span class="math inline">\(R_0 = 3.5\)</span> there are some simulation runs for which the epidemic doesn’t take off (S stays at 1000).</p>
<p>Note that because we have stored the newly infected individuals as “new cases” then we can plot both the incidence (new cases) and prevalence (I) each day.</p>
<div class="cell page-columns page-full">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb19" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a><span class="do">####################################################################</span></span>
<span id="cb19-2"><a href="#cb19-2"></a><span class="co"># plotting                                                         #</span></span>
<span id="cb19-3"><a href="#cb19-3"></a><span class="do">####################################################################</span></span>
<span id="cb19-4"><a href="#cb19-4"></a><span class="co"># put output in a data frame</span></span>
<span id="cb19-5"><a href="#cb19-5"></a>tau_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb19-6"><a href="#cb19-6"></a>  <span class="at">S =</span> <span class="fu">array</span>(s_mat),</span>
<span id="cb19-7"><a href="#cb19-7"></a>  <span class="at">I =</span> <span class="fu">array</span>(i_mat),</span>
<span id="cb19-8"><a href="#cb19-8"></a>  <span class="at">R =</span> <span class="fu">array</span>(r_mat),</span>
<span id="cb19-9"><a href="#cb19-9"></a>  <span class="at">N =</span> <span class="fu">array</span>(n_mat),</span>
<span id="cb19-10"><a href="#cb19-10"></a>  <span class="at">cases =</span> <span class="fu">array</span>(new_cases),</span>
<span id="cb19-11"><a href="#cb19-11"></a>  <span class="at">time =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>max_time, sims),</span>
<span id="cb19-12"><a href="#cb19-12"></a>  <span class="at">iteration =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>sims, <span class="at">each =</span> max_time)</span>
<span id="cb19-13"><a href="#cb19-13"></a>)</span>
<span id="cb19-14"><a href="#cb19-14"></a></span>
<span id="cb19-15"><a href="#cb19-15"></a>tau_df <span class="ot">&lt;-</span> tau_df <span class="sc">%&gt;%</span></span>
<span id="cb19-16"><a href="#cb19-16"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb19-17"><a href="#cb19-17"></a>    <span class="co"># Don't pivot the time column</span></span>
<span id="cb19-18"><a href="#cb19-18"></a>    <span class="at">cols =</span> <span class="sc">-</span><span class="fu">c</span>(time, iteration),</span>
<span id="cb19-19"><a href="#cb19-19"></a>    <span class="at">names_to =</span> <span class="st">"state"</span>,</span>
<span id="cb19-20"><a href="#cb19-20"></a>    <span class="at">values_to =</span> <span class="st">"number"</span></span>
<span id="cb19-21"><a href="#cb19-21"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb19-22"><a href="#cb19-22"></a>  <span class="fu">mutate</span>(<span class="at">state =</span> <span class="fu">factor</span>(state, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"S"</span>, <span class="st">"I"</span>, <span class="st">"R"</span>, <span class="st">"N"</span>, <span class="st">"cases"</span>)))</span>
<span id="cb19-23"><a href="#cb19-23"></a></span>
<span id="cb19-24"><a href="#cb19-24"></a><span class="co"># fix this color</span></span>
<span id="cb19-25"><a href="#cb19-25"></a>sir_colors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">S =</span> <span class="st">"#1f77b4"</span>, <span class="at">I =</span> <span class="st">"#ff7f0e"</span>, <span class="at">R =</span> <span class="st">"#FF3851"</span>, <span class="at">cases =</span> <span class="st">"#2ca02c"</span>)</span>
<span id="cb19-26"><a href="#cb19-26"></a></span>
<span id="cb19-27"><a href="#cb19-27"></a>tau_df <span class="sc">%&gt;%</span></span>
<span id="cb19-28"><a href="#cb19-28"></a>  <span class="fu">mutate</span>(<span class="at">iteration =</span> <span class="fu">as.factor</span>(iteration)) <span class="sc">%&gt;%</span></span>
<span id="cb19-29"><a href="#cb19-29"></a>  <span class="fu">filter</span>(state <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"I"</span>, <span class="st">"cases"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb19-30"><a href="#cb19-30"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb19-31"><a href="#cb19-31"></a>    <span class="at">x =</span> time,</span>
<span id="cb19-32"><a href="#cb19-32"></a>    <span class="at">y =</span> number,</span>
<span id="cb19-33"><a href="#cb19-33"></a>    <span class="at">group =</span> <span class="fu">interaction</span>(iteration, state),</span>
<span id="cb19-34"><a href="#cb19-34"></a>    <span class="at">color =</span> state</span>
<span id="cb19-35"><a href="#cb19-35"></a>  )) <span class="sc">+</span></span>
<span id="cb19-36"><a href="#cb19-36"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.5</span>, <span class="at">alpha =</span> .<span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb19-37"><a href="#cb19-37"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> sir_colors) <span class="sc">+</span></span>
<span id="cb19-38"><a href="#cb19-38"></a>  <span class="fu">labs</span>(</span>
<span id="cb19-39"><a href="#cb19-39"></a>    <span class="at">x =</span> <span class="st">"Time"</span>,</span>
<span id="cb19-40"><a href="#cb19-40"></a>    <span class="at">y =</span> <span class="st">"Number"</span>,</span>
<span id="cb19-41"><a href="#cb19-41"></a>    <span class="at">color =</span> <span class="st">"State"</span></span>
<span id="cb19-42"><a href="#cb19-42"></a>  ) <span class="sc">+</span></span>
<span id="cb19-43"><a href="#cb19-43"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">alpha =</span> <span class="dv">1</span>))) <span class="sc">+</span></span>
<span id="cb19-44"><a href="#cb19-44"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="r-session-04_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img column-body" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Recall that the time series of new incident cases is very different than the time series of prevalent cases. Recall from our earlier discussion that the former are more likely to be what we would see in clinical surveillance. The latter are what we might see if we did random testing in the population. Which one would you expect to correspond best to environmental wastewater surveillance?</p>
</div>
</div>
</section><section id="the-chain-binomial-algorithm" class="level2 page-columns page-full" data-number="11.5"><h2 data-number="11.5" class="anchored" data-anchor-id="the-chain-binomial-algorithm">
<span class="header-section-number">11.5</span> The Chain Binomial Algorithm</h2>
<p>In the last section, we saw that by moving from continuous time to discrete time steps, we limit the complexity (the number of stochastic evaluations scales with time and the number of states, instead of population size and the number of states). You may have also noticed that the individual steps in the Tau Leaping algorithm can be modeled as Poisson or Binomial random variables. Combining these two gives us another common algorithm for stochastic simulation, the Chain Binomial model. Here, we simplify further and use a time step that is equal to the infectious generation period; e.g.&nbsp;2 weeks for measles, or 1 week for flu. If we assume that time progresses in discrete, non-overlapping generations, then those that get infected at the start of one time step, recover at the end of that time step. This simplification means that we only have to model the infection process as stochastic, and the recovery process at the end of the time step is now deterministic. This is obviously unrealistic, but makes the model much simpler for formal statistical model fitting using likelihood and Bayesian methods. So while it is imperfect, it remains as a common method for “first-pass” analyses.</p>
<p>As before, we start with initial conditions. Here we initialize with the same population as before, but notice that the transmission rate, <span class="math inline">\(\beta\)</span> is different. Time is rescaled here to units of epidemic generation time, so <span class="math inline">\(\beta\)</span> is scaled correspondingly and now, for this formulation, <span class="math inline">\(\beta\)</span> is <span class="math inline">\(R_0\)</span>.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Recall that the basic reproduction number, <span class="math inline">\(R_0\)</span> is a function of the pathogen and the population of interest. In models, both the population (e.g.&nbsp;mixing, heterogeneity, etc) and the pathogen (e.g.&nbsp;time-scale of recovery) are represented using approximations to the biology. Here, the choice of model forces a change in time-scale which means that we have to change <span class="math inline">\(\beta\)</span> accordingly; thus, <span class="math inline">\(\beta\)</span>, which is ostensibly a biological parameter is also a property of the model.</p>
</div>
</div>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb20" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a><span class="do">####################################################################</span></span>
<span id="cb20-2"><a href="#cb20-2"></a><span class="co"># Parameters and initial conditions                                #</span></span>
<span id="cb20-3"><a href="#cb20-3"></a><span class="do">####################################################################</span></span>
<span id="cb20-4"><a href="#cb20-4"></a>S <span class="ot">&lt;-</span> <span class="dv">998</span> <span class="co"># number susceptible</span></span>
<span id="cb20-5"><a href="#cb20-5"></a>I <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co"># number infected</span></span>
<span id="cb20-6"><a href="#cb20-6"></a>R <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co"># number recovered</span></span>
<span id="cb20-7"><a href="#cb20-7"></a>time <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb20-8"><a href="#cb20-8"></a></span>
<span id="cb20-9"><a href="#cb20-9"></a>beta <span class="ot">&lt;-</span> <span class="fl">3.5</span> <span class="co"># transmission rate -- note the change in value</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>When we implement the forward simulation, we now only have to generate random draws for the infection process, which again simplifies the amount of stochastic simulation we have to do, and speeds up run times. While this might not be limiting in the scale of this activity, this DOES become an issue when we have to fit stochastic models. Recall from the lecture on parameter estimation that the basic recipe has us build a model and test out all, or many, values of the parameters (here <span class="math inline">\(\beta\)</span>) to find which one is closest to the data. Here, because each run of the stochastic simulation is different, we need to run simulations over many possible parameters, and for each parameter, we need to run many stochastic runs to characterize the average, or most likely, behavior. So, the number of simulations can rapidly increase into the millions (bigger for models with more parameters), so every bit of savings in computational time can be valuable.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb21" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a><span class="do">####################################################################</span></span>
<span id="cb21-2"><a href="#cb21-2"></a><span class="co"># Single time step                                                 #</span></span>
<span id="cb21-3"><a href="#cb21-3"></a><span class="do">####################################################################</span></span>
<span id="cb21-4"><a href="#cb21-4"></a>chain_binomial_step <span class="ot">&lt;-</span> <span class="cf">function</span>(sims, S, I, R, beta, ...) {</span>
<span id="cb21-5"><a href="#cb21-5"></a>  <span class="co"># S = initial susceptible population</span></span>
<span id="cb21-6"><a href="#cb21-6"></a>  <span class="co"># I = initial infected population</span></span>
<span id="cb21-7"><a href="#cb21-7"></a>  <span class="co"># R = initial recovered population</span></span>
<span id="cb21-8"><a href="#cb21-8"></a>  <span class="co"># beta is transmission rate</span></span>
<span id="cb21-9"><a href="#cb21-9"></a></span>
<span id="cb21-10"><a href="#cb21-10"></a>  <span class="co"># total population size</span></span>
<span id="cb21-11"><a href="#cb21-11"></a>  N <span class="ot">&lt;-</span> S <span class="sc">+</span> I <span class="sc">+</span> R</span>
<span id="cb21-12"><a href="#cb21-12"></a>  <span class="co"># this is the only stochastic step; only do draw if I &gt;0</span></span>
<span id="cb21-13"><a href="#cb21-13"></a>  new_i <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="at">n =</span> sims, <span class="fu">pmax</span>(S, <span class="dv">0</span>), <span class="dv">1</span> <span class="sc">-</span> <span class="fu">exp</span>(<span class="sc">-</span>beta <span class="sc">*</span> <span class="fu">pmax</span>(I, <span class="dv">0</span>) <span class="sc">/</span> N))</span>
<span id="cb21-14"><a href="#cb21-14"></a>  <span class="co"># this step is now deterministic, because everyone from the past time</span></span>
<span id="cb21-15"><a href="#cb21-15"></a>  <span class="co"># step recovers</span></span>
<span id="cb21-16"><a href="#cb21-16"></a>  new_s <span class="ot">&lt;-</span> S <span class="sc">-</span> new_i</span>
<span id="cb21-17"><a href="#cb21-17"></a>  new_r <span class="ot">&lt;-</span> R <span class="sc">+</span> I</span>
<span id="cb21-18"><a href="#cb21-18"></a></span>
<span id="cb21-19"><a href="#cb21-19"></a>  <span class="fu">cbind</span>(new_s, new_i, new_r)</span>
<span id="cb21-20"><a href="#cb21-20"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Then we can run the simulation over a set of discrete time steps, T. Note again that T is now the number of infectious generation times, since time is rescaled relative to the models above.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb22" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a><span class="do">####################################################################</span></span>
<span id="cb22-2"><a href="#cb22-2"></a><span class="co"># Run over many steps                                              #</span></span>
<span id="cb22-3"><a href="#cb22-3"></a><span class="do">####################################################################</span></span>
<span id="cb22-4"><a href="#cb22-4"></a></span>
<span id="cb22-5"><a href="#cb22-5"></a>max_time <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb22-6"><a href="#cb22-6"></a><span class="co"># note here that the time step is one infectious generation time,</span></span>
<span id="cb22-7"><a href="#cb22-7"></a><span class="co"># so 7 days from gamma above</span></span>
<span id="cb22-8"><a href="#cb22-8"></a>sims <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb22-9"><a href="#cb22-9"></a></span>
<span id="cb22-10"><a href="#cb22-10"></a>s_mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(S, <span class="dv">1</span>, sims) <span class="co"># storage item for S for all simulations</span></span>
<span id="cb22-11"><a href="#cb22-11"></a>i_mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(I, <span class="dv">1</span>, sims) <span class="co"># storage item for I for all simulations</span></span>
<span id="cb22-12"><a href="#cb22-12"></a>r_mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(R, <span class="dv">1</span>, sims) <span class="co"># storage item for R for all simulations</span></span>
<span id="cb22-13"><a href="#cb22-13"></a>n_mat <span class="ot">&lt;-</span> S <span class="sc">+</span> I <span class="sc">+</span> R</span>
<span id="cb22-14"><a href="#cb22-14"></a></span>
<span id="cb22-15"><a href="#cb22-15"></a><span class="cf">for</span> (time_step <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>max_time) {</span>
<span id="cb22-16"><a href="#cb22-16"></a>  out <span class="ot">&lt;-</span> <span class="fu">chain_binomial_step</span>(</span>
<span id="cb22-17"><a href="#cb22-17"></a>    sims,</span>
<span id="cb22-18"><a href="#cb22-18"></a>    s_mat[time_step <span class="sc">-</span> <span class="dv">1</span>, ],</span>
<span id="cb22-19"><a href="#cb22-19"></a>    i_mat[time_step <span class="sc">-</span> <span class="dv">1</span>, ],</span>
<span id="cb22-20"><a href="#cb22-20"></a>    r_mat[time_step <span class="sc">-</span> <span class="dv">1</span>, ],</span>
<span id="cb22-21"><a href="#cb22-21"></a>    beta</span>
<span id="cb22-22"><a href="#cb22-22"></a>  )</span>
<span id="cb22-23"><a href="#cb22-23"></a>  <span class="co"># update state</span></span>
<span id="cb22-24"><a href="#cb22-24"></a>  s_mat <span class="ot">&lt;-</span> <span class="fu">rbind</span>(s_mat, out[, <span class="dv">1</span>])</span>
<span id="cb22-25"><a href="#cb22-25"></a>  <span class="co"># update state</span></span>
<span id="cb22-26"><a href="#cb22-26"></a>  i_mat <span class="ot">&lt;-</span> <span class="fu">rbind</span>(i_mat, out[, <span class="dv">2</span>])</span>
<span id="cb22-27"><a href="#cb22-27"></a>  <span class="co"># update state</span></span>
<span id="cb22-28"><a href="#cb22-28"></a>  r_mat <span class="ot">&lt;-</span> <span class="fu">rbind</span>(r_mat, out[, <span class="dv">3</span>])</span>
<span id="cb22-29"><a href="#cb22-29"></a>  <span class="co"># update state -- note population size isn't changing, but this could be</span></span>
<span id="cb22-30"><a href="#cb22-30"></a>  <span class="co"># updated with births/deaths</span></span>
<span id="cb22-31"><a href="#cb22-31"></a>  n_mat <span class="ot">&lt;-</span> <span class="fu">rbind</span>(n_mat, out[, <span class="dv">1</span>] <span class="sc">+</span> out[, <span class="dv">2</span>] <span class="sc">+</span> out[, <span class="dv">3</span>])</span>
<span id="cb22-32"><a href="#cb22-32"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We can plot, but note again, that this is plotted in terms of epidemic generations on the X-axis, rather than days (as in the previous sections).</p>
<div class="cell page-columns page-full">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb23" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a><span class="co"># put output in a data frame</span></span>
<span id="cb23-2"><a href="#cb23-2"></a>bin_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb23-3"><a href="#cb23-3"></a>  <span class="at">S =</span> <span class="fu">array</span>(s_mat),</span>
<span id="cb23-4"><a href="#cb23-4"></a>  <span class="at">I =</span> <span class="fu">array</span>(i_mat),</span>
<span id="cb23-5"><a href="#cb23-5"></a>  <span class="at">R =</span> <span class="fu">array</span>(r_mat),</span>
<span id="cb23-6"><a href="#cb23-6"></a>  <span class="at">N =</span> <span class="fu">array</span>(<span class="fu">matrix</span>(n_mat)),</span>
<span id="cb23-7"><a href="#cb23-7"></a>  <span class="at">time =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>max_time, sims),</span>
<span id="cb23-8"><a href="#cb23-8"></a>  <span class="at">iteration =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>sims, <span class="at">each =</span> max_time)</span>
<span id="cb23-9"><a href="#cb23-9"></a>)</span>
<span id="cb23-10"><a href="#cb23-10"></a></span>
<span id="cb23-11"><a href="#cb23-11"></a>bin_df <span class="ot">&lt;-</span> bin_df <span class="sc">%&gt;%</span></span>
<span id="cb23-12"><a href="#cb23-12"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb23-13"><a href="#cb23-13"></a>    <span class="co"># Don't pivot the time column</span></span>
<span id="cb23-14"><a href="#cb23-14"></a>    <span class="at">cols =</span> <span class="sc">-</span><span class="fu">c</span>(time, iteration),</span>
<span id="cb23-15"><a href="#cb23-15"></a>    <span class="at">names_to =</span> <span class="st">"state"</span>,</span>
<span id="cb23-16"><a href="#cb23-16"></a>    <span class="at">values_to =</span> <span class="st">"number"</span></span>
<span id="cb23-17"><a href="#cb23-17"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb23-18"><a href="#cb23-18"></a>  <span class="fu">mutate</span>(<span class="at">state =</span> <span class="fu">factor</span>(state, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"S"</span>, <span class="st">"I"</span>, <span class="st">"R"</span>, <span class="st">"N"</span>)))</span>
<span id="cb23-19"><a href="#cb23-19"></a></span>
<span id="cb23-20"><a href="#cb23-20"></a><span class="co"># fix this color</span></span>
<span id="cb23-21"><a href="#cb23-21"></a>sir_colors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">S =</span> <span class="st">"#1f77b4"</span>, <span class="at">I =</span> <span class="st">"#ff7f0e"</span>, <span class="at">R =</span> <span class="st">"#FF3851"</span>)</span>
<span id="cb23-22"><a href="#cb23-22"></a></span>
<span id="cb23-23"><a href="#cb23-23"></a>bin_df <span class="sc">%&gt;%</span></span>
<span id="cb23-24"><a href="#cb23-24"></a>  <span class="fu">mutate</span>(<span class="at">iteration =</span> <span class="fu">as.factor</span>(iteration)) <span class="sc">%&gt;%</span></span>
<span id="cb23-25"><a href="#cb23-25"></a>  <span class="fu">filter</span>(state <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"S"</span>, <span class="st">"I"</span>, <span class="st">"R"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb23-26"><a href="#cb23-26"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb23-27"><a href="#cb23-27"></a>    <span class="at">x =</span> time,</span>
<span id="cb23-28"><a href="#cb23-28"></a>    <span class="at">y =</span> number,</span>
<span id="cb23-29"><a href="#cb23-29"></a>    <span class="at">group =</span> <span class="fu">interaction</span>(iteration, state),</span>
<span id="cb23-30"><a href="#cb23-30"></a>    <span class="at">color =</span> state</span>
<span id="cb23-31"><a href="#cb23-31"></a>  )) <span class="sc">+</span></span>
<span id="cb23-32"><a href="#cb23-32"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.5</span>, <span class="at">alpha =</span> .<span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb23-33"><a href="#cb23-33"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> sir_colors) <span class="sc">+</span></span>
<span id="cb23-34"><a href="#cb23-34"></a>  <span class="fu">labs</span>(</span>
<span id="cb23-35"><a href="#cb23-35"></a>    <span class="at">x =</span> <span class="st">"Time"</span>,</span>
<span id="cb23-36"><a href="#cb23-36"></a>    <span class="at">y =</span> <span class="st">"Number"</span>,</span>
<span id="cb23-37"><a href="#cb23-37"></a>    <span class="at">color =</span> <span class="st">"State"</span></span>
<span id="cb23-38"><a href="#cb23-38"></a>  ) <span class="sc">+</span></span>
<span id="cb23-39"><a href="#cb23-39"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">alpha =</span> <span class="dv">1</span>))) <span class="sc">+</span></span>
<span id="cb23-40"><a href="#cb23-40"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display page-columns page-full">
<div class="page-columns page-full">
<figure class="figure page-columns page-full"><p class="page-columns page-full"><img src="r-session-04_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid figure-img column-body" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>


<!-- -->

</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./L08_stochastic-models.html" class="pagination-link" aria-label="Stochastic Models">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Stochastic Models</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./references.html" class="pagination-link" aria-label="**References**">
        <span class="nav-page-text"><strong>References</strong></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb24" data-shortcodes="false" data-code-line-numbers=""><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb24-1"><a href="#cb24-1"></a><span class="co">---</span></span>
<span id="cb24-2"><a href="#cb24-2"></a><span class="an">subtitle:</span><span class="co"> "Stochastic SIR models"</span></span>
<span id="cb24-3"><a href="#cb24-3"></a><span class="an">abstract-title:</span><span class="co"> ""</span></span>
<span id="cb24-4"><a href="#cb24-4"></a><span class="an">abstract:</span><span class="co"> |</span></span>
<span id="cb24-5"><a href="#cb24-5"></a><span class="co">    *review of basic algorithms for stochastic epidemic models*</span></span>
<span id="cb24-6"><a href="#cb24-6"></a><span class="an">execute:</span></span>
<span id="cb24-7"><a href="#cb24-7"></a><span class="co">    warning: false</span></span>
<span id="cb24-8"><a href="#cb24-8"></a><span class="an">metadata-files:</span></span>
<span id="cb24-9"><a href="#cb24-9"></a><span class="co">    - metadata/matthewferrari.yml</span></span>
<span id="cb24-10"><a href="#cb24-10"></a><span class="co">    - metadata/mathjax-packages.yml</span></span>
<span id="cb24-11"><a href="#cb24-11"></a><span class="an">editor:</span></span>
<span id="cb24-12"><a href="#cb24-12"></a><span class="co">  markdown:</span></span>
<span id="cb24-13"><a href="#cb24-13"></a><span class="co">    wrap: sentence</span></span>
<span id="cb24-14"><a href="#cb24-14"></a><span class="co">---</span></span>
<span id="cb24-15"><a href="#cb24-15"></a></span>
<span id="cb24-16"><a href="#cb24-16"></a><span class="fu"># R Session 04</span></span>
<span id="cb24-17"><a href="#cb24-17"></a></span>
<span id="cb24-18"><a href="#cb24-18"></a>:::{.callout-warning}</span>
<span id="cb24-19"><a href="#cb24-19"></a>This session is under active development and is subject to change.</span>
<span id="cb24-20"><a href="#cb24-20"></a>:::</span>
<span id="cb24-21"><a href="#cb24-21"></a></span>
<span id="cb24-22"><a href="#cb24-22"></a><span class="fu">## Setup</span></span>
<span id="cb24-23"><a href="#cb24-23"></a></span>
<span id="cb24-26"><a href="#cb24-26"></a><span class="in">```{r}</span></span>
<span id="cb24-27"><a href="#cb24-27"></a><span class="fu">library</span>(here)</span>
<span id="cb24-28"><a href="#cb24-28"></a><span class="fu">library</span>(rio)</span>
<span id="cb24-29"><a href="#cb24-29"></a><span class="fu">library</span>(deSolve)</span>
<span id="cb24-30"><a href="#cb24-30"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb24-31"><a href="#cb24-31"></a><span class="in">```</span></span>
<span id="cb24-32"><a href="#cb24-32"></a></span>
<span id="cb24-35"><a href="#cb24-35"></a><span class="in">```{r}</span></span>
<span id="cb24-36"><a href="#cb24-36"></a><span class="fu">theme_set</span>(<span class="fu">theme_minimal</span>())</span>
<span id="cb24-37"><a href="#cb24-37"></a><span class="in">```</span></span>
<span id="cb24-38"><a href="#cb24-38"></a></span>
<span id="cb24-39"><a href="#cb24-39"></a>:::callout-note</span>
<span id="cb24-40"><a href="#cb24-40"></a>This R-session will go in parallel with the lecture on stochastic algorithms.</span>
<span id="cb24-41"><a href="#cb24-41"></a>First we'll go through the basics of each algorithm in the lecture and then we'll walk through the code and you can implement it for yourselves.</span>
<span id="cb24-42"><a href="#cb24-42"></a>:::</span>
<span id="cb24-43"><a href="#cb24-43"></a></span>
<span id="cb24-44"><a href="#cb24-44"></a><span class="fu">## What is stochasticity and where does it come from?</span></span>
<span id="cb24-45"><a href="#cb24-45"></a></span>
<span id="cb24-46"><a href="#cb24-46"></a>Much of the world is uncertain (i.e. we don't know exactly how things work, what values are, or what tomorrow will hold).</span>
<span id="cb24-47"><a href="#cb24-47"></a>Some of that uncertainty is, at least theoretically, knowable and some is not.</span>
<span id="cb24-48"><a href="#cb24-48"></a>For example, in our discussion of estimating $R_0$, there may be a very real $R_0$ for a given population and pathogen, even if we don't know it.</span>
<span id="cb24-49"><a href="#cb24-49"></a>Thus, our estimate of $R_0$ may be "uncertain" (e.g. has a confidence interval around it, reflecting our certainty), but the models we've been developing so far are "deterministic", so conditional on a given value of $R_0$ the resulting epidemic curve is exactly specified by the model.</span>
<span id="cb24-50"><a href="#cb24-50"></a>If we return to the code from R-session 1, we can plot a single deterministic realization of a model with $R_0 = 1.8$.</span>
<span id="cb24-51"><a href="#cb24-51"></a></span>
<span id="cb24-54"><a href="#cb24-54"></a><span class="in">```{r}</span></span>
<span id="cb24-55"><a href="#cb24-55"></a>sir_model <span class="ot">&lt;-</span> <span class="cf">function</span>(time, state, params, ...) {</span>
<span id="cb24-56"><a href="#cb24-56"></a>  transmission <span class="ot">&lt;-</span> params[<span class="st">"transmission"</span>]</span>
<span id="cb24-57"><a href="#cb24-57"></a>  recovery <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> params[<span class="st">"duration"</span>]</span>
<span id="cb24-58"><a href="#cb24-58"></a></span>
<span id="cb24-59"><a href="#cb24-59"></a>  S <span class="ot">&lt;-</span> state[<span class="st">"S"</span>]</span>
<span id="cb24-60"><a href="#cb24-60"></a>  I <span class="ot">&lt;-</span> state[<span class="st">"I"</span>]</span>
<span id="cb24-61"><a href="#cb24-61"></a>  R <span class="ot">&lt;-</span> state[<span class="st">"R"</span>]</span>
<span id="cb24-62"><a href="#cb24-62"></a></span>
<span id="cb24-63"><a href="#cb24-63"></a>  dSdt <span class="ot">&lt;-</span> <span class="sc">-</span>transmission <span class="sc">*</span> S <span class="sc">*</span> I</span>
<span id="cb24-64"><a href="#cb24-64"></a>  dIdt <span class="ot">&lt;-</span> (transmission <span class="sc">*</span> S <span class="sc">*</span> I) <span class="sc">-</span> (recovery <span class="sc">*</span> I)</span>
<span id="cb24-65"><a href="#cb24-65"></a>  dRdt <span class="ot">&lt;-</span> recovery <span class="sc">*</span> I</span>
<span id="cb24-66"><a href="#cb24-66"></a></span>
<span id="cb24-67"><a href="#cb24-67"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="fu">c</span>(dSdt, dIdt, dRdt)))</span>
<span id="cb24-68"><a href="#cb24-68"></a>}</span>
<span id="cb24-69"><a href="#cb24-69"></a><span class="in">```</span></span>
<span id="cb24-70"><a href="#cb24-70"></a></span>
<span id="cb24-73"><a href="#cb24-73"></a><span class="in">```{r}</span></span>
<span id="cb24-74"><a href="#cb24-74"></a>sir_params <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">transmission =</span> <span class="fl">0.3</span>, <span class="at">duration =</span> <span class="dv">6</span>)</span>
<span id="cb24-75"><a href="#cb24-75"></a>sir_init_states <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">S =</span> <span class="fl">0.99</span>, <span class="at">I =</span> <span class="fl">0.01</span>, <span class="at">R =</span> <span class="dv">0</span>)</span>
<span id="cb24-76"><a href="#cb24-76"></a>sim_times <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">200</span>, <span class="at">by =</span> <span class="fl">0.1</span>)</span>
<span id="cb24-77"><a href="#cb24-77"></a></span>
<span id="cb24-78"><a href="#cb24-78"></a>sir_sol <span class="ot">&lt;-</span> <span class="fu">ode</span>(</span>
<span id="cb24-79"><a href="#cb24-79"></a>  <span class="at">y =</span> sir_init_states,</span>
<span id="cb24-80"><a href="#cb24-80"></a>  <span class="at">times =</span> sim_times,</span>
<span id="cb24-81"><a href="#cb24-81"></a>  <span class="at">func =</span> sir_model,</span>
<span id="cb24-82"><a href="#cb24-82"></a>  <span class="at">parms =</span> sir_params</span>
<span id="cb24-83"><a href="#cb24-83"></a>)</span>
<span id="cb24-84"><a href="#cb24-84"></a><span class="in">```</span></span>
<span id="cb24-85"><a href="#cb24-85"></a></span>
<span id="cb24-88"><a href="#cb24-88"></a><span class="in">```{r}</span></span>
<span id="cb24-89"><a href="#cb24-89"></a><span class="co">#| out-width: 100%</span></span>
<span id="cb24-90"><a href="#cb24-90"></a><span class="co">#| column: body</span></span>
<span id="cb24-91"><a href="#cb24-91"></a></span>
<span id="cb24-92"><a href="#cb24-92"></a><span class="co"># Turn the output from the ODE solver into a tibble (dataframe)</span></span>
<span id="cb24-93"><a href="#cb24-93"></a><span class="co"># so we can manipulate and plot it easily</span></span>
<span id="cb24-94"><a href="#cb24-94"></a>sir_sol_df <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(sir_sol) <span class="sc">%&gt;%</span></span>
<span id="cb24-95"><a href="#cb24-95"></a>  <span class="co"># Convert all columns to numeric (they are currently type</span></span>
<span id="cb24-96"><a href="#cb24-96"></a>  <span class="co"># deSolve so will produce warnings when plotting etc)</span></span>
<span id="cb24-97"><a href="#cb24-97"></a>  <span class="fu">mutate</span>(</span>
<span id="cb24-98"><a href="#cb24-98"></a>    <span class="co"># Rather than repeatedly type the same function for every</span></span>
<span id="cb24-99"><a href="#cb24-99"></a>    <span class="co"># column, use the across() function to apply the function</span></span>
<span id="cb24-100"><a href="#cb24-100"></a>    <span class="co"># to a selection of columns</span></span>
<span id="cb24-101"><a href="#cb24-101"></a>    <span class="fu">across</span>(</span>
<span id="cb24-102"><a href="#cb24-102"></a>      <span class="co"># The cols argument takes a selection of columns to apply</span></span>
<span id="cb24-103"><a href="#cb24-103"></a>      <span class="co"># a function to. Here, we want to apply the as.numeric()</span></span>
<span id="cb24-104"><a href="#cb24-104"></a>      <span class="co"># function to all columns, so we use the function</span></span>
<span id="cb24-105"><a href="#cb24-105"></a>      <span class="co"># everything() to select all columns.</span></span>
<span id="cb24-106"><a href="#cb24-106"></a>      <span class="at">.cols =</span> <span class="fu">everything</span>(),</span>
<span id="cb24-107"><a href="#cb24-107"></a>      <span class="at">.fns =</span> as.numeric</span>
<span id="cb24-108"><a href="#cb24-108"></a>    )</span>
<span id="cb24-109"><a href="#cb24-109"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb24-110"><a href="#cb24-110"></a>  <span class="co"># Convert the dataframe from wide to long format, so we have a</span></span>
<span id="cb24-111"><a href="#cb24-111"></a>  <span class="co"># column for the time, a column for the state, and a column</span></span>
<span id="cb24-112"><a href="#cb24-112"></a>  <span class="co"># for the proportion of the population in that state at that</span></span>
<span id="cb24-113"><a href="#cb24-113"></a>  <span class="co"># time</span></span>
<span id="cb24-114"><a href="#cb24-114"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb24-115"><a href="#cb24-115"></a>    <span class="co"># Don't pivot the time column</span></span>
<span id="cb24-116"><a href="#cb24-116"></a>    <span class="at">cols =</span> <span class="sc">-</span>time,</span>
<span id="cb24-117"><a href="#cb24-117"></a>    <span class="at">names_to =</span> <span class="st">"state"</span>,</span>
<span id="cb24-118"><a href="#cb24-118"></a>    <span class="at">values_to =</span> <span class="st">"proportion"</span></span>
<span id="cb24-119"><a href="#cb24-119"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb24-120"><a href="#cb24-120"></a>  <span class="co"># Update the state column to be a factor, so the plot will</span></span>
<span id="cb24-121"><a href="#cb24-121"></a>  <span class="co"># show the states in the correct order</span></span>
<span id="cb24-122"><a href="#cb24-122"></a>  <span class="fu">mutate</span>(<span class="at">state =</span> <span class="fu">factor</span>(state, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"S"</span>, <span class="st">"I"</span>, <span class="st">"R"</span>)))</span>
<span id="cb24-123"><a href="#cb24-123"></a></span>
<span id="cb24-124"><a href="#cb24-124"></a>sir_colors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">S =</span> <span class="st">"#1f77b4"</span>, <span class="at">I =</span> <span class="st">"#ff7f0e"</span>, <span class="at">R =</span> <span class="st">"#FF3851"</span>)</span>
<span id="cb24-125"><a href="#cb24-125"></a></span>
<span id="cb24-126"><a href="#cb24-126"></a><span class="fu">ggplot</span>(sir_sol_df, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> proportion, <span class="at">color =</span> state)) <span class="sc">+</span></span>
<span id="cb24-127"><a href="#cb24-127"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb24-128"><a href="#cb24-128"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> sir_colors) <span class="sc">+</span></span>
<span id="cb24-129"><a href="#cb24-129"></a>  <span class="fu">labs</span>(</span>
<span id="cb24-130"><a href="#cb24-130"></a>    <span class="at">x =</span> <span class="st">"Time"</span>,</span>
<span id="cb24-131"><a href="#cb24-131"></a>    <span class="at">y =</span> <span class="st">"Fraction"</span>,</span>
<span id="cb24-132"><a href="#cb24-132"></a>    <span class="at">color =</span> <span class="st">"State"</span></span>
<span id="cb24-133"><a href="#cb24-133"></a>  ) <span class="sc">+</span></span>
<span id="cb24-134"><a href="#cb24-134"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span>
<span id="cb24-135"><a href="#cb24-135"></a><span class="in">```</span></span>
<span id="cb24-136"><a href="#cb24-136"></a></span>
<span id="cb24-137"><a href="#cb24-137"></a>Now, perhaps we used the tools from R-session 3 to estimate $R_0$ and we think a reasonable $95\%$ confidence interval for $R_0$ is $(1.7,1.9)$.</span>
<span id="cb24-138"><a href="#cb24-138"></a>If we're quite certain the duration of infection is 6 days, then that means our corresponding confidence interval on the transmission rate is $(.283,.317)$.</span>
<span id="cb24-139"><a href="#cb24-139"></a>An entirely reasonable way to represent this uncertainty in the estimate of the transmission rate is to generate many random draws from within the confidence interval for the transmission rate and examine the resulting epidemic curves.</span>
<span id="cb24-140"><a href="#cb24-140"></a>For this we can modify the code above with a loop that does this multiple times.</span>
<span id="cb24-141"><a href="#cb24-141"></a></span>
<span id="cb24-144"><a href="#cb24-144"></a><span class="in">```{r}</span></span>
<span id="cb24-145"><a href="#cb24-145"></a><span class="co"># the number of times we want to do this.</span></span>
<span id="cb24-146"><a href="#cb24-146"></a><span class="co"># This is a matter of choice and computational capacity</span></span>
<span id="cb24-147"><a href="#cb24-147"></a><span class="co"># (this model is small and quick, but that won't always be the case)</span></span>
<span id="cb24-148"><a href="#cb24-148"></a>num_iterations <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb24-149"><a href="#cb24-149"></a></span>
<span id="cb24-150"><a href="#cb24-150"></a><span class="co"># since we're going to do this num_iterations times we need a place</span></span>
<span id="cb24-151"><a href="#cb24-151"></a><span class="co"># to store the results</span></span>
<span id="cb24-152"><a href="#cb24-152"></a></span>
<span id="cb24-153"><a href="#cb24-153"></a><span class="cf">for</span> (iter <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>num_iterations) {</span>
<span id="cb24-154"><a href="#cb24-154"></a>  <span class="co"># each time take a random draw of the transmission rate from the</span></span>
<span id="cb24-155"><a href="#cb24-155"></a>  <span class="co"># confidence interval</span></span>
<span id="cb24-156"><a href="#cb24-156"></a>  sir_params <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">transmission =</span> <span class="fu">runif</span>(<span class="dv">1</span>, .<span class="dv">283</span>, .<span class="dv">317</span>), <span class="at">duration =</span> <span class="dv">6</span>)</span>
<span id="cb24-157"><a href="#cb24-157"></a>  sir_init_states <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">S =</span> <span class="fl">0.99</span>, <span class="at">I =</span> <span class="fl">0.01</span>, <span class="at">R =</span> <span class="dv">0</span>)</span>
<span id="cb24-158"><a href="#cb24-158"></a>  sim_times <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">200</span>, <span class="at">by =</span> <span class="fl">0.1</span>)</span>
<span id="cb24-159"><a href="#cb24-159"></a></span>
<span id="cb24-160"><a href="#cb24-160"></a>  sir_sol <span class="ot">&lt;-</span> <span class="fu">ode</span>(</span>
<span id="cb24-161"><a href="#cb24-161"></a>    <span class="at">y =</span> sir_init_states,</span>
<span id="cb24-162"><a href="#cb24-162"></a>    <span class="at">times =</span> sim_times,</span>
<span id="cb24-163"><a href="#cb24-163"></a>    <span class="at">func =</span> sir_model,</span>
<span id="cb24-164"><a href="#cb24-164"></a>    <span class="at">parms =</span> sir_params</span>
<span id="cb24-165"><a href="#cb24-165"></a>  )</span>
<span id="cb24-166"><a href="#cb24-166"></a>  sir_sol <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(sir_sol)</span>
<span id="cb24-167"><a href="#cb24-167"></a>  <span class="co"># mark this as the iter iteration of the loop</span></span>
<span id="cb24-168"><a href="#cb24-168"></a>  sir_sol<span class="sc">$</span>iteration <span class="ot">&lt;-</span> iter</span>
<span id="cb24-169"><a href="#cb24-169"></a>  <span class="co"># if this is the first iteration, create a place to store the output</span></span>
<span id="cb24-170"><a href="#cb24-170"></a>  <span class="co"># if it's the second or higher, append the output to the storage</span></span>
<span id="cb24-171"><a href="#cb24-171"></a>  <span class="cf">if</span> (iter <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb24-172"><a href="#cb24-172"></a>    sir_sol_storage <span class="ot">&lt;-</span> sir_sol</span>
<span id="cb24-173"><a href="#cb24-173"></a>  }</span>
<span id="cb24-174"><a href="#cb24-174"></a>  <span class="cf">if</span> (iter <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb24-175"><a href="#cb24-175"></a>    sir_sol_storage <span class="ot">&lt;-</span> <span class="fu">rbind</span>(sir_sol_storage, sir_sol)</span>
<span id="cb24-176"><a href="#cb24-176"></a>  }</span>
<span id="cb24-177"><a href="#cb24-177"></a>}</span>
<span id="cb24-178"><a href="#cb24-178"></a><span class="in">```</span></span>
<span id="cb24-179"><a href="#cb24-179"></a></span>
<span id="cb24-182"><a href="#cb24-182"></a><span class="in">```{r}</span></span>
<span id="cb24-183"><a href="#cb24-183"></a><span class="co">#| out-width: 100%</span></span>
<span id="cb24-184"><a href="#cb24-184"></a><span class="co">#| column: body</span></span>
<span id="cb24-185"><a href="#cb24-185"></a></span>
<span id="cb24-186"><a href="#cb24-186"></a><span class="co"># Turn the output from the ODE solver into a tibble (dataframe)</span></span>
<span id="cb24-187"><a href="#cb24-187"></a><span class="co"># so we can manipulate and plot it easily</span></span>
<span id="cb24-188"><a href="#cb24-188"></a>sir_sol_df <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(sir_sol_storage) <span class="sc">%&gt;%</span></span>
<span id="cb24-189"><a href="#cb24-189"></a>  <span class="co"># Convert all columns to numeric (they are currently type deSolve</span></span>
<span id="cb24-190"><a href="#cb24-190"></a>  <span class="co"># so will produce warnings when plotting etc)</span></span>
<span id="cb24-191"><a href="#cb24-191"></a>  <span class="fu">mutate</span>(</span>
<span id="cb24-192"><a href="#cb24-192"></a>    <span class="co"># Rather than repeatedly type the same function for every column,</span></span>
<span id="cb24-193"><a href="#cb24-193"></a>    <span class="co"># use the across() function to apply the function to a selection</span></span>
<span id="cb24-194"><a href="#cb24-194"></a>    <span class="co"># of columns</span></span>
<span id="cb24-195"><a href="#cb24-195"></a>    <span class="fu">across</span>(</span>
<span id="cb24-196"><a href="#cb24-196"></a>      <span class="co"># The cols argument takes a selection of columns to apply</span></span>
<span id="cb24-197"><a href="#cb24-197"></a>      <span class="co"># a function to. Here, we want to apply the as.numeric()</span></span>
<span id="cb24-198"><a href="#cb24-198"></a>      <span class="co"># function to all columns, so we use the function</span></span>
<span id="cb24-199"><a href="#cb24-199"></a>      <span class="co"># everything() to select all columns.</span></span>
<span id="cb24-200"><a href="#cb24-200"></a>      <span class="at">.cols =</span> <span class="fu">everything</span>(),</span>
<span id="cb24-201"><a href="#cb24-201"></a>      <span class="at">.fns =</span> as.numeric</span>
<span id="cb24-202"><a href="#cb24-202"></a>    )</span>
<span id="cb24-203"><a href="#cb24-203"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb24-204"><a href="#cb24-204"></a>  <span class="co"># Convert the dataframe from wide to long format, so we have a</span></span>
<span id="cb24-205"><a href="#cb24-205"></a>  <span class="co"># column for the time, a column for the state, and a column</span></span>
<span id="cb24-206"><a href="#cb24-206"></a>  <span class="co"># for the proportion of the population in that state at that</span></span>
<span id="cb24-207"><a href="#cb24-207"></a>  <span class="co"># time</span></span>
<span id="cb24-208"><a href="#cb24-208"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb24-209"><a href="#cb24-209"></a>    <span class="co"># Don't pivot the time column</span></span>
<span id="cb24-210"><a href="#cb24-210"></a>    <span class="at">cols =</span> <span class="sc">-</span><span class="fu">c</span>(time, iteration),</span>
<span id="cb24-211"><a href="#cb24-211"></a>    <span class="at">names_to =</span> <span class="st">"state"</span>,</span>
<span id="cb24-212"><a href="#cb24-212"></a>    <span class="at">values_to =</span> <span class="st">"proportion"</span></span>
<span id="cb24-213"><a href="#cb24-213"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb24-214"><a href="#cb24-214"></a>  <span class="co"># Update the state column to be a factor, so the plot will</span></span>
<span id="cb24-215"><a href="#cb24-215"></a>  <span class="co"># show the states in the correct order</span></span>
<span id="cb24-216"><a href="#cb24-216"></a>  <span class="fu">mutate</span>(<span class="at">state =</span> <span class="fu">factor</span>(state, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"S"</span>, <span class="st">"I"</span>, <span class="st">"R"</span>)))</span>
<span id="cb24-217"><a href="#cb24-217"></a></span>
<span id="cb24-218"><a href="#cb24-218"></a>sir_colors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">S =</span> <span class="st">"#1f77b4"</span>, <span class="at">I =</span> <span class="st">"#ff7f0e"</span>, <span class="at">R =</span> <span class="st">"#FF3851"</span>)</span>
<span id="cb24-219"><a href="#cb24-219"></a></span>
<span id="cb24-220"><a href="#cb24-220"></a><span class="fu">ggplot</span>(</span>
<span id="cb24-221"><a href="#cb24-221"></a>  sir_sol_df,</span>
<span id="cb24-222"><a href="#cb24-222"></a>  <span class="fu">aes</span>(</span>
<span id="cb24-223"><a href="#cb24-223"></a>    <span class="at">x =</span> time,</span>
<span id="cb24-224"><a href="#cb24-224"></a>    <span class="at">y =</span> proportion,</span>
<span id="cb24-225"><a href="#cb24-225"></a>    <span class="at">color =</span> state,</span>
<span id="cb24-226"><a href="#cb24-226"></a>    <span class="at">group =</span> <span class="fu">interaction</span>(iteration, state)</span>
<span id="cb24-227"><a href="#cb24-227"></a>  )</span>
<span id="cb24-228"><a href="#cb24-228"></a>) <span class="sc">+</span></span>
<span id="cb24-229"><a href="#cb24-229"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.5</span>, <span class="at">alpha =</span> .<span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb24-230"><a href="#cb24-230"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> sir_colors) <span class="sc">+</span></span>
<span id="cb24-231"><a href="#cb24-231"></a>  <span class="fu">labs</span>(</span>
<span id="cb24-232"><a href="#cb24-232"></a>    <span class="at">x =</span> <span class="st">"Time"</span>,</span>
<span id="cb24-233"><a href="#cb24-233"></a>    <span class="at">y =</span> <span class="st">"Fraction"</span>,</span>
<span id="cb24-234"><a href="#cb24-234"></a>    <span class="at">color =</span> <span class="st">"State"</span></span>
<span id="cb24-235"><a href="#cb24-235"></a>  ) <span class="sc">+</span></span>
<span id="cb24-236"><a href="#cb24-236"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">alpha =</span> <span class="dv">1</span>))) <span class="sc">+</span></span>
<span id="cb24-237"><a href="#cb24-237"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span>
<span id="cb24-238"><a href="#cb24-238"></a><span class="in">```</span></span>
<span id="cb24-239"><a href="#cb24-239"></a></span>
<span id="cb24-240"><a href="#cb24-240"></a>Here note that we are still using our original code for the SIR model, so first we randomly draw the transmission rate, then conditional on that value, we run the deterministic model.</span>
<span id="cb24-241"><a href="#cb24-241"></a>Note that each run of the model still has the smooth curves, but each draw is a different set of smooth curves.</span>
<span id="cb24-242"><a href="#cb24-242"></a></span>
<span id="cb24-243"><a href="#cb24-243"></a>There are lots of ways you could extend this. Note that since we are drawing the transmission rate and fixing the duration of infection, the $R_0$ is slightly different in each simulation.</span>
<span id="cb24-244"><a href="#cb24-244"></a>You could make each run have the same $R_0$ by recalculating the duration of infection based on the random draw of transmission rate; e.g. $R_0=1.8 = 0.29 * L$ means that $L=5.5$, so to ensure $R_0$ is the same in each run, you would need to change $L$ for each random draw.</span>
<span id="cb24-245"><a href="#cb24-245"></a>Alternatively, you might have uncertainty about \emph{both} transmission and duration, so could for e.g. make random draws for both (which would again give a setting where $R_0$ varies from run to run).</span>
<span id="cb24-246"><a href="#cb24-246"></a>None of these are more correct than another, the use case depends on which elements $R_0$, transmission, duration of infection, you are uncertain about.</span>
<span id="cb24-247"><a href="#cb24-247"></a></span>
<span id="cb24-248"><a href="#cb24-248"></a>In each of the above, the model is \emph{deterministic}, meaning that for a given set of parameters, the resulting outbreak trajectory is always the same. For a \emph{stochastic} model, each run of the model will vary, even if the parameters are the same.</span>
<span id="cb24-249"><a href="#cb24-249"></a>This is because each event that occurs (e.g. someone getting infected or recovering) is analogous to a coin flip; even though the rules of the coin (the parameters) are always the same, the side it lands on is random.</span>
<span id="cb24-250"><a href="#cb24-250"></a>Unlike a deterministic model, to fully understand the behavior of a stochastic model, you need to run it more than one time, often many times, so these are necessarily more time consuming to work with.</span>
<span id="cb24-251"><a href="#cb24-251"></a></span>
<span id="cb24-252"><a href="#cb24-252"></a>There are many, many ways to make stochastic models and the steps can be way more complicated than flipping coins.</span>
<span id="cb24-253"><a href="#cb24-253"></a>But there some foundational versions of these models that illustrate the trade-offs between exact representations of the random processes we think are happening and the computational time it takes to generate outputs. For what we'll do here, everything will be kind of fast, but in practice, for models of realistic scale, even a single stochastic run can take a while. And if you have to do thousands of runs, even shaving a few seconds or minutes can be important.</span>
<span id="cb24-254"><a href="#cb24-254"></a></span>
<span id="cb24-255"><a href="#cb24-255"></a><span class="fu">## The Gillespie Algorithm</span></span>
<span id="cb24-256"><a href="#cb24-256"></a></span>
<span id="cb24-257"><a href="#cb24-257"></a>The Gillespie algorithm is the most explicit translation of the ODE form of the SIR model into a stochastic model.</span>
<span id="cb24-258"><a href="#cb24-258"></a>It achieves this by noting that ODE-based models are written in terms of the rates at which events occur.</span>
<span id="cb24-259"><a href="#cb24-259"></a>At any given point in time, the rate of all events in the ODE is known; what \textbf{isn't} known, is which of the possible events will happen first.</span>
<span id="cb24-260"><a href="#cb24-260"></a>Note that even though we expect that the next thing to happen will be the thing that happens with the highest rate, it's possible that another thing may happen first by random chance.</span>
<span id="cb24-261"><a href="#cb24-261"></a>And then, since the rates in the SIR model are dependent on the value of the states (e.g. new infections depend on $\beta$ and S and I) any change in the states then changes the rates and the likelihood of what will happen next.</span>
<span id="cb24-262"><a href="#cb24-262"></a></span>
<span id="cb24-263"><a href="#cb24-263"></a>The Gillespie algorithm proceeds by 1) calculating all the current rates, 2) randomly drawing exponential random variables that equate to the time until each event happens (recall we talked about the relationship between rate and time in the lectures), then 3) comparing those times and assuming that the next event to occur is the one that had the smallest randomly drawn time.</span>
<span id="cb24-264"><a href="#cb24-264"></a>Then you increment the states; e.g. an infection increases I by 1, reduces S by 1, and doesn't change R.</span>
<span id="cb24-265"><a href="#cb24-265"></a>Importantly, you then increment time forward by a step equal to the time until first event occurred.</span>
<span id="cb24-266"><a href="#cb24-266"></a>Then you recalculate the rates and randomly draw times, etc, and keep doing this over and over again.</span>
<span id="cb24-267"><a href="#cb24-267"></a>For this SIR model, that keeps happening until you run out of infected individuals and there are no new events that can happen.</span>
<span id="cb24-268"><a href="#cb24-268"></a></span>
<span id="cb24-271"><a href="#cb24-271"></a><span class="in">```{r}</span></span>
<span id="cb24-272"><a href="#cb24-272"></a><span class="do">####################################################################</span></span>
<span id="cb24-273"><a href="#cb24-273"></a><span class="co"># Parameters and initial conditions                                #</span></span>
<span id="cb24-274"><a href="#cb24-274"></a><span class="do">####################################################################</span></span>
<span id="cb24-275"><a href="#cb24-275"></a></span>
<span id="cb24-276"><a href="#cb24-276"></a>S <span class="ot">&lt;-</span> <span class="dv">998</span> <span class="co"># number susceptible</span></span>
<span id="cb24-277"><a href="#cb24-277"></a>I <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co"># number infected</span></span>
<span id="cb24-278"><a href="#cb24-278"></a>R <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co"># number recovered</span></span>
<span id="cb24-279"><a href="#cb24-279"></a>time <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb24-280"><a href="#cb24-280"></a></span>
<span id="cb24-281"><a href="#cb24-281"></a>beta <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="co"># transmission rate</span></span>
<span id="cb24-282"><a href="#cb24-282"></a>gamma <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">7</span> <span class="co"># recovery rate</span></span>
<span id="cb24-283"><a href="#cb24-283"></a><span class="in">```</span></span>
<span id="cb24-284"><a href="#cb24-284"></a></span>
<span id="cb24-287"><a href="#cb24-287"></a><span class="in">```{r}</span></span>
<span id="cb24-288"><a href="#cb24-288"></a><span class="do">####################################################################</span></span>
<span id="cb24-289"><a href="#cb24-289"></a><span class="co"># Gillespie Step                                                   #</span></span>
<span id="cb24-290"><a href="#cb24-290"></a><span class="do">####################################################################</span></span>
<span id="cb24-291"><a href="#cb24-291"></a>gil_step <span class="ot">&lt;-</span> <span class="cf">function</span>(SIR, beta, gamma) {</span>
<span id="cb24-292"><a href="#cb24-292"></a>  <span class="co"># SIR is a vector containing 4 elements</span></span>
<span id="cb24-293"><a href="#cb24-293"></a>  <span class="co">#   S = scalar number of susceptibles now</span></span>
<span id="cb24-294"><a href="#cb24-294"></a>  <span class="co">#   I = scalar number of infecteds now</span></span>
<span id="cb24-295"><a href="#cb24-295"></a>  <span class="co">#   R = scalar number of recovereds now</span></span>
<span id="cb24-296"><a href="#cb24-296"></a>  <span class="co">#   time = current time</span></span>
<span id="cb24-297"><a href="#cb24-297"></a>  <span class="co"># beta = transmission rate</span></span>
<span id="cb24-298"><a href="#cb24-298"></a>  <span class="co"># gamma = recovery rate</span></span>
<span id="cb24-299"><a href="#cb24-299"></a></span>
<span id="cb24-300"><a href="#cb24-300"></a>  <span class="co"># draw two random exponential variables</span></span>
<span id="cb24-301"><a href="#cb24-301"></a>  times <span class="ot">&lt;-</span> <span class="fu">rexp</span>(</span>
<span id="cb24-302"><a href="#cb24-302"></a>    <span class="dv">2</span>,</span>
<span id="cb24-303"><a href="#cb24-303"></a>    <span class="fu">c</span>(</span>
<span id="cb24-304"><a href="#cb24-304"></a>      <span class="co"># the first is the rate of new infections: S*Beta*I/N</span></span>
<span id="cb24-305"><a href="#cb24-305"></a>      beta <span class="sc">*</span> SIR[<span class="dv">1</span>] <span class="sc">*</span> SIR[<span class="dv">2</span>] <span class="sc">/</span> <span class="fu">sum</span>(SIR[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>]),</span>
<span id="cb24-306"><a href="#cb24-306"></a>      <span class="co"># the second is the rate of new recoveries: I*gamma</span></span>
<span id="cb24-307"><a href="#cb24-307"></a>      SIR[<span class="dv">2</span>] <span class="sc">*</span> gamma</span>
<span id="cb24-308"><a href="#cb24-308"></a>    )</span>
<span id="cb24-309"><a href="#cb24-309"></a>  )</span>
<span id="cb24-310"><a href="#cb24-310"></a></span>
<span id="cb24-311"><a href="#cb24-311"></a>  <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb24-312"><a href="#cb24-312"></a>    <span class="co"># which.min identifies which of the two random variables is smallest,</span></span>
<span id="cb24-313"><a href="#cb24-313"></a>    <span class="co"># and thus the first to happen: this is the transition that we'll make</span></span>
<span id="cb24-314"><a href="#cb24-314"></a>    <span class="at">change_state =</span> <span class="fu">which.min</span>(times),</span>
<span id="cb24-315"><a href="#cb24-315"></a>    <span class="co"># this identifies how much time elapsed before the transition occurred,</span></span>
<span id="cb24-316"><a href="#cb24-316"></a>    <span class="co"># so we can increment time forward</span></span>
<span id="cb24-317"><a href="#cb24-317"></a>    <span class="at">time_step =</span> <span class="fu">min</span>(times)</span>
<span id="cb24-318"><a href="#cb24-318"></a>  ))</span>
<span id="cb24-319"><a href="#cb24-319"></a>}</span>
<span id="cb24-320"><a href="#cb24-320"></a><span class="in">```</span></span>
<span id="cb24-321"><a href="#cb24-321"></a></span>
<span id="cb24-322"><a href="#cb24-322"></a>The gil_step() function increments the states forward by 1 event. Which event happens first, and the time it takes for that event to happen are both random variables. We then need to do this many times.</span>
<span id="cb24-323"><a href="#cb24-323"></a></span>
<span id="cb24-326"><a href="#cb24-326"></a><span class="in">```{r}</span></span>
<span id="cb24-327"><a href="#cb24-327"></a><span class="do">####################################################################</span></span>
<span id="cb24-328"><a href="#cb24-328"></a><span class="co"># Simulate over time                                               #</span></span>
<span id="cb24-329"><a href="#cb24-329"></a><span class="do">####################################################################</span></span>
<span id="cb24-330"><a href="#cb24-330"></a><span class="co"># here we set the random seed. This isn't necessary in general, but it allows us to write a "random" simulation</span></span>
<span id="cb24-331"><a href="#cb24-331"></a><span class="fu">set.seed</span>(<span class="dv">101</span>)</span>
<span id="cb24-332"><a href="#cb24-332"></a>counter <span class="ot">&lt;-</span> <span class="dv">0</span> <span class="co"># set counter at 0</span></span>
<span id="cb24-333"><a href="#cb24-333"></a><span class="cf">while</span> (<span class="fu">all</span>(I <span class="sc">&gt;</span> <span class="dv">0</span>)) {</span>
<span id="cb24-334"><a href="#cb24-334"></a>  <span class="co"># continue until I is depleted</span></span>
<span id="cb24-335"><a href="#cb24-335"></a>  counter <span class="ot">&lt;-</span> counter <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb24-336"><a href="#cb24-336"></a>  <span class="co"># counter for number of transitions: we don't know how many transitions</span></span>
<span id="cb24-337"><a href="#cb24-337"></a>  <span class="co"># will happen until the simulation is over</span></span>
<span id="cb24-338"><a href="#cb24-338"></a>  <span class="co">#</span></span>
<span id="cb24-339"><a href="#cb24-339"></a>  <span class="co"># current SIR states</span></span>
<span id="cb24-340"><a href="#cb24-340"></a>  sir_tmp <span class="ot">&lt;-</span> <span class="fu">c</span>(S[counter], I[counter], R[counter], time[counter])</span>
<span id="cb24-341"><a href="#cb24-341"></a>  step <span class="ot">&lt;-</span> <span class="fu">gil_step</span>(sir_tmp, beta, gamma)</span>
<span id="cb24-342"><a href="#cb24-342"></a>  <span class="cf">if</span> (step<span class="sc">$</span>change_state <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb24-343"><a href="#cb24-343"></a>    <span class="co"># if transition is an infection, reduce S and increase I</span></span>
<span id="cb24-344"><a href="#cb24-344"></a>    sir_tmp[<span class="dv">1</span>] <span class="ot">&lt;-</span> sir_tmp[<span class="dv">1</span>] <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb24-345"><a href="#cb24-345"></a>    sir_tmp[<span class="dv">2</span>] <span class="ot">&lt;-</span> sir_tmp[<span class="dv">2</span>] <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb24-346"><a href="#cb24-346"></a>  }</span>
<span id="cb24-347"><a href="#cb24-347"></a>  <span class="cf">if</span> (step<span class="sc">$</span>change_state <span class="sc">==</span> <span class="dv">2</span>) {</span>
<span id="cb24-348"><a href="#cb24-348"></a>    <span class="co"># if transition is an recovery, reduce I and increase R</span></span>
<span id="cb24-349"><a href="#cb24-349"></a>    sir_tmp[<span class="dv">2</span>] <span class="ot">&lt;-</span> sir_tmp[<span class="dv">2</span>] <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb24-350"><a href="#cb24-350"></a>    sir_tmp[<span class="dv">3</span>] <span class="ot">&lt;-</span> sir_tmp[<span class="dv">3</span>] <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb24-351"><a href="#cb24-351"></a>  }</span>
<span id="cb24-352"><a href="#cb24-352"></a>  sir_tmp[<span class="dv">4</span>] <span class="ot">&lt;-</span> sir_tmp[<span class="dv">4</span>] <span class="sc">+</span> step<span class="sc">$</span>time_step <span class="co"># increment time</span></span>
<span id="cb24-353"><a href="#cb24-353"></a></span>
<span id="cb24-354"><a href="#cb24-354"></a>  <span class="co"># Append changes</span></span>
<span id="cb24-355"><a href="#cb24-355"></a>  S <span class="ot">&lt;-</span> <span class="fu">c</span>(S, sir_tmp[<span class="dv">1</span>])</span>
<span id="cb24-356"><a href="#cb24-356"></a>  I <span class="ot">&lt;-</span> <span class="fu">c</span>(I, sir_tmp[<span class="dv">2</span>])</span>
<span id="cb24-357"><a href="#cb24-357"></a>  R <span class="ot">&lt;-</span> <span class="fu">c</span>(R, sir_tmp[<span class="dv">3</span>])</span>
<span id="cb24-358"><a href="#cb24-358"></a>  time <span class="ot">&lt;-</span> <span class="fu">c</span>(time, sir_tmp[<span class="dv">4</span>])</span>
<span id="cb24-359"><a href="#cb24-359"></a></span>
<span id="cb24-360"><a href="#cb24-360"></a>  <span class="co"># cat(S[counter],\"-\",I[counter],\"-\",R[counter],\"-\",time[counter], \".\\n\")</span></span>
<span id="cb24-361"><a href="#cb24-361"></a>  <span class="co"># this prints the output as it goes</span></span>
<span id="cb24-362"><a href="#cb24-362"></a>  <span class="co"># reset the seed so that every subsequent simulation IS random</span></span>
<span id="cb24-363"><a href="#cb24-363"></a>  <span class="fu">set.seed</span>(<span class="cn">NULL</span>)</span>
<span id="cb24-364"><a href="#cb24-364"></a>}</span>
<span id="cb24-365"><a href="#cb24-365"></a><span class="in">```</span></span>
<span id="cb24-366"><a href="#cb24-366"></a></span>
<span id="cb24-367"><a href="#cb24-367"></a>We can now plot the one realization of this stochastic outbreak. Notice that it has the same general shape as the deterministic outbreak, but is no longer smooth because each individual event over time happens randomly.</span>
<span id="cb24-368"><a href="#cb24-368"></a></span>
<span id="cb24-371"><a href="#cb24-371"></a><span class="in">```{r}</span></span>
<span id="cb24-372"><a href="#cb24-372"></a><span class="co">#| out-width: 100%</span></span>
<span id="cb24-373"><a href="#cb24-373"></a><span class="co">#| column: body</span></span>
<span id="cb24-374"><a href="#cb24-374"></a></span>
<span id="cb24-375"><a href="#cb24-375"></a><span class="co"># Reuse the plotting code from above</span></span>
<span id="cb24-376"><a href="#cb24-376"></a></span>
<span id="cb24-377"><a href="#cb24-377"></a><span class="co"># Turn the output from gil_step() into a tibble (dataframe)</span></span>
<span id="cb24-378"><a href="#cb24-378"></a><span class="co"># so we can manipulate and plot it easily</span></span>
<span id="cb24-379"><a href="#cb24-379"></a><span class="co"># put elements in a data frame</span></span>
<span id="cb24-380"><a href="#cb24-380"></a>gil_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(time, S, I, R) <span class="sc">%&gt;%</span></span>
<span id="cb24-381"><a href="#cb24-381"></a>  <span class="co"># Convert all columns to numeric (they are currently type</span></span>
<span id="cb24-382"><a href="#cb24-382"></a>  <span class="co"># deSolve so will produce warnings when plotting etc)</span></span>
<span id="cb24-383"><a href="#cb24-383"></a>  <span class="fu">mutate</span>(</span>
<span id="cb24-384"><a href="#cb24-384"></a>    <span class="co"># Rather than repeatedly type the same function for every</span></span>
<span id="cb24-385"><a href="#cb24-385"></a>    <span class="co"># column, use the across() function to apply the function</span></span>
<span id="cb24-386"><a href="#cb24-386"></a>    <span class="co"># to a selection of columns</span></span>
<span id="cb24-387"><a href="#cb24-387"></a>    <span class="fu">across</span>(</span>
<span id="cb24-388"><a href="#cb24-388"></a>      <span class="co"># The cols argument takes a selection of columns to apply</span></span>
<span id="cb24-389"><a href="#cb24-389"></a>      <span class="co"># a function to. Here, we want to apply the as.numeric()</span></span>
<span id="cb24-390"><a href="#cb24-390"></a>      <span class="co"># function to all columns, so we use the function</span></span>
<span id="cb24-391"><a href="#cb24-391"></a>      <span class="co"># everything() to select all columns.</span></span>
<span id="cb24-392"><a href="#cb24-392"></a>      <span class="at">.cols =</span> <span class="fu">everything</span>(),</span>
<span id="cb24-393"><a href="#cb24-393"></a>      <span class="at">.fns =</span> as.numeric</span>
<span id="cb24-394"><a href="#cb24-394"></a>    )</span>
<span id="cb24-395"><a href="#cb24-395"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb24-396"><a href="#cb24-396"></a>  <span class="co"># Convert the dataframe from wide to long format, so we have a</span></span>
<span id="cb24-397"><a href="#cb24-397"></a>  <span class="co"># column for the time, a column for the state, and a column</span></span>
<span id="cb24-398"><a href="#cb24-398"></a>  <span class="co"># for the proportion of the population in that state at that</span></span>
<span id="cb24-399"><a href="#cb24-399"></a>  <span class="co"># time</span></span>
<span id="cb24-400"><a href="#cb24-400"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb24-401"><a href="#cb24-401"></a>    <span class="co"># Don't pivot the time column</span></span>
<span id="cb24-402"><a href="#cb24-402"></a>    <span class="at">cols =</span> <span class="sc">-</span><span class="fu">c</span>(time),</span>
<span id="cb24-403"><a href="#cb24-403"></a>    <span class="at">names_to =</span> <span class="st">"state"</span>,</span>
<span id="cb24-404"><a href="#cb24-404"></a>    <span class="at">values_to =</span> <span class="st">"number"</span></span>
<span id="cb24-405"><a href="#cb24-405"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb24-406"><a href="#cb24-406"></a>  <span class="co"># Update the state column to be a factor, so the plot will</span></span>
<span id="cb24-407"><a href="#cb24-407"></a>  <span class="co"># show the states in the correct order</span></span>
<span id="cb24-408"><a href="#cb24-408"></a>  <span class="fu">mutate</span>(<span class="at">state =</span> <span class="fu">factor</span>(state, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"S"</span>, <span class="st">"I"</span>, <span class="st">"R"</span>)))</span>
<span id="cb24-409"><a href="#cb24-409"></a></span>
<span id="cb24-410"><a href="#cb24-410"></a>sir_colors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">S =</span> <span class="st">"#1f77b4"</span>, <span class="at">I =</span> <span class="st">"#ff7f0e"</span>, <span class="at">R =</span> <span class="st">"#FF3851"</span>)</span>
<span id="cb24-411"><a href="#cb24-411"></a></span>
<span id="cb24-412"><a href="#cb24-412"></a><span class="fu">ggplot</span>(gil_df, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> number, <span class="at">color =</span> state)) <span class="sc">+</span></span>
<span id="cb24-413"><a href="#cb24-413"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb24-414"><a href="#cb24-414"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> sir_colors) <span class="sc">+</span></span>
<span id="cb24-415"><a href="#cb24-415"></a>  <span class="fu">labs</span>(</span>
<span id="cb24-416"><a href="#cb24-416"></a>    <span class="at">x =</span> <span class="st">"Time"</span>,</span>
<span id="cb24-417"><a href="#cb24-417"></a>    <span class="at">y =</span> <span class="st">"Number"</span>,</span>
<span id="cb24-418"><a href="#cb24-418"></a>    <span class="at">color =</span> <span class="st">"State"</span></span>
<span id="cb24-419"><a href="#cb24-419"></a>  ) <span class="sc">+</span></span>
<span id="cb24-420"><a href="#cb24-420"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span>
<span id="cb24-421"><a href="#cb24-421"></a><span class="in">```</span></span>
<span id="cb24-422"><a href="#cb24-422"></a></span>
<span id="cb24-423"><a href="#cb24-423"></a>Because each realization is stochastic, we need to generate many runs to see the general behavior.</span>
<span id="cb24-424"><a href="#cb24-424"></a>The code below runs 10 iterations.</span>
<span id="cb24-425"><a href="#cb24-425"></a>Generally, this would be considered a very small number of iterations.</span>
<span id="cb24-426"><a href="#cb24-426"></a>But even for this very small model, running 100 or more means you'll be waiting for output.</span>
<span id="cb24-427"><a href="#cb24-427"></a>Note that this code is designed to be transparent not to be fast.</span>
<span id="cb24-428"><a href="#cb24-428"></a>Making these run fast is beyond the scope of this assignment.</span>
<span id="cb24-429"><a href="#cb24-429"></a></span>
<span id="cb24-432"><a href="#cb24-432"></a><span class="in">```{r}</span></span>
<span id="cb24-433"><a href="#cb24-433"></a><span class="do">####################################################################</span></span>
<span id="cb24-434"><a href="#cb24-434"></a><span class="co"># Simulate over time                                               #</span></span>
<span id="cb24-435"><a href="#cb24-435"></a>num_iterations <span class="ot">&lt;-</span> <span class="dv">10</span> <span class="co"># number of realizations to simulate</span></span>
<span id="cb24-436"><a href="#cb24-436"></a></span>
<span id="cb24-437"><a href="#cb24-437"></a><span class="cf">for</span> (iter <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>num_iterations) {</span>
<span id="cb24-438"><a href="#cb24-438"></a>  <span class="do">####################################################################</span></span>
<span id="cb24-439"><a href="#cb24-439"></a>  <span class="co"># Parameters and initial conditions                                #</span></span>
<span id="cb24-440"><a href="#cb24-440"></a>  <span class="do">####################################################################</span></span>
<span id="cb24-441"><a href="#cb24-441"></a></span>
<span id="cb24-442"><a href="#cb24-442"></a>  S <span class="ot">&lt;-</span> <span class="dv">998</span> <span class="co"># number susceptible</span></span>
<span id="cb24-443"><a href="#cb24-443"></a>  I <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co"># number infected</span></span>
<span id="cb24-444"><a href="#cb24-444"></a>  R <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co"># number recovered</span></span>
<span id="cb24-445"><a href="#cb24-445"></a>  time <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb24-446"><a href="#cb24-446"></a>  <span class="co"># initialize iteration counter</span></span>
<span id="cb24-447"><a href="#cb24-447"></a>  iteration <span class="ot">&lt;-</span> iter</span>
<span id="cb24-448"><a href="#cb24-448"></a></span>
<span id="cb24-449"><a href="#cb24-449"></a>  beta <span class="ot">&lt;-</span> .<span class="dv">5</span> <span class="co"># transmission rate</span></span>
<span id="cb24-450"><a href="#cb24-450"></a>  gamma <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">7</span> <span class="co"># recovery rate</span></span>
<span id="cb24-451"><a href="#cb24-451"></a></span>
<span id="cb24-452"><a href="#cb24-452"></a>  <span class="do">####################################################################</span></span>
<span id="cb24-453"><a href="#cb24-453"></a>  <span class="co"># Simulate over time                                               #</span></span>
<span id="cb24-454"><a href="#cb24-454"></a>  <span class="do">####################################################################</span></span>
<span id="cb24-455"><a href="#cb24-455"></a>  counter <span class="ot">&lt;-</span> <span class="dv">0</span> <span class="co"># set counter at 0</span></span>
<span id="cb24-456"><a href="#cb24-456"></a>  <span class="cf">while</span> (<span class="fu">all</span>(I <span class="sc">&gt;</span> <span class="dv">0</span>)) {</span>
<span id="cb24-457"><a href="#cb24-457"></a>    <span class="co"># continue until I is depleted</span></span>
<span id="cb24-458"><a href="#cb24-458"></a>    counter <span class="ot">&lt;-</span> counter <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb24-459"><a href="#cb24-459"></a>    <span class="co"># counter for number of transitions: we don't know how many transitions</span></span>
<span id="cb24-460"><a href="#cb24-460"></a>    <span class="co"># will happen until the simulation is over</span></span>
<span id="cb24-461"><a href="#cb24-461"></a></span>
<span id="cb24-462"><a href="#cb24-462"></a>    <span class="co"># current SIR states</span></span>
<span id="cb24-463"><a href="#cb24-463"></a>    sir_tmp <span class="ot">&lt;-</span> <span class="fu">c</span>(S[counter], I[counter], R[counter], time[counter])</span>
<span id="cb24-464"><a href="#cb24-464"></a>    step <span class="ot">&lt;-</span> <span class="fu">gil_step</span>(sir_tmp, beta, gamma)</span>
<span id="cb24-465"><a href="#cb24-465"></a>    <span class="cf">if</span> (step<span class="sc">$</span>change_state <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb24-466"><a href="#cb24-466"></a>      <span class="co"># if transition is an infection, reduce S and increase I</span></span>
<span id="cb24-467"><a href="#cb24-467"></a>      sir_tmp[<span class="dv">1</span>] <span class="ot">&lt;-</span> sir_tmp[<span class="dv">1</span>] <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb24-468"><a href="#cb24-468"></a>      sir_tmp[<span class="dv">2</span>] <span class="ot">&lt;-</span> sir_tmp[<span class="dv">2</span>] <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb24-469"><a href="#cb24-469"></a>    }</span>
<span id="cb24-470"><a href="#cb24-470"></a>    <span class="cf">if</span> (step<span class="sc">$</span>change_state <span class="sc">==</span> <span class="dv">2</span>) {</span>
<span id="cb24-471"><a href="#cb24-471"></a>      <span class="co"># if transition is an recovery, reduce I and increase R</span></span>
<span id="cb24-472"><a href="#cb24-472"></a>      sir_tmp[<span class="dv">2</span>] <span class="ot">&lt;-</span> sir_tmp[<span class="dv">2</span>] <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb24-473"><a href="#cb24-473"></a>      sir_tmp[<span class="dv">3</span>] <span class="ot">&lt;-</span> sir_tmp[<span class="dv">3</span>] <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb24-474"><a href="#cb24-474"></a>    }</span>
<span id="cb24-475"><a href="#cb24-475"></a>    <span class="co"># increment time</span></span>
<span id="cb24-476"><a href="#cb24-476"></a>    sir_tmp[<span class="dv">4</span>] <span class="ot">&lt;-</span> sir_tmp[<span class="dv">4</span>] <span class="sc">+</span> step<span class="sc">$</span>time_step</span>
<span id="cb24-477"><a href="#cb24-477"></a></span>
<span id="cb24-478"><a href="#cb24-478"></a>    <span class="co"># Append changes</span></span>
<span id="cb24-479"><a href="#cb24-479"></a>    S <span class="ot">&lt;-</span> <span class="fu">c</span>(S, sir_tmp[<span class="dv">1</span>])</span>
<span id="cb24-480"><a href="#cb24-480"></a>    I <span class="ot">&lt;-</span> <span class="fu">c</span>(I, sir_tmp[<span class="dv">2</span>])</span>
<span id="cb24-481"><a href="#cb24-481"></a>    R <span class="ot">&lt;-</span> <span class="fu">c</span>(R, sir_tmp[<span class="dv">3</span>])</span>
<span id="cb24-482"><a href="#cb24-482"></a>    time <span class="ot">&lt;-</span> <span class="fu">c</span>(time, sir_tmp[<span class="dv">4</span>])</span>
<span id="cb24-483"><a href="#cb24-483"></a>    iteration <span class="ot">&lt;-</span> <span class="fu">c</span>(iteration, iter)</span>
<span id="cb24-484"><a href="#cb24-484"></a></span>
<span id="cb24-485"><a href="#cb24-485"></a>    <span class="co"># cat(S[counter],\"-\",I[counter],\"-\",R[counter],\"-\",time[counter], \".\\n\")</span></span>
<span id="cb24-486"><a href="#cb24-486"></a>    <span class="co"># this prints the output as it goes</span></span>
<span id="cb24-487"><a href="#cb24-487"></a>  }</span>
<span id="cb24-488"><a href="#cb24-488"></a>  <span class="cf">if</span> (iter <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb24-489"><a href="#cb24-489"></a>    sir_gil_storage <span class="ot">&lt;-</span> <span class="fu">tibble</span>(S, I, R, time, iteration)</span>
<span id="cb24-490"><a href="#cb24-490"></a>  }</span>
<span id="cb24-491"><a href="#cb24-491"></a>  <span class="cf">if</span> (iter <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb24-492"><a href="#cb24-492"></a>    sir_gil_storage <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb24-493"><a href="#cb24-493"></a>      sir_gil_storage,</span>
<span id="cb24-494"><a href="#cb24-494"></a>      <span class="fu">tibble</span>(S, I, R, time, iteration)</span>
<span id="cb24-495"><a href="#cb24-495"></a>    )</span>
<span id="cb24-496"><a href="#cb24-496"></a>  }</span>
<span id="cb24-497"><a href="#cb24-497"></a>}</span>
<span id="cb24-498"><a href="#cb24-498"></a><span class="in">```</span></span>
<span id="cb24-499"><a href="#cb24-499"></a></span>
<span id="cb24-502"><a href="#cb24-502"></a><span class="in">```{r}</span></span>
<span id="cb24-503"><a href="#cb24-503"></a><span class="co">#| out-width: 100%</span></span>
<span id="cb24-504"><a href="#cb24-504"></a><span class="co">#| column: body</span></span>
<span id="cb24-505"><a href="#cb24-505"></a></span>
<span id="cb24-506"><a href="#cb24-506"></a><span class="co"># Reuse the plotting code from above</span></span>
<span id="cb24-507"><a href="#cb24-507"></a></span>
<span id="cb24-508"><a href="#cb24-508"></a><span class="co"># Turn the output from gil_step() into a tibble (dataframe)</span></span>
<span id="cb24-509"><a href="#cb24-509"></a><span class="co"># so we can manipulate and plot it easily</span></span>
<span id="cb24-510"><a href="#cb24-510"></a><span class="co"># put elements in a data frame</span></span>
<span id="cb24-511"><a href="#cb24-511"></a>gil_df <span class="ot">&lt;-</span> sir_gil_storage <span class="sc">%&gt;%</span></span>
<span id="cb24-512"><a href="#cb24-512"></a>  <span class="co"># Convert all columns to numeric (they are currently type</span></span>
<span id="cb24-513"><a href="#cb24-513"></a>  <span class="co"># deSolve so will produce warnings when plotting etc)</span></span>
<span id="cb24-514"><a href="#cb24-514"></a>  <span class="fu">mutate</span>(</span>
<span id="cb24-515"><a href="#cb24-515"></a>    <span class="co"># Rather than repeatedly type the same function for every</span></span>
<span id="cb24-516"><a href="#cb24-516"></a>    <span class="co"># column, use the across() function to apply the function</span></span>
<span id="cb24-517"><a href="#cb24-517"></a>    <span class="co"># to a selection of columns</span></span>
<span id="cb24-518"><a href="#cb24-518"></a>    <span class="fu">across</span>(</span>
<span id="cb24-519"><a href="#cb24-519"></a>      <span class="co"># The cols argument takes a selection of columns to apply</span></span>
<span id="cb24-520"><a href="#cb24-520"></a>      <span class="co"># a function to. Here, we want to apply the as.numeric()</span></span>
<span id="cb24-521"><a href="#cb24-521"></a>      <span class="co"># function to all columns, so we use the function</span></span>
<span id="cb24-522"><a href="#cb24-522"></a>      <span class="co"># everything() to select all columns.</span></span>
<span id="cb24-523"><a href="#cb24-523"></a>      <span class="at">.cols =</span> <span class="fu">everything</span>(),</span>
<span id="cb24-524"><a href="#cb24-524"></a>      <span class="at">.fns =</span> as.numeric</span>
<span id="cb24-525"><a href="#cb24-525"></a>    )</span>
<span id="cb24-526"><a href="#cb24-526"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb24-527"><a href="#cb24-527"></a>  <span class="co"># Convert the dataframe from wide to long format, so we have a</span></span>
<span id="cb24-528"><a href="#cb24-528"></a>  <span class="co"># column for the time, a column for the state, and a column</span></span>
<span id="cb24-529"><a href="#cb24-529"></a>  <span class="co"># for the proportion of the population in that state at that</span></span>
<span id="cb24-530"><a href="#cb24-530"></a>  <span class="co"># time</span></span>
<span id="cb24-531"><a href="#cb24-531"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb24-532"><a href="#cb24-532"></a>    <span class="co"># Don't pivot the time column</span></span>
<span id="cb24-533"><a href="#cb24-533"></a>    <span class="at">cols =</span> <span class="sc">-</span><span class="fu">c</span>(time, iteration),</span>
<span id="cb24-534"><a href="#cb24-534"></a>    <span class="at">names_to =</span> <span class="st">"state"</span>,</span>
<span id="cb24-535"><a href="#cb24-535"></a>    <span class="at">values_to =</span> <span class="st">"number"</span></span>
<span id="cb24-536"><a href="#cb24-536"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb24-537"><a href="#cb24-537"></a>  <span class="co"># Update the state column to be a factor, so the plot will</span></span>
<span id="cb24-538"><a href="#cb24-538"></a>  <span class="co"># show the states in the correct order</span></span>
<span id="cb24-539"><a href="#cb24-539"></a>  <span class="fu">mutate</span>(<span class="at">state =</span> <span class="fu">factor</span>(state, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"S"</span>, <span class="st">"I"</span>, <span class="st">"R"</span>)))</span>
<span id="cb24-540"><a href="#cb24-540"></a></span>
<span id="cb24-541"><a href="#cb24-541"></a>sir_colors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">S =</span> <span class="st">"#1f77b4"</span>, <span class="at">I =</span> <span class="st">"#ff7f0e"</span>, <span class="at">R =</span> <span class="st">"#FF3851"</span>)</span>
<span id="cb24-542"><a href="#cb24-542"></a></span>
<span id="cb24-543"><a href="#cb24-543"></a><span class="fu">ggplot</span>(</span>
<span id="cb24-544"><a href="#cb24-544"></a>  gil_df,</span>
<span id="cb24-545"><a href="#cb24-545"></a>  <span class="fu">aes</span>(</span>
<span id="cb24-546"><a href="#cb24-546"></a>    <span class="at">x =</span> time,</span>
<span id="cb24-547"><a href="#cb24-547"></a>    <span class="at">y =</span> number,</span>
<span id="cb24-548"><a href="#cb24-548"></a>    <span class="at">color =</span> state,</span>
<span id="cb24-549"><a href="#cb24-549"></a>    <span class="at">group =</span> <span class="fu">interaction</span>(iteration, state)</span>
<span id="cb24-550"><a href="#cb24-550"></a>  )</span>
<span id="cb24-551"><a href="#cb24-551"></a>) <span class="sc">+</span></span>
<span id="cb24-552"><a href="#cb24-552"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.5</span>, <span class="at">alpha =</span> .<span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb24-553"><a href="#cb24-553"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> sir_colors) <span class="sc">+</span></span>
<span id="cb24-554"><a href="#cb24-554"></a>  <span class="fu">labs</span>(</span>
<span id="cb24-555"><a href="#cb24-555"></a>    <span class="at">x =</span> <span class="st">"Time"</span>,</span>
<span id="cb24-556"><a href="#cb24-556"></a>    <span class="at">y =</span> <span class="st">"Number"</span>,</span>
<span id="cb24-557"><a href="#cb24-557"></a>    <span class="at">color =</span> <span class="st">"State"</span></span>
<span id="cb24-558"><a href="#cb24-558"></a>  ) <span class="sc">+</span></span>
<span id="cb24-559"><a href="#cb24-559"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">alpha =</span> <span class="dv">1</span>))) <span class="sc">+</span></span>
<span id="cb24-560"><a href="#cb24-560"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span>
<span id="cb24-561"><a href="#cb24-561"></a><span class="in">```</span></span>
<span id="cb24-562"><a href="#cb24-562"></a></span>
<span id="cb24-563"><a href="#cb24-563"></a>The Gillespie algorithm doesn't cut any corners relative to the ODE model, but that comes at the cost of computational efficiency.</span>
<span id="cb24-564"><a href="#cb24-564"></a>For every event that happens (e.g. an infection) you also have to generate a random draw (e.g. a recovery) that you don't use, except for comparison.</span>
<span id="cb24-565"><a href="#cb24-565"></a>And the bigger your population, the more possible events can happen.</span>
<span id="cb24-566"><a href="#cb24-566"></a>So the bigger the model (e.g. adding exposed or vaccinated classes, or heterogeneity, add transitions) and the bigger the population, the more calculation you need and and therefore the slower the model.</span>
<span id="cb24-567"><a href="#cb24-567"></a></span>
<span id="cb24-568"><a href="#cb24-568"></a></span>
<span id="cb24-569"><a href="#cb24-569"></a><span class="fu">## The Tau Leaping Algorithm</span></span>
<span id="cb24-570"><a href="#cb24-570"></a></span>
<span id="cb24-571"><a href="#cb24-571"></a>The Gillespie algorithm is great because it is an exact interpretation of the transitions in the ODE model: every change of state (e.g. infection or recovery) changes the rates for the next transition.</span>
<span id="cb24-572"><a href="#cb24-572"></a>Doing this comes at a computational cost.</span>
<span id="cb24-573"><a href="#cb24-573"></a>One reasonable approximation is the Tau Leaping algorithm.</span>
<span id="cb24-574"><a href="#cb24-574"></a>Here, we move in discrete chunks of time and make random draws for multiple events occurring within that chunk.</span>
<span id="cb24-575"><a href="#cb24-575"></a>Here the computation scales with the number of time steps (and the number of states requiring transitions).</span>
<span id="cb24-576"><a href="#cb24-576"></a>But, we rely on the result that, if rates stay constant, the number of events that occur in a discrete chunk of time can be approximated by a Poisson random variable.</span>
<span id="cb24-577"><a href="#cb24-577"></a>Thus, we don't need to make random draws for every event.</span>
<span id="cb24-578"><a href="#cb24-578"></a>Instead we can make 1 draw for the multiple events that will occur in 1 day, or 1 week, etc.</span>
<span id="cb24-579"><a href="#cb24-579"></a>The key here is the assumption that the rates stay constant; since each new infection or recovery will change the rates, we don't want \emph{too many} to occur (in which case the rate at the start of the time step will be very different than the rate at the end of the time step).</span>
<span id="cb24-580"><a href="#cb24-580"></a>So we are faced with a trade-off; very small time steps don't violate the assumptions, but the smaller the steps, the closer we are to Gillespie and the smaller the computational savings.</span>
<span id="cb24-581"><a href="#cb24-581"></a>There's no right answer to what time step to use.</span>
<span id="cb24-582"><a href="#cb24-582"></a>Here we'll use 1 day, for convenience.</span>
<span id="cb24-583"><a href="#cb24-583"></a></span>
<span id="cb24-586"><a href="#cb24-586"></a><span class="in">```{r}</span></span>
<span id="cb24-587"><a href="#cb24-587"></a><span class="do">####################################################################</span></span>
<span id="cb24-588"><a href="#cb24-588"></a><span class="co"># Parameters and initial conditions                                #</span></span>
<span id="cb24-589"><a href="#cb24-589"></a><span class="do">####################################################################</span></span>
<span id="cb24-590"><a href="#cb24-590"></a></span>
<span id="cb24-591"><a href="#cb24-591"></a>S <span class="ot">&lt;-</span> <span class="dv">998</span> <span class="co"># number susceptible</span></span>
<span id="cb24-592"><a href="#cb24-592"></a>I <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co"># number infected</span></span>
<span id="cb24-593"><a href="#cb24-593"></a>R <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co"># number recovered</span></span>
<span id="cb24-594"><a href="#cb24-594"></a>time <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb24-595"><a href="#cb24-595"></a></span>
<span id="cb24-596"><a href="#cb24-596"></a>beta <span class="ot">&lt;-</span> .<span class="dv">5</span> <span class="co"># transmission rate</span></span>
<span id="cb24-597"><a href="#cb24-597"></a>gamma <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">7</span> <span class="co"># recovery rate</span></span>
<span id="cb24-598"><a href="#cb24-598"></a><span class="in">```</span></span>
<span id="cb24-599"><a href="#cb24-599"></a></span>
<span id="cb24-602"><a href="#cb24-602"></a><span class="in">```{r}</span></span>
<span id="cb24-603"><a href="#cb24-603"></a><span class="do">####################################################################</span></span>
<span id="cb24-604"><a href="#cb24-604"></a><span class="co"># Tau Leaping Single time step                                     #</span></span>
<span id="cb24-605"><a href="#cb24-605"></a><span class="do">####################################################################</span></span>
<span id="cb24-606"><a href="#cb24-606"></a>tau_sir_step <span class="ot">&lt;-</span> <span class="cf">function</span>(sims, S, I, R, beta, gamma, delta_t, ...) {</span>
<span id="cb24-607"><a href="#cb24-607"></a>  <span class="co"># adapted from Aaron King's code</span></span>
<span id="cb24-608"><a href="#cb24-608"></a>  <span class="co"># sims = number of simulations</span></span>
<span id="cb24-609"><a href="#cb24-609"></a>  <span class="co"># S = initial susceptible population</span></span>
<span id="cb24-610"><a href="#cb24-610"></a>  <span class="co"># I = initial infected population</span></span>
<span id="cb24-611"><a href="#cb24-611"></a>  <span class="co"># R = initial recovered population</span></span>
<span id="cb24-612"><a href="#cb24-612"></a>  <span class="co"># beta = transmission rate</span></span>
<span id="cb24-613"><a href="#cb24-613"></a>  <span class="co"># gamma = recovery rate</span></span>
<span id="cb24-614"><a href="#cb24-614"></a></span>
<span id="cb24-615"><a href="#cb24-615"></a>  <span class="co"># total population size</span></span>
<span id="cb24-616"><a href="#cb24-616"></a>  N <span class="ot">&lt;-</span> S <span class="sc">+</span> I <span class="sc">+</span> R</span>
<span id="cb24-617"><a href="#cb24-617"></a>  <span class="co"># new incident infections</span></span>
<span id="cb24-618"><a href="#cb24-618"></a>  dSI <span class="ot">&lt;-</span> <span class="fu">rpois</span>(<span class="at">n =</span> sims, beta <span class="sc">*</span> S <span class="sc">*</span> (I <span class="sc">/</span> N) <span class="sc">*</span> delta_t)</span>
<span id="cb24-619"><a href="#cb24-619"></a>  <span class="co"># recoveries</span></span>
<span id="cb24-620"><a href="#cb24-620"></a>  dIR <span class="ot">&lt;-</span> <span class="fu">rpois</span>(<span class="at">n =</span> sims, gamma <span class="sc">*</span> I <span class="sc">*</span> delta_t)</span>
<span id="cb24-621"><a href="#cb24-621"></a>  <span class="co"># note that this can be done with a binomial step as well</span></span>
<span id="cb24-622"><a href="#cb24-622"></a>  <span class="co"># dSI &lt;- rbinom(n=sims,size=S,prob=1-exp(-beta*(I/N)*delta_t))</span></span>
<span id="cb24-623"><a href="#cb24-623"></a>  <span class="co"># new incident infections</span></span>
<span id="cb24-624"><a href="#cb24-624"></a>  <span class="co"># dIR &lt;- rbinom(n=sims,size=I,prob=1-exp(-gamma*delta_t))</span></span>
<span id="cb24-625"><a href="#cb24-625"></a>  <span class="co"># recoveries</span></span>
<span id="cb24-626"><a href="#cb24-626"></a></span>
<span id="cb24-627"><a href="#cb24-627"></a>  <span class="co"># since it is possible for the transitions to drive the states negative,</span></span>
<span id="cb24-628"><a href="#cb24-628"></a>  <span class="co"># we have to prevent that</span></span>
<span id="cb24-629"><a href="#cb24-629"></a>  <span class="co"># change in S</span></span>
<span id="cb24-630"><a href="#cb24-630"></a>  S <span class="ot">&lt;-</span> <span class="fu">pmax</span>(S <span class="sc">-</span> dSI, <span class="dv">0</span>)</span>
<span id="cb24-631"><a href="#cb24-631"></a>  <span class="co"># change in I</span></span>
<span id="cb24-632"><a href="#cb24-632"></a>  I <span class="ot">&lt;-</span> <span class="fu">pmax</span>(I <span class="sc">+</span> dSI <span class="sc">-</span> dIR, <span class="dv">0</span>)</span>
<span id="cb24-633"><a href="#cb24-633"></a>  <span class="co"># change in R</span></span>
<span id="cb24-634"><a href="#cb24-634"></a>  R <span class="ot">&lt;-</span> R <span class="sc">+</span> dIR</span>
<span id="cb24-635"><a href="#cb24-635"></a>  <span class="co"># note that dSI are the new incident infections</span></span>
<span id="cb24-636"><a href="#cb24-636"></a>  <span class="fu">cbind</span>(S, I, R, dSI)</span>
<span id="cb24-637"><a href="#cb24-637"></a>}</span>
<span id="cb24-638"><a href="#cb24-638"></a><span class="in">```</span></span>
<span id="cb24-639"><a href="#cb24-639"></a></span>
<span id="cb24-640"><a href="#cb24-640"></a>Note in the code above that we're taking Poisson random draws, but there is some code commented out that uses binomial draws.</span>
<span id="cb24-641"><a href="#cb24-641"></a>The former is exact for the theory, but it can give rise to settings where the transitions "get ahead of themselves" and you have more recoveries than infecteds, or more infections than susceptibles, which drives the states negative.</span>
<span id="cb24-642"><a href="#cb24-642"></a>We can fix this by checking if the states go negative and disallowing this ... which is inelegant.</span>
<span id="cb24-643"><a href="#cb24-643"></a>We can also fix this by using binomial draws, which are naturally constrained not to go negative.</span>
<span id="cb24-644"><a href="#cb24-644"></a>The reason we don't automatically start with binomial draws is that they are computationally slower than Poisson draws (this occurs because the binomial distribution includes some combinatorial terms that are slow to compute).</span>
<span id="cb24-645"><a href="#cb24-645"></a>As computers have gotten faster, this is less of an issue.</span>
<span id="cb24-646"><a href="#cb24-646"></a></span>
<span id="cb24-649"><a href="#cb24-649"></a><span class="in">```{r}</span></span>
<span id="cb24-650"><a href="#cb24-650"></a><span class="do">####################################################################</span></span>
<span id="cb24-651"><a href="#cb24-651"></a><span class="co"># set up and storage for states                                    #</span></span>
<span id="cb24-652"><a href="#cb24-652"></a><span class="do">####################################################################</span></span>
<span id="cb24-653"><a href="#cb24-653"></a>max_time <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb24-654"><a href="#cb24-654"></a><span class="co"># time to simulate over. With Tau Leaping the random draws scale with time</span></span>
<span id="cb24-655"><a href="#cb24-655"></a><span class="co"># not with population size, so this is much more efficient than Gillespie</span></span>
<span id="cb24-656"><a href="#cb24-656"></a><span class="co"># for large populations</span></span>
<span id="cb24-657"><a href="#cb24-657"></a>sims <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb24-658"><a href="#cb24-658"></a><span class="co"># number of simulations: notice that we can do WAY more now</span></span>
<span id="cb24-659"><a href="#cb24-659"></a></span>
<span id="cb24-660"><a href="#cb24-660"></a>s_mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(S, <span class="dv">1</span>, sims) <span class="co"># storage item for S for all simulations</span></span>
<span id="cb24-661"><a href="#cb24-661"></a>i_mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(I, <span class="dv">1</span>, sims) <span class="co"># storage item for I for all simulations</span></span>
<span id="cb24-662"><a href="#cb24-662"></a>r_mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(R, <span class="dv">1</span>, sims) <span class="co"># storage item for R for all simulations</span></span>
<span id="cb24-663"><a href="#cb24-663"></a>new_cases <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="dv">1</span>, sims)</span>
<span id="cb24-664"><a href="#cb24-664"></a><span class="co"># storage item for new cases (i.e. incidence) for all simulations</span></span>
<span id="cb24-665"><a href="#cb24-665"></a>n_mat <span class="ot">&lt;-</span> S <span class="sc">+</span> I <span class="sc">+</span> R <span class="co"># storage item for N for all simulations</span></span>
<span id="cb24-666"><a href="#cb24-666"></a><span class="in">```</span></span>
<span id="cb24-667"><a href="#cb24-667"></a></span>
<span id="cb24-670"><a href="#cb24-670"></a><span class="in">```{r}</span></span>
<span id="cb24-671"><a href="#cb24-671"></a><span class="do">####################################################################</span></span>
<span id="cb24-672"><a href="#cb24-672"></a><span class="co"># run over a time from 2 to T                                      #</span></span>
<span id="cb24-673"><a href="#cb24-673"></a><span class="do">####################################################################</span></span>
<span id="cb24-674"><a href="#cb24-674"></a><span class="co">#</span></span>
<span id="cb24-675"><a href="#cb24-675"></a><span class="cf">for</span> (time_step <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>max_time) {</span>
<span id="cb24-676"><a href="#cb24-676"></a>  <span class="co"># loop over time, time_step is the index</span></span>
<span id="cb24-677"><a href="#cb24-677"></a></span>
<span id="cb24-678"><a href="#cb24-678"></a>  out <span class="ot">&lt;-</span> <span class="fu">tau_sir_step</span>(</span>
<span id="cb24-679"><a href="#cb24-679"></a>    sims,</span>
<span id="cb24-680"><a href="#cb24-680"></a>    s_mat[time_step <span class="sc">-</span> <span class="dv">1</span>, ],</span>
<span id="cb24-681"><a href="#cb24-681"></a>    i_mat[time_step <span class="sc">-</span> <span class="dv">1</span>, ],</span>
<span id="cb24-682"><a href="#cb24-682"></a>    r_mat[time_step <span class="sc">-</span> <span class="dv">1</span>, ],</span>
<span id="cb24-683"><a href="#cb24-683"></a>    beta,</span>
<span id="cb24-684"><a href="#cb24-684"></a>    gamma,</span>
<span id="cb24-685"><a href="#cb24-685"></a>    <span class="at">delta_t =</span> <span class="dv">1</span></span>
<span id="cb24-686"><a href="#cb24-686"></a>  )</span>
<span id="cb24-687"><a href="#cb24-687"></a>  <span class="co"># call to SIR step function above</span></span>
<span id="cb24-688"><a href="#cb24-688"></a></span>
<span id="cb24-689"><a href="#cb24-689"></a>  <span class="co"># update state</span></span>
<span id="cb24-690"><a href="#cb24-690"></a>  s_mat <span class="ot">&lt;-</span> <span class="fu">rbind</span>(s_mat, out[, <span class="dv">1</span>])</span>
<span id="cb24-691"><a href="#cb24-691"></a>  <span class="co"># update state</span></span>
<span id="cb24-692"><a href="#cb24-692"></a>  i_mat <span class="ot">&lt;-</span> <span class="fu">rbind</span>(i_mat, out[, <span class="dv">2</span>])</span>
<span id="cb24-693"><a href="#cb24-693"></a>  <span class="co"># update state</span></span>
<span id="cb24-694"><a href="#cb24-694"></a>  r_mat <span class="ot">&lt;-</span> <span class="fu">rbind</span>(r_mat, out[, <span class="dv">3</span>])</span>
<span id="cb24-695"><a href="#cb24-695"></a>  <span class="co"># update state -- note population size isn't changing, but this could be</span></span>
<span id="cb24-696"><a href="#cb24-696"></a>  <span class="co"># updated with births/deaths</span></span>
<span id="cb24-697"><a href="#cb24-697"></a>  n_mat <span class="ot">&lt;-</span> <span class="fu">rbind</span>(n_mat, out[, <span class="dv">1</span>] <span class="sc">+</span> out[, <span class="dv">2</span>] <span class="sc">+</span> out[, <span class="dv">3</span>])</span>
<span id="cb24-698"><a href="#cb24-698"></a>  <span class="co"># update state</span></span>
<span id="cb24-699"><a href="#cb24-699"></a>  new_cases <span class="ot">&lt;-</span> <span class="fu">rbind</span>(new_cases, out[, <span class="dv">4</span>])</span>
<span id="cb24-700"><a href="#cb24-700"></a>}</span>
<span id="cb24-701"><a href="#cb24-701"></a><span class="in">```</span></span>
<span id="cb24-702"><a href="#cb24-702"></a></span>
<span id="cb24-703"><a href="#cb24-703"></a>Hopefully you can easily see that simulating 1000 iterations of Tau Leaping is \emph{way} faster than Gillespie.</span>
<span id="cb24-704"><a href="#cb24-704"></a></span>
<span id="cb24-707"><a href="#cb24-707"></a><span class="in">```{r}</span></span>
<span id="cb24-708"><a href="#cb24-708"></a><span class="co">#| out-width: 100%</span></span>
<span id="cb24-709"><a href="#cb24-709"></a><span class="co">#| column: body</span></span>
<span id="cb24-710"><a href="#cb24-710"></a></span>
<span id="cb24-711"><a href="#cb24-711"></a><span class="do">####################################################################</span></span>
<span id="cb24-712"><a href="#cb24-712"></a><span class="co"># plotting                                                         #</span></span>
<span id="cb24-713"><a href="#cb24-713"></a><span class="do">####################################################################</span></span>
<span id="cb24-714"><a href="#cb24-714"></a><span class="co"># put output in a data frame</span></span>
<span id="cb24-715"><a href="#cb24-715"></a>tau_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb24-716"><a href="#cb24-716"></a>  <span class="at">S =</span> <span class="fu">array</span>(s_mat),</span>
<span id="cb24-717"><a href="#cb24-717"></a>  <span class="at">I =</span> <span class="fu">array</span>(i_mat),</span>
<span id="cb24-718"><a href="#cb24-718"></a>  <span class="at">R =</span> <span class="fu">array</span>(r_mat),</span>
<span id="cb24-719"><a href="#cb24-719"></a>  <span class="at">N =</span> <span class="fu">array</span>(n_mat),</span>
<span id="cb24-720"><a href="#cb24-720"></a>  <span class="at">cases =</span> <span class="fu">array</span>(new_cases),</span>
<span id="cb24-721"><a href="#cb24-721"></a>  <span class="at">time =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>max_time, sims),</span>
<span id="cb24-722"><a href="#cb24-722"></a>  <span class="at">iteration =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>sims, <span class="at">each =</span> max_time)</span>
<span id="cb24-723"><a href="#cb24-723"></a>)</span>
<span id="cb24-724"><a href="#cb24-724"></a></span>
<span id="cb24-725"><a href="#cb24-725"></a>tau_df <span class="ot">&lt;-</span> tau_df <span class="sc">%&gt;%</span></span>
<span id="cb24-726"><a href="#cb24-726"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb24-727"><a href="#cb24-727"></a>    <span class="co"># Don't pivot the time column</span></span>
<span id="cb24-728"><a href="#cb24-728"></a>    <span class="at">cols =</span> <span class="sc">-</span><span class="fu">c</span>(time, iteration),</span>
<span id="cb24-729"><a href="#cb24-729"></a>    <span class="at">names_to =</span> <span class="st">"state"</span>,</span>
<span id="cb24-730"><a href="#cb24-730"></a>    <span class="at">values_to =</span> <span class="st">"number"</span></span>
<span id="cb24-731"><a href="#cb24-731"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb24-732"><a href="#cb24-732"></a>  <span class="fu">mutate</span>(<span class="at">state =</span> <span class="fu">factor</span>(state, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"S"</span>, <span class="st">"I"</span>, <span class="st">"R"</span>, <span class="st">"N"</span>, <span class="st">"cases"</span>)))</span>
<span id="cb24-733"><a href="#cb24-733"></a></span>
<span id="cb24-734"><a href="#cb24-734"></a><span class="co"># fix this color</span></span>
<span id="cb24-735"><a href="#cb24-735"></a>sir_colors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">S =</span> <span class="st">"#1f77b4"</span>, <span class="at">I =</span> <span class="st">"#ff7f0e"</span>, <span class="at">R =</span> <span class="st">"#FF3851"</span>, <span class="at">cases =</span> <span class="st">"#2ca02c"</span>)</span>
<span id="cb24-736"><a href="#cb24-736"></a></span>
<span id="cb24-737"><a href="#cb24-737"></a>tau_df <span class="sc">%&gt;%</span></span>
<span id="cb24-738"><a href="#cb24-738"></a>  <span class="fu">mutate</span>(<span class="at">iteration =</span> <span class="fu">as.factor</span>(iteration)) <span class="sc">%&gt;%</span></span>
<span id="cb24-739"><a href="#cb24-739"></a>  <span class="fu">filter</span>(state <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"S"</span>, <span class="st">"I"</span>, <span class="st">"R"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb24-740"><a href="#cb24-740"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb24-741"><a href="#cb24-741"></a>    <span class="at">x =</span> time,</span>
<span id="cb24-742"><a href="#cb24-742"></a>    <span class="at">y =</span> number,</span>
<span id="cb24-743"><a href="#cb24-743"></a>    <span class="at">group =</span> <span class="fu">interaction</span>(iteration, state),</span>
<span id="cb24-744"><a href="#cb24-744"></a>    <span class="at">color =</span> state</span>
<span id="cb24-745"><a href="#cb24-745"></a>  )) <span class="sc">+</span></span>
<span id="cb24-746"><a href="#cb24-746"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.5</span>, <span class="at">alpha =</span> .<span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb24-747"><a href="#cb24-747"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> sir_colors) <span class="sc">+</span></span>
<span id="cb24-748"><a href="#cb24-748"></a>  <span class="fu">labs</span>(</span>
<span id="cb24-749"><a href="#cb24-749"></a>    <span class="at">x =</span> <span class="st">"Time"</span>,</span>
<span id="cb24-750"><a href="#cb24-750"></a>    <span class="at">y =</span> <span class="st">"Number"</span>,</span>
<span id="cb24-751"><a href="#cb24-751"></a>    <span class="at">color =</span> <span class="st">"State"</span></span>
<span id="cb24-752"><a href="#cb24-752"></a>  ) <span class="sc">+</span></span>
<span id="cb24-753"><a href="#cb24-753"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">alpha =</span> <span class="dv">1</span>))) <span class="sc">+</span></span>
<span id="cb24-754"><a href="#cb24-754"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span>
<span id="cb24-755"><a href="#cb24-755"></a><span class="in">```</span></span>
<span id="cb24-756"><a href="#cb24-756"></a></span>
<span id="cb24-757"><a href="#cb24-757"></a>And plotting the simulated trajectories should look pretty close to what we got with Gillespie.</span>
<span id="cb24-758"><a href="#cb24-758"></a>But, because we can simulate many more iterations, we can start to observe some of the rarer behavior; e.g. even for simulations with $R_0 = 3.5$ there are some simulation runs for which the epidemic doesn't take off (S stays at 1000).</span>
<span id="cb24-759"><a href="#cb24-759"></a></span>
<span id="cb24-760"><a href="#cb24-760"></a>Note that because we have stored the newly infected individuals as "new cases" then we can plot both the incidence (new cases) and prevalence (I) each day.</span>
<span id="cb24-761"><a href="#cb24-761"></a></span>
<span id="cb24-764"><a href="#cb24-764"></a><span class="in">```{r}</span></span>
<span id="cb24-765"><a href="#cb24-765"></a><span class="co">#| out-width: 100%</span></span>
<span id="cb24-766"><a href="#cb24-766"></a><span class="co">#| column: body</span></span>
<span id="cb24-767"><a href="#cb24-767"></a><span class="do">####################################################################</span></span>
<span id="cb24-768"><a href="#cb24-768"></a><span class="co"># plotting                                                         #</span></span>
<span id="cb24-769"><a href="#cb24-769"></a><span class="do">####################################################################</span></span>
<span id="cb24-770"><a href="#cb24-770"></a><span class="co"># put output in a data frame</span></span>
<span id="cb24-771"><a href="#cb24-771"></a>tau_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb24-772"><a href="#cb24-772"></a>  <span class="at">S =</span> <span class="fu">array</span>(s_mat),</span>
<span id="cb24-773"><a href="#cb24-773"></a>  <span class="at">I =</span> <span class="fu">array</span>(i_mat),</span>
<span id="cb24-774"><a href="#cb24-774"></a>  <span class="at">R =</span> <span class="fu">array</span>(r_mat),</span>
<span id="cb24-775"><a href="#cb24-775"></a>  <span class="at">N =</span> <span class="fu">array</span>(n_mat),</span>
<span id="cb24-776"><a href="#cb24-776"></a>  <span class="at">cases =</span> <span class="fu">array</span>(new_cases),</span>
<span id="cb24-777"><a href="#cb24-777"></a>  <span class="at">time =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>max_time, sims),</span>
<span id="cb24-778"><a href="#cb24-778"></a>  <span class="at">iteration =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>sims, <span class="at">each =</span> max_time)</span>
<span id="cb24-779"><a href="#cb24-779"></a>)</span>
<span id="cb24-780"><a href="#cb24-780"></a></span>
<span id="cb24-781"><a href="#cb24-781"></a>tau_df <span class="ot">&lt;-</span> tau_df <span class="sc">%&gt;%</span></span>
<span id="cb24-782"><a href="#cb24-782"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb24-783"><a href="#cb24-783"></a>    <span class="co"># Don't pivot the time column</span></span>
<span id="cb24-784"><a href="#cb24-784"></a>    <span class="at">cols =</span> <span class="sc">-</span><span class="fu">c</span>(time, iteration),</span>
<span id="cb24-785"><a href="#cb24-785"></a>    <span class="at">names_to =</span> <span class="st">"state"</span>,</span>
<span id="cb24-786"><a href="#cb24-786"></a>    <span class="at">values_to =</span> <span class="st">"number"</span></span>
<span id="cb24-787"><a href="#cb24-787"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb24-788"><a href="#cb24-788"></a>  <span class="fu">mutate</span>(<span class="at">state =</span> <span class="fu">factor</span>(state, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"S"</span>, <span class="st">"I"</span>, <span class="st">"R"</span>, <span class="st">"N"</span>, <span class="st">"cases"</span>)))</span>
<span id="cb24-789"><a href="#cb24-789"></a></span>
<span id="cb24-790"><a href="#cb24-790"></a><span class="co"># fix this color</span></span>
<span id="cb24-791"><a href="#cb24-791"></a>sir_colors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">S =</span> <span class="st">"#1f77b4"</span>, <span class="at">I =</span> <span class="st">"#ff7f0e"</span>, <span class="at">R =</span> <span class="st">"#FF3851"</span>, <span class="at">cases =</span> <span class="st">"#2ca02c"</span>)</span>
<span id="cb24-792"><a href="#cb24-792"></a></span>
<span id="cb24-793"><a href="#cb24-793"></a>tau_df <span class="sc">%&gt;%</span></span>
<span id="cb24-794"><a href="#cb24-794"></a>  <span class="fu">mutate</span>(<span class="at">iteration =</span> <span class="fu">as.factor</span>(iteration)) <span class="sc">%&gt;%</span></span>
<span id="cb24-795"><a href="#cb24-795"></a>  <span class="fu">filter</span>(state <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"I"</span>, <span class="st">"cases"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb24-796"><a href="#cb24-796"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb24-797"><a href="#cb24-797"></a>    <span class="at">x =</span> time,</span>
<span id="cb24-798"><a href="#cb24-798"></a>    <span class="at">y =</span> number,</span>
<span id="cb24-799"><a href="#cb24-799"></a>    <span class="at">group =</span> <span class="fu">interaction</span>(iteration, state),</span>
<span id="cb24-800"><a href="#cb24-800"></a>    <span class="at">color =</span> state</span>
<span id="cb24-801"><a href="#cb24-801"></a>  )) <span class="sc">+</span></span>
<span id="cb24-802"><a href="#cb24-802"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.5</span>, <span class="at">alpha =</span> .<span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb24-803"><a href="#cb24-803"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> sir_colors) <span class="sc">+</span></span>
<span id="cb24-804"><a href="#cb24-804"></a>  <span class="fu">labs</span>(</span>
<span id="cb24-805"><a href="#cb24-805"></a>    <span class="at">x =</span> <span class="st">"Time"</span>,</span>
<span id="cb24-806"><a href="#cb24-806"></a>    <span class="at">y =</span> <span class="st">"Number"</span>,</span>
<span id="cb24-807"><a href="#cb24-807"></a>    <span class="at">color =</span> <span class="st">"State"</span></span>
<span id="cb24-808"><a href="#cb24-808"></a>  ) <span class="sc">+</span></span>
<span id="cb24-809"><a href="#cb24-809"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">alpha =</span> <span class="dv">1</span>))) <span class="sc">+</span></span>
<span id="cb24-810"><a href="#cb24-810"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span>
<span id="cb24-811"><a href="#cb24-811"></a><span class="in">```</span></span>
<span id="cb24-812"><a href="#cb24-812"></a></span>
<span id="cb24-813"><a href="#cb24-813"></a>:::callout-note</span>
<span id="cb24-814"><a href="#cb24-814"></a>Recall that the time series of new incident cases is very different than the time series of prevalent cases.</span>
<span id="cb24-815"><a href="#cb24-815"></a>Recall from our earlier discussion that the former are more likely to be what we would see in clinical surveillance.</span>
<span id="cb24-816"><a href="#cb24-816"></a>The latter are what we might see if we did random testing in the population.</span>
<span id="cb24-817"><a href="#cb24-817"></a>Which one would you expect to correspond best to environmental wastewater surveillance?</span>
<span id="cb24-818"><a href="#cb24-818"></a>::::</span>
<span id="cb24-819"><a href="#cb24-819"></a></span>
<span id="cb24-820"><a href="#cb24-820"></a><span class="fu">## The Chain Binomial Algorithm</span></span>
<span id="cb24-821"><a href="#cb24-821"></a></span>
<span id="cb24-822"><a href="#cb24-822"></a>In the last section, we saw that by moving from continuous time to discrete time steps, we limit the complexity (the number of stochastic evaluations scales with time and the number of states, instead of population size and the number of states).</span>
<span id="cb24-823"><a href="#cb24-823"></a>You may have also noticed that the individual steps in the Tau Leaping algorithm can be modeled as Poisson or Binomial random variables.</span>
<span id="cb24-824"><a href="#cb24-824"></a>Combining these two gives us another common algorithm for stochastic simulation, the Chain Binomial model.</span>
<span id="cb24-825"><a href="#cb24-825"></a>Here, we simplify further and use a time step that is equal to the infectious generation period; e.g. 2 weeks for measles, or 1 week for flu.</span>
<span id="cb24-826"><a href="#cb24-826"></a>If we assume that time progresses in discrete, non-overlapping generations, then those that get infected at the start of one time step, recover at the end of that time step.</span>
<span id="cb24-827"><a href="#cb24-827"></a>This simplification means that we only have to model the infection process as stochastic, and the recovery process at the end of the time step is now deterministic.</span>
<span id="cb24-828"><a href="#cb24-828"></a>This is obviously unrealistic, but makes the model much simpler for formal statistical model fitting using likelihood and Bayesian methods.</span>
<span id="cb24-829"><a href="#cb24-829"></a>So while it is imperfect, it remains as a common method for "first-pass" analyses.</span>
<span id="cb24-830"><a href="#cb24-830"></a></span>
<span id="cb24-831"><a href="#cb24-831"></a>As before, we start with initial conditions.</span>
<span id="cb24-832"><a href="#cb24-832"></a>Here we initialize with the same population as before, but notice that the transmission rate, $\beta$ is different.</span>
<span id="cb24-833"><a href="#cb24-833"></a>Time is rescaled here to units of epidemic generation time, so $\beta$ is scaled correspondingly and now, for this formulation, $\beta$ is $R_0$.</span>
<span id="cb24-834"><a href="#cb24-834"></a></span>
<span id="cb24-835"><a href="#cb24-835"></a>::: callout-note</span>
<span id="cb24-836"><a href="#cb24-836"></a>Recall that the basic reproduction number, $R_0$ is a function of the pathogen and the population of interest.</span>
<span id="cb24-837"><a href="#cb24-837"></a>In models, both the population (e.g. mixing, heterogeneity, etc) and the pathogen (e.g. time-scale of recovery) are represented using approximations to the biology.</span>
<span id="cb24-838"><a href="#cb24-838"></a>Here, the choice of model forces a change in time-scale which means that we have to change $\beta$ accordingly; thus, $\beta$, which is ostensibly a biological parameter is also a property of the model.</span>
<span id="cb24-839"><a href="#cb24-839"></a>:::</span>
<span id="cb24-840"><a href="#cb24-840"></a></span>
<span id="cb24-843"><a href="#cb24-843"></a><span class="in">```{r}</span></span>
<span id="cb24-844"><a href="#cb24-844"></a><span class="do">####################################################################</span></span>
<span id="cb24-845"><a href="#cb24-845"></a><span class="co"># Parameters and initial conditions                                #</span></span>
<span id="cb24-846"><a href="#cb24-846"></a><span class="do">####################################################################</span></span>
<span id="cb24-847"><a href="#cb24-847"></a>S <span class="ot">&lt;-</span> <span class="dv">998</span> <span class="co"># number susceptible</span></span>
<span id="cb24-848"><a href="#cb24-848"></a>I <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co"># number infected</span></span>
<span id="cb24-849"><a href="#cb24-849"></a>R <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co"># number recovered</span></span>
<span id="cb24-850"><a href="#cb24-850"></a>time <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb24-851"><a href="#cb24-851"></a></span>
<span id="cb24-852"><a href="#cb24-852"></a>beta <span class="ot">&lt;-</span> <span class="fl">3.5</span> <span class="co"># transmission rate -- note the change in value</span></span>
<span id="cb24-853"><a href="#cb24-853"></a><span class="in">```</span></span>
<span id="cb24-854"><a href="#cb24-854"></a></span>
<span id="cb24-855"><a href="#cb24-855"></a>When we implement the forward simulation, we now only have to generate random draws for the infection process, which again simplifies the amount of stochastic simulation we have to do, and speeds up run times.</span>
<span id="cb24-856"><a href="#cb24-856"></a>While this might not be limiting in the scale of this activity, this DOES become an issue when we have to fit stochastic models.</span>
<span id="cb24-857"><a href="#cb24-857"></a>Recall from the lecture on parameter estimation that the basic recipe has us build a model and test out all, or many, values of the parameters (here $\beta$) to find which one is closest to the data.</span>
<span id="cb24-858"><a href="#cb24-858"></a>Here, because each run of the stochastic simulation is different, we need to run simulations over many possible parameters, and for each parameter, we need to run many stochastic runs to characterize the average, or most likely, behavior.</span>
<span id="cb24-859"><a href="#cb24-859"></a>So, the number of simulations can rapidly increase into the millions (bigger for models with more parameters), so every bit of savings in computational time can be valuable.</span>
<span id="cb24-860"><a href="#cb24-860"></a></span>
<span id="cb24-861"><a href="#cb24-861"></a></span>
<span id="cb24-864"><a href="#cb24-864"></a><span class="in">```{r}</span></span>
<span id="cb24-865"><a href="#cb24-865"></a><span class="do">####################################################################</span></span>
<span id="cb24-866"><a href="#cb24-866"></a><span class="co"># Single time step                                                 #</span></span>
<span id="cb24-867"><a href="#cb24-867"></a><span class="do">####################################################################</span></span>
<span id="cb24-868"><a href="#cb24-868"></a>chain_binomial_step <span class="ot">&lt;-</span> <span class="cf">function</span>(sims, S, I, R, beta, ...) {</span>
<span id="cb24-869"><a href="#cb24-869"></a>  <span class="co"># S = initial susceptible population</span></span>
<span id="cb24-870"><a href="#cb24-870"></a>  <span class="co"># I = initial infected population</span></span>
<span id="cb24-871"><a href="#cb24-871"></a>  <span class="co"># R = initial recovered population</span></span>
<span id="cb24-872"><a href="#cb24-872"></a>  <span class="co"># beta is transmission rate</span></span>
<span id="cb24-873"><a href="#cb24-873"></a></span>
<span id="cb24-874"><a href="#cb24-874"></a>  <span class="co"># total population size</span></span>
<span id="cb24-875"><a href="#cb24-875"></a>  N <span class="ot">&lt;-</span> S <span class="sc">+</span> I <span class="sc">+</span> R</span>
<span id="cb24-876"><a href="#cb24-876"></a>  <span class="co"># this is the only stochastic step; only do draw if I &gt;0</span></span>
<span id="cb24-877"><a href="#cb24-877"></a>  new_i <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="at">n =</span> sims, <span class="fu">pmax</span>(S, <span class="dv">0</span>), <span class="dv">1</span> <span class="sc">-</span> <span class="fu">exp</span>(<span class="sc">-</span>beta <span class="sc">*</span> <span class="fu">pmax</span>(I, <span class="dv">0</span>) <span class="sc">/</span> N))</span>
<span id="cb24-878"><a href="#cb24-878"></a>  <span class="co"># this step is now deterministic, because everyone from the past time</span></span>
<span id="cb24-879"><a href="#cb24-879"></a>  <span class="co"># step recovers</span></span>
<span id="cb24-880"><a href="#cb24-880"></a>  new_s <span class="ot">&lt;-</span> S <span class="sc">-</span> new_i</span>
<span id="cb24-881"><a href="#cb24-881"></a>  new_r <span class="ot">&lt;-</span> R <span class="sc">+</span> I</span>
<span id="cb24-882"><a href="#cb24-882"></a></span>
<span id="cb24-883"><a href="#cb24-883"></a>  <span class="fu">cbind</span>(new_s, new_i, new_r)</span>
<span id="cb24-884"><a href="#cb24-884"></a>}</span>
<span id="cb24-885"><a href="#cb24-885"></a><span class="in">```</span></span>
<span id="cb24-886"><a href="#cb24-886"></a></span>
<span id="cb24-887"><a href="#cb24-887"></a>Then we can run the simulation over a set of discrete time steps, T.</span>
<span id="cb24-888"><a href="#cb24-888"></a>Note again that T is now the number of infectious generation times, since time is rescaled relative to the models above.</span>
<span id="cb24-889"><a href="#cb24-889"></a></span>
<span id="cb24-892"><a href="#cb24-892"></a><span class="in">```{r}</span></span>
<span id="cb24-893"><a href="#cb24-893"></a><span class="do">####################################################################</span></span>
<span id="cb24-894"><a href="#cb24-894"></a><span class="co"># Run over many steps                                              #</span></span>
<span id="cb24-895"><a href="#cb24-895"></a><span class="do">####################################################################</span></span>
<span id="cb24-896"><a href="#cb24-896"></a></span>
<span id="cb24-897"><a href="#cb24-897"></a>max_time <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb24-898"><a href="#cb24-898"></a><span class="co"># note here that the time step is one infectious generation time,</span></span>
<span id="cb24-899"><a href="#cb24-899"></a><span class="co"># so 7 days from gamma above</span></span>
<span id="cb24-900"><a href="#cb24-900"></a>sims <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb24-901"><a href="#cb24-901"></a></span>
<span id="cb24-902"><a href="#cb24-902"></a>s_mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(S, <span class="dv">1</span>, sims) <span class="co"># storage item for S for all simulations</span></span>
<span id="cb24-903"><a href="#cb24-903"></a>i_mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(I, <span class="dv">1</span>, sims) <span class="co"># storage item for I for all simulations</span></span>
<span id="cb24-904"><a href="#cb24-904"></a>r_mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(R, <span class="dv">1</span>, sims) <span class="co"># storage item for R for all simulations</span></span>
<span id="cb24-905"><a href="#cb24-905"></a>n_mat <span class="ot">&lt;-</span> S <span class="sc">+</span> I <span class="sc">+</span> R</span>
<span id="cb24-906"><a href="#cb24-906"></a></span>
<span id="cb24-907"><a href="#cb24-907"></a><span class="cf">for</span> (time_step <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>max_time) {</span>
<span id="cb24-908"><a href="#cb24-908"></a>  out <span class="ot">&lt;-</span> <span class="fu">chain_binomial_step</span>(</span>
<span id="cb24-909"><a href="#cb24-909"></a>    sims,</span>
<span id="cb24-910"><a href="#cb24-910"></a>    s_mat[time_step <span class="sc">-</span> <span class="dv">1</span>, ],</span>
<span id="cb24-911"><a href="#cb24-911"></a>    i_mat[time_step <span class="sc">-</span> <span class="dv">1</span>, ],</span>
<span id="cb24-912"><a href="#cb24-912"></a>    r_mat[time_step <span class="sc">-</span> <span class="dv">1</span>, ],</span>
<span id="cb24-913"><a href="#cb24-913"></a>    beta</span>
<span id="cb24-914"><a href="#cb24-914"></a>  )</span>
<span id="cb24-915"><a href="#cb24-915"></a>  <span class="co"># update state</span></span>
<span id="cb24-916"><a href="#cb24-916"></a>  s_mat <span class="ot">&lt;-</span> <span class="fu">rbind</span>(s_mat, out[, <span class="dv">1</span>])</span>
<span id="cb24-917"><a href="#cb24-917"></a>  <span class="co"># update state</span></span>
<span id="cb24-918"><a href="#cb24-918"></a>  i_mat <span class="ot">&lt;-</span> <span class="fu">rbind</span>(i_mat, out[, <span class="dv">2</span>])</span>
<span id="cb24-919"><a href="#cb24-919"></a>  <span class="co"># update state</span></span>
<span id="cb24-920"><a href="#cb24-920"></a>  r_mat <span class="ot">&lt;-</span> <span class="fu">rbind</span>(r_mat, out[, <span class="dv">3</span>])</span>
<span id="cb24-921"><a href="#cb24-921"></a>  <span class="co"># update state -- note population size isn't changing, but this could be</span></span>
<span id="cb24-922"><a href="#cb24-922"></a>  <span class="co"># updated with births/deaths</span></span>
<span id="cb24-923"><a href="#cb24-923"></a>  n_mat <span class="ot">&lt;-</span> <span class="fu">rbind</span>(n_mat, out[, <span class="dv">1</span>] <span class="sc">+</span> out[, <span class="dv">2</span>] <span class="sc">+</span> out[, <span class="dv">3</span>])</span>
<span id="cb24-924"><a href="#cb24-924"></a>}</span>
<span id="cb24-925"><a href="#cb24-925"></a><span class="in">```</span></span>
<span id="cb24-926"><a href="#cb24-926"></a></span>
<span id="cb24-927"><a href="#cb24-927"></a>We can plot, but note again, that this is plotted in terms of epidemic generations on the X-axis, rather than days (as in the previous sections).</span>
<span id="cb24-928"><a href="#cb24-928"></a></span>
<span id="cb24-931"><a href="#cb24-931"></a><span class="in">```{r}</span></span>
<span id="cb24-932"><a href="#cb24-932"></a><span class="co">#| echo: true</span></span>
<span id="cb24-933"><a href="#cb24-933"></a><span class="co">#| message: false</span></span>
<span id="cb24-934"><a href="#cb24-934"></a><span class="co">#| out-width: 100%</span></span>
<span id="cb24-935"><a href="#cb24-935"></a><span class="co">#| column: body</span></span>
<span id="cb24-936"><a href="#cb24-936"></a></span>
<span id="cb24-937"><a href="#cb24-937"></a><span class="co"># put output in a data frame</span></span>
<span id="cb24-938"><a href="#cb24-938"></a>bin_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb24-939"><a href="#cb24-939"></a>  <span class="at">S =</span> <span class="fu">array</span>(s_mat),</span>
<span id="cb24-940"><a href="#cb24-940"></a>  <span class="at">I =</span> <span class="fu">array</span>(i_mat),</span>
<span id="cb24-941"><a href="#cb24-941"></a>  <span class="at">R =</span> <span class="fu">array</span>(r_mat),</span>
<span id="cb24-942"><a href="#cb24-942"></a>  <span class="at">N =</span> <span class="fu">array</span>(<span class="fu">matrix</span>(n_mat)),</span>
<span id="cb24-943"><a href="#cb24-943"></a>  <span class="at">time =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>max_time, sims),</span>
<span id="cb24-944"><a href="#cb24-944"></a>  <span class="at">iteration =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>sims, <span class="at">each =</span> max_time)</span>
<span id="cb24-945"><a href="#cb24-945"></a>)</span>
<span id="cb24-946"><a href="#cb24-946"></a></span>
<span id="cb24-947"><a href="#cb24-947"></a>bin_df <span class="ot">&lt;-</span> bin_df <span class="sc">%&gt;%</span></span>
<span id="cb24-948"><a href="#cb24-948"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb24-949"><a href="#cb24-949"></a>    <span class="co"># Don't pivot the time column</span></span>
<span id="cb24-950"><a href="#cb24-950"></a>    <span class="at">cols =</span> <span class="sc">-</span><span class="fu">c</span>(time, iteration),</span>
<span id="cb24-951"><a href="#cb24-951"></a>    <span class="at">names_to =</span> <span class="st">"state"</span>,</span>
<span id="cb24-952"><a href="#cb24-952"></a>    <span class="at">values_to =</span> <span class="st">"number"</span></span>
<span id="cb24-953"><a href="#cb24-953"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb24-954"><a href="#cb24-954"></a>  <span class="fu">mutate</span>(<span class="at">state =</span> <span class="fu">factor</span>(state, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"S"</span>, <span class="st">"I"</span>, <span class="st">"R"</span>, <span class="st">"N"</span>)))</span>
<span id="cb24-955"><a href="#cb24-955"></a></span>
<span id="cb24-956"><a href="#cb24-956"></a><span class="co"># fix this color</span></span>
<span id="cb24-957"><a href="#cb24-957"></a>sir_colors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">S =</span> <span class="st">"#1f77b4"</span>, <span class="at">I =</span> <span class="st">"#ff7f0e"</span>, <span class="at">R =</span> <span class="st">"#FF3851"</span>)</span>
<span id="cb24-958"><a href="#cb24-958"></a></span>
<span id="cb24-959"><a href="#cb24-959"></a>bin_df <span class="sc">%&gt;%</span></span>
<span id="cb24-960"><a href="#cb24-960"></a>  <span class="fu">mutate</span>(<span class="at">iteration =</span> <span class="fu">as.factor</span>(iteration)) <span class="sc">%&gt;%</span></span>
<span id="cb24-961"><a href="#cb24-961"></a>  <span class="fu">filter</span>(state <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"S"</span>, <span class="st">"I"</span>, <span class="st">"R"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb24-962"><a href="#cb24-962"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb24-963"><a href="#cb24-963"></a>    <span class="at">x =</span> time,</span>
<span id="cb24-964"><a href="#cb24-964"></a>    <span class="at">y =</span> number,</span>
<span id="cb24-965"><a href="#cb24-965"></a>    <span class="at">group =</span> <span class="fu">interaction</span>(iteration, state),</span>
<span id="cb24-966"><a href="#cb24-966"></a>    <span class="at">color =</span> state</span>
<span id="cb24-967"><a href="#cb24-967"></a>  )) <span class="sc">+</span></span>
<span id="cb24-968"><a href="#cb24-968"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.5</span>, <span class="at">alpha =</span> .<span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb24-969"><a href="#cb24-969"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> sir_colors) <span class="sc">+</span></span>
<span id="cb24-970"><a href="#cb24-970"></a>  <span class="fu">labs</span>(</span>
<span id="cb24-971"><a href="#cb24-971"></a>    <span class="at">x =</span> <span class="st">"Time"</span>,</span>
<span id="cb24-972"><a href="#cb24-972"></a>    <span class="at">y =</span> <span class="st">"Number"</span>,</span>
<span id="cb24-973"><a href="#cb24-973"></a>    <span class="at">color =</span> <span class="st">"State"</span></span>
<span id="cb24-974"><a href="#cb24-974"></a>  ) <span class="sc">+</span></span>
<span id="cb24-975"><a href="#cb24-975"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">alpha =</span> <span class="dv">1</span>))) <span class="sc">+</span></span>
<span id="cb24-976"><a href="#cb24-976"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span>
<span id="cb24-977"><a href="#cb24-977"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/arnold-c/SISMID-Module-02_2025/edit/main/r-session-04.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></div></div></footer><script src="site_libs/quarto-contrib/line-highlight-1.0.0/line-highlight.js" defer="true"></script>
</body></html>