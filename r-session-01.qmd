---
format:
  html:
    page-layout: full
execute:
    echo: false
---

# R Session 01 

```{ojs}
//| panel: input
viewof beta = Inputs.range(
  [0.0, 2.0],
  {value: 0.3, step: 0.01, label: "Transmission rate"}
)
viewof dur_inf = Inputs.range(
  [0.0, 20],
  {value: 6.0, step: 0.5, label: "Duration of Infection (days)"}
)

viewof I0 = Inputs.range(
  [0.0, 1.0],
  {value: 0.01, step: 0.01, label: "Initial fraction infected"}
)

viewof area = Inputs.toggle(
  {label: "Cumulative Area plot", value: false}
)
```

```{ojs}
function sir(dydt, y, t) {
  var gamma = 1 / dur_inf

  dydt[0] = -beta * y[0] * y[1]
  dydt[1] = beta * y[0] * y[1] - gamma * y[1]
  dydt[2] = gamma * y[1]
}
```

```{ojs}
import {odeRK4} from '@rreusser/integration@3064'
import { aq, op } from '@uwdata/arquero'
```

```{ojs}
function simulate(f, t0, y0, dt, tmax) {
  var t = t0
  var y = y0
  var i = 0

  var tsim = [t0]
  var ysim = [y0]

  for (t = t0 + dt; t <= tmax; t += dt) {
    ysim.push(odeRK4([], ysim[i], f, dt))
    tsim.push(t)
    i += 1
  }
  
  return aq.table({
    t: tsim,
    S: ysim.map(d => d[0]),
    I: ysim.map(d => d[1]),
    R: ysim.map(d => d[2])
    })
}
```

```{ojs}
sir_sol = simulate(sir, 0, [1.0-I0, I0, 0.0], 0.01, 200)
sir_sol_long = sir_sol.fold(aq.not('t'), {as: ['State', 'Fraction']})
```

```{ojs}
SIRcolors = ["#1f77b4", "#ff7f0e", "#FF3851"]
```

::: {.panel-tabset}

## Closed Population

```{ojs}
closed_R0 = beta * dur_inf
closed_R0_str = closed_R0.toLocaleString(undefined, {minimumFractionDigits: 2})

finalsize = sir_sol.get("R", sir_sol.numRows()-1)
finalsize_str = finalsize.toLocaleString(undefined, {minimumFractionDigits: 2})

md`${tex`R_0 = ${closed_R0_str}`}`
md`${tex`\text{Final size} = ${finalsize_str}`}`
```

```{ojs}
Plot.plot({
  color: {
    legend: true,
    domain: ["S", "I", "R"],
    range: SIRcolors
  },
  style: {fontSize: "20px"},
  marginLeft: 65,
  marginTop: 40,
  grid: true,
  width: 1000,
  height: 600,
  y: {domain: [0, 1]},
  marks: [
    area ?
      Plot.areaY(sir_sol_long, {x: "t", y: "Fraction", fill: "State"}) :
      Plot.lineY(sir_sol_long, {x: "t", y: "Fraction", stroke: "State", strokeWidth: 6})
  ]
})
```

## Demographics

```{ojs}
//| panel: input
viewof births = Inputs.range(
  [0.0, 0.5],
  {value: 0.05, step: 0.001, label: "Birth rate"}
)

viewof tmax = Inputs.range(
  [200.0, 500.0],
  {value: 200.0, step: 50.0, label: "Maximum simulation time"}
)
```

```{ojs}
demographic_R0 = beta / ((1/dur_inf) + births)
eq_S = 1 / demographic_R0
eq_I = births / beta * (demographic_R0 - 1)
eq_R = 1 - (eq_S + eq_I)

eq_vals = aq.table({
  State: ["S", "I", "R"],
  Fraction: [eq_S, eq_I, eq_R]
})

demographic_R0_str = demographic_R0.toLocaleString(undefined, {minimumFractionDigits: 2})

md`${tex`R_0 = ${demographic_R0_str}`}`
```

```{ojs}
function sir_demographic(dydt, y, t) {
  var gamma = 1 / dur_inf

  dydt[0] = - beta * y[0] * y[1] + births * (1 - y[0])
  dydt[1] = beta * y[0] * y[1] - gamma * y[1] - births * y[1]
  dydt[2] = gamma * y[1] - births * y[2]
}
```

```{ojs}
sir_demographic_sol = simulate(sir_demographic, 0, [1.0-I0, I0, 0.0], 0.01, tmax)
sir_demographic_sol_long = sir_demographic_sol.fold(aq.not('t'), {as: ['State', 'Fraction']})
```

```{ojs}
Plot.plot({
  color: {
    legend: true,
    domain: ["S", "I", "R"],
    range: SIRcolors
  },
  style: {fontSize: "20px"},
  marginLeft: 65,
  marginTop: 40,
  grid: true,
  width: 1000,
  height: 600,
  y: {domain: [0, 1]},
  marks: [
    area ?
      Plot.areaY(sir_demographic_sol_long, {x: "t", y: "Fraction", fill: "State"}) :
      [
        demographic_R0 >= 1.0 ?
          Plot.ruleY(
            eq_vals,
            {y: "Fraction", stroke: "State", strokeWidth: 2, strokeDasharray: [10]}
          ) :
          null,
        Plot.lineY(
          sir_demographic_sol_long,
          {x: "t", y: "Fraction", stroke: "State", strokeWidth: 6}
        )
      ]
  ]
})
```

:::

## Questions
### Developing intuition in a closed population

To begin with, let's consider a closed population (no births or deaths), and a low initial fraction infected.
The initial values are set so that $R_0 = 1.8$, with a duration of infection of 6 days (roughly similar to circulating influenza).

#### What happens if we increase the transmission rate?

Play around with the slider for the transmission rate.

##### What happens to the epidemic curve?
##### What happens to the peak fraction infected?
##### What happens to the total fraction infected?
##### What happens to the duration of the epidemic?
##### What happens to the final size (equilibrium) of the epidemic?


### Exploring the effect of births and deaths

Now let's consider a population with births and deaths.
Move "Demographics" panel above.

#### What happens if we increase the birth rate (above 0)?

##### What happens to $R_0$?
##### What happens to the epidemic curve?
##### What happens to the peak fraction infected?
##### What happens to the total fraction infected?
##### What happens to the duration of the epidemic?
##### What happens to the final size (equilibrium) of the epidemic?

::: {.callout-tip}
You may want to increase the maximum simulation time.
:::

When $R_0 < 1$, equilibrium lines are not calculated. Why?


### Effects of interventions
#### Intervention effects transmission

##### Based on your intuition from the previous questions, what do you think will happen if we enact an intervention that reduces transmission by 50%?
##### How could we incorporate this into the model?
##### What are the core assumptions being made in this model, and how might they affect the results?

#### Intervention effects duration of infection

We could imagine that an intervention could also reduce the duration of infection, say, for example, Tamiflu for influenza.

##### Based on your intuition from the previous questions, what do you think will happen if we enact an intervention that reduces the duration of infection by 50%?
##### How could we incorporate this into the model?
##### What are the core assumptions being made in this model, and how might they affect the results?

#### Intervention effects proportion of population susceptible

We could imagine that an intervention could also reduce the proportion of the population susceptible, say, for example, a vaccine.

##### Based on your intuition from the previous questions, what do you think will happen if we enact an intervention that reduces the proportion of the population susceptible by 50%?
##### How could we incorporate this into the model?
##### What are the core assumptions being made in this model, and how might they affect the results?
